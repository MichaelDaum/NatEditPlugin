"use strict";!function(e){function t(){var e=this;e.cursor=null,e.overlay=null,e.annotate=null,e.query=null,e.found=!1}function o(t,r){var n=this;n.shell=n.parent.shell=t,n.searchState=void 0,n.opts=e.extend({},o.defaults,n.shell.opts.codemirror,r)}o.prototype=Object.create(BaseEngine.prototype),o.prototype.constructor=o,o.prototype.parent=BaseEngine.prototype,o.prototype.init=function(){var t=this,o=foswiki.getPreference("PUBURLPATH")+"/"+foswiki.getPreference("SYSTEMWEB")+"/CodeMirrorContrib",r=e.Deferred();return e("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet"}).attr("href",o+"/lib/codemirror.css"),e("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet"}).attr("href",o+"/theme/foswiki.css"),e("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet"}).attr("href",o+"/addon/search/matchesonscrollbar.css"),e("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet"}).attr("href",o+"/addon/dialog/dialog.css"),t.shell.getScript(o+"/lib/codemirror.js").done((function(){CodeMirror.modeURL=o+"//mode/%N/%N.js",e.when(t.parent.init(),t.shell.getScript(o+"/addon/mode/loadmode.js"),t.shell.getScript(o+"/addon/fold/foldcode.js"),t.shell.getScript(o+"/addon/fold/foldgutter.js"),t.shell.getScript(o+"/addon/search/searchcursor.js"),t.shell.getScript(o+"/addon/scroll/annotatescrollbar.js"),t.shell.getScript(o+"/addon/search/matchesonscrollbar.js"),t.shell.getScript(o+"/addon/edit/matchbrackets.js"),t.shell.getScript(o+"/addon/dialog/dialog.js"),t.shell.getScript(o+"/keymap/vim.js"),t.shell.preloadTemplate("editdialog","searchdialog")).done((function(){CodeMirror.commands.save=function(){t.shell.save()},CodeMirror.Vim.defineEx("x",void 0,(function(){t.shell.exit()})),CodeMirror.Vim.defineEx("xa",void 0,(function(){t.shell.exit()})),CodeMirror.Vim.defineEx("qa",void 0,(function(){t.shell.cancel()})),CodeMirror.Vim.defineEx("q",void 0,(function(){t.shell.cancel()})),CodeMirror.requireMode(t.opts.mode||"foswiki",(function(){var o=t.shell.txtarea.attr("cols"),n=t.shell.txtarea.attr("rows"),i=parseInt(t.shell.txtarea.css("line-height"),10);t.cm=CodeMirror.fromTextArea(t.shell.txtarea[0],t.opts),void 0!==o&&o>0&&t.cm.setSize(o+"ch"),void 0!==n&&n>0&&(n=n*i+"px",t.cm.setSize(null,n)),t.on("focus",(function(){void 0!==t.shell.onFocus&&t.shell.onFocus()}));var s=e.extend(!0,{},t.cm.getOption("extraKeys"),{"Ctrl-F":function(){t.openSearchDialog()},"Ctrl-G":function(){t.search()},F3:function(){t.search()}});t.cm.setOption("extraKeys",s),t.cm.on("keyup",(function(e,o){t.shell.handleKeyUp(o),"Escape"===o.key&&t.manageWidgets()})),t.cm.on("keydown",(function(e,o){t.shell.handleKeyDown(o)})),t.on("change",_debounce((function(e){t.manageWidgets()}),500)),t.manageWidgets(),r.resolve(t)}))}))})),e(window).on("resize",(function(){void 0!==t.cm&&t.cm.refresh()})),r.promise()},o.prototype.beforeSubmit=function(){return this.cm.save(),e.Deferred().resolve().promise()},o.prototype.on=function(e,t){return this.cm.on(e,t),this.cm},o.prototype.manageWidgets=function(){EmojiWidget.createWidgets(this),LinkWidget.createWidgets(this)},o.prototype.remove=function(){return this.cm.replaceSelection("")},o.prototype.setCursor=function(e){this.cm.getDoc().setCursor(e)},o.prototype.getCursor=function(){return this.cm.getCursor()},o.prototype.getCursorCoords=function(e){var t=this.cm.getCursor();return this.cm.charCoords({line:t.line,ch:t.ch+e})},o.prototype.getBeforeCursor=function(e){var t=this.cm.getCursor(),o=this.cm.getLine(t.line),r=t.ch+(e?1:0);return o.slice(0,r)},o.prototype.getAfterCursor=function(e){var t=this.cm.getCursor(),o=this.cm.getLine(t.line),r=t.ch+(e?0:1);return o.slice(r)},o.prototype.getWord=function(){var e=this,t=e.cm.getCursor(),o=e.cm.findWordAt(t);return e.cm.getRange(o.anchor,o.head)},o.prototype.getSelectionLines=function(){var e=this.cm.getDoc(),t=e.getCursor("from"),o=e.getCursor("to");return t.ch=0,t=e.posFromIndex(e.indexFromPos(t)),o.line++,o.ch=0,o=e.posFromIndex(e.indexFromPos(o)-1),e.setSelection(t,o),e.getSelection()},o.prototype.getSelection=function(){return this.cm.getSelection()},o.prototype.getSelectionRange=function(){return this.cm.getDoc().getSelection()},o.prototype.hasChanged=function(){return!this.cm.getDoc().isClean()},o.prototype.undo=function(){return this.cm.undo()},o.prototype.redo=function(){return this.cm.redo()},o.prototype.replace=function(e,t,o){this.cm.getDoc().replaceRange(e,t,o)},o.prototype.insert=function(e){var t=this.cm.getDoc(),o=t.getCursor();t.replaceRange(e,o)},o.prototype.insertLineTag=function(e){var t,o,r,n,i,s,c,a=this,l=e[0],h=e[1],p=e[2],d=a.cm.getDoc(),u=new RegExp(/^(( {3})*)( {3})(\* |\d+ |\d+\. )/),g=0,m=[];for(c=(t=a.getSelectionLines()||h).split(/\r?\n/),n=0;n<c.length;n++)(s=c[n]).match(/^\s*$/)?i=s:""===l&&""===h&&""===p?i=s.replace(/^ {3}(\* |\d+ |\d+\. )?/,""):!u.test(s)||"   1 "!==l&&"   * "!==l?i=l+s+p:(g=RegExp.$1.length,i=s.replace(u,"$1"+l)+p),m.push(i);t=m.join("\n"),d.replaceSelection(t,"start"),1===c.length?(o=d.posFromIndex(g+l.length+d.indexFromPos(d.getCursor())),r=d.posFromIndex(d.indexFromPos(d.getCursor())+t.length)):(o=d.posFromIndex(g+d.indexFromPos(d.getCursor())),r=d.posFromIndex(d.indexFromPos(d.getCursor())+t.length)),d.setSelection(o,r),a.cm.focus()},o.prototype.insertTag=function(e){var t,o,r,n=e[0],i=e[2],s=this.cm.getDoc();t=this.getSelectionRange()||e[1],s.replaceSelection(n+t+i,"start"),o=s.posFromIndex(s.indexFromPos(s.getCursor())+n.length),r=s.posFromIndex(s.indexFromPos(s.getCursor())+n.length+t.length),s.setSelection(o,r)},o.prototype.getSearchState=function(){var e=this;return void 0===e.searchState&&(e.searchState=new t),e.searchState},o.prototype.clearSearchState=function(){var e=this,t=e.getSearchState();t.overlay&&e.cm.removeOverlay(t.overlay),t.annotate&&t.annotate.clear(),e.searchState=void 0},o.prototype.searchOverlay=function(e,t){var o;return o="string"==typeof e?new RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),t?"gi":"g"):e,{token:function(e){o.lastIndex=e.pos;var t=o.exec(e.string);if(t&&t.index===e.pos)return e.pos+=t[0].length||1,"searching";t?e.pos=t.index:e.skipToEnd()}}},o.prototype.openSearchDialog=function(){var t=this;t._searchDialogOpen?t.shell.log("dialog is open"):(t._searchDialogOpen=!0,t.shell.dialog({name:"searchdialog",data:{web:t.shell.opts.web,topic:t.shell.opts.topic,selection:t.getSelection()||t.getSearchState().query}}).then((function(o){var r=e(o),n=r.find("input[name='search']").val(),i=!!r.find("input[name='ignorecase']:checked").length;t._searchDialogOpen=!1,t.search(n,i)}),(function(){t._searchDialogOpen=!1,t.clearSearchState()})))},o.prototype.search=function(t,o){var r,n,i=this;void 0!==t?(n=/^\s*\/(.*)\/\s*$/.test(t)?new RegExp(RegExp.$1,o?"gi":"g"):t,i.clearSearchState(),(r=i.getSearchState()).cursor=i.cm.getSearchCursor(n,0,o),r.overlay=i.searchOverlay(n,o),r.query=n,i.cm.addOverlay(r.overlay),i.cm.showMatchesOnScrollbar&&(r.annotate&&(r.annotate.clear(),r.annotate=null),r.annotate=i.cm.showMatchesOnScrollbar(n,o))):r=i.getSearchState(),r.cursor&&(r.cursor.findNext()?(r.found=!0,i.cm.setSelection(r.cursor.from(),r.cursor.to()),i.cm.scrollIntoView({from:r.cursor.from(),to:r.cursor.to()},20)):(i.shell.showMessage("info",r.found?e.i18n("no more matches"):e.i18n("nothing found")),i.clearSearchState()))},o.prototype.searchReplace=function(e,t,o){var r,n,i;for(i=/^\s*\/(.*)\/\s*$/.test(e)?new RegExp(RegExp.$1):e,r=this.cm.getSearchCursor(i,0,o),n=0;r.findNext();n++)r.replace(t);return n},o.prototype.getWrapperElement=function(){return this.cm?e(this.cm.getWrapperElement()):null},o.prototype.focus=function(){this.cm.focus()},o.prototype.setSize=function(e,t){this.cm.setSize(e,t),this.cm.refresh()},o.prototype.getSize=function(){var e;return{width:(e=this.cm.getScrollInfo()).width,height:e.height}},o.prototype.setValue=function(e){this.cm.setValue(e)},o.prototype.getValue=function(){return this.cm.getValue()},o.defaults={mode:"foswiki",theme:"foswiki",indentUnit:3,smartIndent:!1,tabSize:3,indentWithTabs:!1,electricChars:!1,keyMap:"default",lineWrapping:!0,lineNumbers:!1,firstLineNumber:1,readOnly:!1,showCursorWhenSelecting:!1,undoDepth:40,autofocus:!1,autoresize:!1,singleCursorHeightPerLine:!1,fixedGutter:!0,foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],extraKeys:{Enter:"newlineAndIndentContinueFoswikiList",Tab:"insertSoftTab","Ctrl-Q":"toggleFold"},matchBrackets:!0},e.NatEditor.engines.CodemirrorEngine={createEngine:function(e){return new o(e).init()}}}(jQuery);
