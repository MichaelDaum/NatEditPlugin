"use strict";!function(e){function t(){var e=this;e.cursor=null,e.overlay=null,e.annotate=null,e.query=null,e.found=!1}function o(t,r){var n=this;n.shell=n.parent.shell=t,n.id="CodemirrorEngine",n.type="wikiwyg",n.searchState=void 0,n.opts=e.extend({},o.defaults,n.shell.opts.codemirror,r)}o.prototype=Object.create(BaseEngine.prototype),o.prototype.constructor=o,o.prototype.parent=BaseEngine.prototype,o.prototype.init=function(){var t=this,o=foswiki.getPreference("PUBURLPATH")+"/"+foswiki.getPreference("SYSTEMWEB")+"/NatEditPlugin/lib/codemirror",r=e.Deferred();return t.isInited?(t.shell.log("... engine already inited"),r.resolve()):(t.isInited=!0,t.shell.log("called codemirror init"),e("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet"}).attr("href",o+"/pkg.css"),t.shell.getScript(o+"/lib/codemirror.js").done((function(){CodeMirror.modeURL=o+"//mode/%N/%N.js",e.when(t.parent.init(),t.shell.getScript(o+"/pkg.js")).done((function(){CodeMirror.commands.save=function(){t.shell.formManager.save()},CodeMirror.Vim.defineEx("x",void 0,(function(){t.shell.formManager.submit()})),CodeMirror.Vim.defineOperator("wrapText",(function(e,o){t.wrapText()})),CodeMirror.Vim.mapCommand("gq","operator","wrapText",void 0,{isEdit:!0}),CodeMirror.Vim.defineEx("xa",void 0,(function(){t.shell.formManager.submit()})),CodeMirror.Vim.defineEx("qa",void 0,(function(){t.shell.formManager.cancel()})),CodeMirror.Vim.defineEx("q",void 0,(function(){t.shell.formManager.cancel()})),CodeMirror.requireMode(t.opts.mode||"foswiki",(function(){var o=parseInt(t.shell.txtarea.attr("cols"),10)||1e4,n=parseInt(t.shell.txtarea.attr("rows"),10),i=parseInt(t.shell.txtarea.css("line-height"),10);t.cm=CodeMirror.fromTextArea(t.shell.txtarea[0],t.opts),void 0===o||t.shell.txtarea[0].style.width||t.cm.setSize(`min(${o}ch,100%)`),void 0!==n&&n>0&&(n=n*i+"px",t.cm.setSize(null,n)),t.on("focus",(function(){void 0!==t.shell.onFocus&&t.shell.onFocus()}));var a=e.extend(!0,{},t.cm.getOption("extraKeys"),{"Ctrl-F":function(){t.openSearchDialog()},"Ctrl-G":function(){t.search()},F3:function(){t.search()}});t.cm.setOption("extraKeys",a),t.cm.on("keyup",(function(e,o){t.handleKeyUp(o)})),t.cm.on("keydown",(function(e,o){t.handleKeyDown(o)})),t.on("change",_debounce((function(e){t.manageWidgets()}),500)),t.manageWidgets(),r.resolve(t)}))}))})),e(window).on("resize",(function(){void 0!==t.cm&&t.cm.refresh()})),r.promise())},o.prototype.wrapText=function(){var e=this,t=_wrapText(e.getSelection()||"")+"\n";e.remove(),e.insert(t)},o.prototype.findTable=function(){var e,t,o=this,r=o.cm.getCursor(),n=r.line,i=n+1,a=o.cm.lineCount();if((t=new foswiki.TableRow(o.cm.getLine(n))).cells.length){for((e=new foswiki.Table).rows.push(t),n--;n>=0&&(t=new foswiki.TableRow(o.cm.getLine(n))).cells.length;)e.rows.unshift(t),n--;for(n++;i<a&&(t=new foswiki.TableRow(o.getLine(i))).cells.length;)e.rows.push(t),i++;return e.rawContent=o.cm.getRange({line:n,ch:0},{line:i,ch:0}),e.setPosition(r,n),e}},o.prototype.repaintTable=function(e,t){var o,r,n=this,i=CodeMirror.Pos(e.offset,0),a=n.cm.findPosH(i,e.rawContent.length,"char");return void 0===t?t=!0:r=n.getCaretPosition(),"off"!==n.opts.normalizeTables&&e.normalize("full"===n.opts.normalizeTables),o=n.cm.getRange(i,a),n.cm.replaceRange(e.toString(),i,a,o),t&&(r=e.getCursor()),r&&n.setCaretPosition(r),r},o.prototype.insertTableRow=function(){var e=this.findTable();e&&(e.insertRowAfter(),e.position.row++,e.position.col=0,this.repaintTable(e))},o.prototype.deleteTableRow=function(){var e=this.findTable();e&&(e.deleteRow(),this.repaintTable(e))},o.prototype.insertTableColumn=function(){var e=this.findTable();e&&(e.insertColumn(),this.repaintTable(e))},o.prototype.deleteTableColumn=function(){var e=this.findTable();e&&e.deleteColumn()&&this.repaintTable(e)},o.prototype.moveTableRowUp=function(){var e=this.findTable();e&&e.moveRowUp()&&(e.gotoPrevRow(),this.repaintTable(e))},o.prototype.moveTableRowDown=function(){var e=this.findTable();e&&e.moveRowDown()&&(e.gotoNextRow(),this.repaintTable(e))},o.prototype.moveTableColumnLeft=function(){var e=this.findTable();e&&e.moveColumnLeft()&&(e.gotoPrevCol(),this.repaintTable(e))},o.prototype.moveTableColumnRight=function(){var e=this.findTable();e&&e.moveColumnRight()&&(e.gotoNextCol(),this.repaintTable(e))},o.prototype.handleKeyDown=function(e){var t,o=this;if(o._searchDialogOpen)return e.preventDefault(),!1;if(("Escape"===e.key||"Tab"===e.key||"Home"===e.key||"End"===e.key||"Delete"===e.key&&e.altKey||"Enter"===e.key&&!e.shiftKey||"ArrowLeft"===e.key&&e.altKey||"ArrowRight"===e.key&&e.altKey||"ArrowUp"===e.key&&e.altKey||"ArrowDown"===e.key&&e.altKey||"N"===e.key&&e.altKey||"n"===e.key&&e.altKey)&&(t=o.findTable()),t)if("Escape"===e.key)o.repaintTable(t,0);else{if(e.altKey&&"Delete"===e.key&&!e.shiftKey)return t.deleteRow(),o.repaintTable(t),e.preventDefault(),!1;if(e.altKey&&("N"===e.key||"Delete"===e.key&&e.shiftKey))return t.deleteColumn(),o.repaintTable(t),e.preventDefault(),!1;if(e.altKey&&"n"===e.key)return t.insertColumn(),o.repaintTable(t),e.preventDefault(),!1;if(e.altKey&&"ArrowLeft"===e.key)return t.moveColumnLeft()&&(t.gotoPrevCol(),o.repaintTable(t)),e.preventDefault(),!1;if(e.altKey&&"ArrowRight"===e.key)return t.moveColumnRight()&&(t.gotoNextCol(),o.repaintTable(t)),e.preventDefault(),!1;if(e.altKey&&"ArrowUp"===e.key)return t.moveRowUp()&&(t.gotoPrevRow(),o.repaintTable(t)),e.preventDefault(),!1;if(e.altKey&&"ArrowDown"===e.key)return t.moveRowDown()&&(t.gotoNextRow(),o.repaintTable(t)),e.preventDefault(),!1;if("Home"===e.key){if(t.position.col)return t.gotoFirstCol(),o.repaintTable(t),e.preventDefault(),!1}else if("End"===e.key){if(!t.isLastCol())return t.gotoLastCol(),o.repaintTable(t),e.preventDefault(),!1}else{if("Tab"===e.key){if(e.shiftKey)t.gotoPrevCol();else{o.getCaretPosition().ch?t.gotoNextCol():t.gotoFirstCol()}return o.repaintTable(t),e.preventDefault(),!1}if(e.altKey&&"Enter"===e.key)return t.insertRowAfter(),t.position.row++,t.position.col=0,o.repaintTable(t),e.preventDefault(),!1;if(!e.altKey&&"Enter"===e.key)return t.gotoNextRow(),o.repaintTable(t),e.preventDefault(),!1}}o.shell.handleKeyDown(e)},o.prototype.handleKeyUp=function(e){"Escape"===e.key&&this.manageWidgets(),this.shell.handleKeyUp(e)},o.prototype.beforeSubmit=function(){var t=this;return t.shell.log("Codemirror::beforeSubmit"),t.shell.setTextFormat("tml"),t.cm.save(),e.Deferred().resolve().promise()},o.prototype.on=function(e,t){return this.cm.on(e,t),this.cm},o.prototype.manageWidgets=function(){"undefined"!=typeof Emojis&&EmojiWidget.createWidgets(this),LinkWidget.createWidgets(this)},o.prototype.remove=function(){return this.cm.replaceSelection("")},o.prototype.getCursorCoords=function(e){var t=this.cm.getCursor();return this.cm.charCoords({line:t.line,ch:t.ch+e})},o.prototype.setCaretPosition=function(e){this.cm.focus(),this.cm.setCursor(e)},o.prototype.getCaretPosition=function(){return this.cm.getCursor()},o.prototype.getBeforeCursor=function(e){var t=this.cm.getCursor(),o=this.cm.getLine(t.line),r=t.ch+(e?1:0);return o.slice(0,r)},o.prototype.getAfterCursor=function(e){var t=this.cm.getCursor(),o=this.cm.getLine(t.line),r=t.ch+(e?0:1);return o.slice(r)},o.prototype.getLine=function(e){return e=e||this.cm.getCursor().line,this.cm.getLine(e)},o.prototype.getWord=function(){var e=this,t=e.cm.getCursor(),o=e.cm.findWordAt(t);return e.cm.getRange(o.anchor,o.head)},o.prototype.getSelectionLines=function(){var e=this.cm.getDoc(),t=e.getCursor("from"),o=e.getCursor("to");return t.ch=0,t=e.posFromIndex(e.indexFromPos(t)),o.line++,o.ch=0,o=e.posFromIndex(e.indexFromPos(o)-1),e.setSelection(t,o),e.getSelection()},o.prototype.getSelection=function(){return this.cm.getSelection()},o.prototype.getSelectionRange=function(){return this.cm.getDoc().getSelection()},o.prototype.hasChanged=function(){return!this.cm.getDoc().isClean()},o.prototype.undo=function(){return this.cm.undo()},o.prototype.redo=function(){return this.cm.redo()},o.prototype.replace=function(e,t,o){this.cm.getDoc().replaceRange(e,t,o)},o.prototype.insert=function(e){var t=this.cm.getDoc(),o=t.getCursor();t.replaceRange(e,o)},o.prototype.insertLineTag=function(e){var t,o,r,n,i,a,s,l=this,c=e[0],p=e[1],u=e[2],h=l.cm.getDoc(),f=new RegExp(/^(( {3})*)( {3})(\* |\d+ |\d+\. )/),g=0,m=[];for(s=(t=l.getSelectionLines()||p).split(/\r?\n/),n=0;n<s.length;n++)(a=s[n]).match(/^\s*$/)?i=a:""===c&&""===p&&""===u?i=a.replace(/^ {3}(\* |\d+ |\d+\. )?/,""):!f.test(a)||"   1 "!==c&&"   * "!==c?i=c+a+u:(g=RegExp.$1.length,i=a.replace(f,"$1"+c)+u),m.push(i);t=m.join("\n"),h.replaceSelection(t,"start"),1===s.length?(o=h.posFromIndex(g+c.length+h.indexFromPos(h.getCursor())),r=h.posFromIndex(h.indexFromPos(h.getCursor())+t.length)):(o=h.posFromIndex(g+h.indexFromPos(h.getCursor())),r=h.posFromIndex(h.indexFromPos(h.getCursor())+t.length)),h.setSelection(o,r),l.cm.focus()},o.prototype.insertTag=function(e){var t,o,r,n=e[0],i=e[2],a=this.cm.getDoc();t=this.getSelectionRange()||e[1],a.replaceSelection(n+t+i,"start"),o=a.posFromIndex(a.indexFromPos(a.getCursor())+n.length),r=a.posFromIndex(a.indexFromPos(a.getCursor())+n.length+t.length),a.setSelection(o,r)},o.prototype.getSearchState=function(){var e=this;return void 0===e.searchState&&(e.searchState=new t),e.searchState},o.prototype.clearSearchState=function(){var e=this,t=e.getSearchState();t.overlay&&e.cm.removeOverlay(t.overlay),t.annotate&&t.annotate.clear(),e.searchState=void 0},o.prototype.searchOverlay=function(e,t){var o;return o="string"==typeof e?new RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),t?"gi":"g"):e,{token:function(e){o.lastIndex=e.pos;var t=o.exec(e.string);if(t&&t.index===e.pos)return e.pos+=t[0].length||1,"searching";t?e.pos=t.index:e.skipToEnd()}}},o.prototype.openSearchDialog=function(){var t=this;t._searchDialogOpen?t.shell.log("dialog is open"):(t._searchDialogOpen=!0,t.shell.dialog({name:"searchdialog",data:{web:t.shell.opts.web,topic:t.shell.opts.topic,selection:t.getSelection()||t.getSearchState().query}}).then((function(o){var r=e(o),n=r.find("input[name='search']").val(),i=!!r.find("input[name='ignorecase']:checked").length;t._searchDialogOpen=!1,t.search(n,i)}),(function(){t._searchDialogOpen=!1,t.clearSearchState()})))},o.prototype.search=function(t,o){var r,n,i=this;void 0!==t?(n=/^\s*\/(.*)\/\s*$/.test(t)?new RegExp(RegExp.$1,o?"gi":"g"):t,i.clearSearchState(),(r=i.getSearchState()).cursor=i.cm.getSearchCursor(n,0,o),r.overlay=i.searchOverlay(n,o),r.query=n,i.cm.addOverlay(r.overlay),i.cm.showMatchesOnScrollbar&&(r.annotate&&(r.annotate.clear(),r.annotate=null),r.annotate=i.cm.showMatchesOnScrollbar(n,o))):r=i.getSearchState(),r.cursor&&(r.cursor.findNext()?(r.found=!0,i.cm.setSelection(r.cursor.from(),r.cursor.to()),i.cm.scrollIntoView({from:r.cursor.from(),to:r.cursor.to()},20)):(i.shell.formManager.showMessage("info",r.found?e.i18n("no more matches"):e.i18n("nothing found")),i.clearSearchState()))},o.prototype.searchReplace=function(e,t,o){var r,n,i;for(i=/^\s*\/(.*)\/\s*$/.test(e)?new RegExp(RegExp.$1):e,r=this.cm.getSearchCursor(i,0,o),n=0;r.findNext();n++)r.replace(t);return n},o.prototype.getWrapperElement=function(){return this.cm?e(this.cm.getWrapperElement()):null},o.prototype.focus=function(){this.cm.focus()},o.prototype.setSize=function(e,t){this.cm.setSize(e,t),this.cm.refresh()},o.prototype.getSize=function(){var e;return{width:(e=this.cm.getScrollInfo()).width,height:e.height}},o.prototype.updateContent=function(){return this.setContent(this.shell.txtarea.val())},o.prototype.getContent=function(){return e.Deferred().resolve(this.getValue()).promise()},o.prototype.setContent=function(t){var o=e.Deferred();return this.setValue(t),o.resolve().promise()},o.prototype.setValue=function(e){void 0===this.cm?console.warn("called setValue while editor isn't fully loaded yet"):this.cm.setValue(e)},o.prototype.getValue=function(){return this.cm.getValue()},o.defaults={mode:"foswiki",theme:"foswiki",indentUnit:3,smartIndent:!1,tabSize:3,indentWithTabs:!1,electricChars:!1,keyMap:"default",lineWrapping:!1,lineNumbers:!1,firstLineNumber:1,readOnly:!1,showCursorWhenSelecting:!1,undoDepth:1e3,autoresize:!1,singleCursorHeightPerLine:!1,inputStyle:"contenteditable",spellcheck:!0,extraKeys:{Enter:"newlineAndIndentContinueFoswikiList",Tab:"insertSoftTab","Ctrl-Q":"toggleFold"},matchBrackets:!0,normalizeTables:"off"},e.NatEditor.factory.CodemirrorEngine={createEngine:function(e){return new o(e)}}}(jQuery);
