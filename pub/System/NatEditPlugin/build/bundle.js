"use strict";function _last(e){return e[e.length-1]}function _throttle(e,t){var i;return function(...n){clearTimeout(i),i=setTimeout((function(){clearTimeout(i),e(...n)}),t)}}function _debounce(e,t){var i=null,n=null;return function o(r){n=r,i||(e(n),n=null,i=setTimeout((function(){i=null,n&&o(n)}),t))}}function _posEqual(e,t){return e.line==t.line&&t.ch==e.ch}function _posCmp(e,t){return e.line-t.line||e.ch-t.ch}function _posInsideRange(e,t){return _posCmp(t.from,e)<0&&_posCmp(e,t.to)<0}function _posOutsideRange(e,t){return _posCmp(t.from,e)>0||_posCmp(e,t.to)>0}function _rangesOverlap(e,t){return _posCmp(e.from,t.to)<0&&_posCmp(t.from,e.to)<0}function _escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var BaseEngine;!function(e){function t(e,t,i){var n=this;n.editor=e,n.from=t,n.to=i,n.init()}function i(e,i){for(var n=e.cm.getSearchCursor(i,0,0),o=e.cm.getCursor();n.findNext();)_posInsideRange(o,n.pos)||_posEqual(o,n.pos.to)||e.cm.findMarksAt(n.pos.from).find((function(e){return void 0!==e.widget}))||new t(e,n.pos.from,n.pos.to)}t.createWidgets=function(e){i(e,Emojis.emojiRegExp),i(e,Emojis.aliasRegExp)},t.prototype.init=function(){var t=this;t.text=t.getText(),void 0===t.elem&&(t.elem=e("<img>").prop("src",Emojis.getUrl(t.getText())).addClass("emoji cm-natedit-emoji")),t.mark=t.editor.cm.markText(t.from,t.to,{replacedWith:t.elem[0],addToHistory:!1,atomic:!0,clearOnEnter:!0,clearWhenEmpty:!0,widget:t})},t.prototype.stringify=function(){return this.text},t.prototype.getText=function(){var e=this;return e.editor.cm.getRange(e.from,e.to)},t.prototype.setText=function(e){var t=this,i=e.length;t.editor.cm.replaceRange(e,t.from,t.to),t.to.ch=t.from.ch+i,t.init()},window.EmojiWidget=t}(jQuery),function(e){var t=/\[\[.*?\](\[.*?\])?\]/;function i(e,t,i){var n=this;n.editor=e,n.from=t,n.to=i,n.init()}i.createWidgets=function(e){for(var n=e.cm.getSearchCursor(t,0,0),o=e.cm.getCursor();n.findNext();)_posInsideRange(o,n.pos)||_posEqual(o,n.pos.to)||e.cm.findMarksAt(n.pos.from).find((function(e){return void 0!==e.widget}))||new i(e,n.pos.from,n.pos.to)},i.prototype.init=function(){var t=this;t.parse(),void 0===t.elem&&(t.elem=e("<a>"+t.linkText+"</a>").addClass("cm-natedit-wiki-link").on("click",(function(i){var n=t.editor.shell.parseLink(t.getText());t.editor.shell.dialog({name:"insertlink",open:function(e){t.editor.shell.initLinkDialog(e)},data:n,event:i}).then((function(i){var n,o=e(i).find(".jqTab.current");o.is(".topic")?n={web:o.find("input[name='web']").val(),topic:o.find("input[name='topic']").val(),text:o.find("input[name='linktext_topic']").val()}:o.is(".external")?n={url:o.find("input[name='url']").val(),text:o.find("input[name='linktext_external']").val()}:o.is(".attachment")&&(n={web:o.find("input[name='web']").val(),topic:o.find("input[name='topic']").val(),file:o.find("select[name='file']").val(),text:o.find("input[name='linktext_attachment']").val()}),t.set(n)}),(function(e){}))}))),t.mark=t.editor.cm.markText(t.from,t.to,{replacedWith:t.elem[0],addToHistory:!1,atomic:!1,clearOnEnter:!0,clearWhenEmpty:!0,handleMouseEvents:!0,widget:t})},i.prototype.parse=function(e){var t=this;void 0===e&&(e=t.getText()),e.match(/\s*\[\[(.*?)\]\[(.*?)\]\]\s*/)?(t.linkTarget=RegExp.$1,t.linkText=RegExp.$2):e.match(/\s*\[\[(.*?)\]\]\s*/)?t.linkTarget=t.linkText=RegExp.$1:console.warn("text of LinkWidget does not make up a [[...]] wiki link:",e)},i.prototype.stringify=function(){var e=this;return e.parse(),`[[${e.linkTarget}][${e.linkText}]]`},i.prototype.getText=function(){var e=this;return e.editor.cm.getRange(e.from,e.to)},i.prototype.setText=function(e){var t=this,i=e.length;t.editor.cm.replaceRange(e,t.from,t.to),t.to.ch=t.from.ch+i,t.init()},i.prototype.set=function(e){var t,i=this;if(void 0!==e.url){if(void 0===e.url||""===e.url)return;void 0!==e.text&&""!==e.text?(i.linkText=e.text,i.linkTarget=e.url,t="[["+e.url+"]["+e.text+"]]"):(i.linkText=e.url,i.linkTarget=e.url,t="[["+e.url+"]]")}else if(void 0!==e.file){if(void 0===e.web||""===e.web||void 0===e.topic||""===e.topic)return;e.web===i.editor.shell.opts.web&&e.topic===i.editor.shell.opts.topic?(i.linkText=i.linkTarget="%ATTACHURLPATH%/"+e.file,t="[[%ATTACHURLPATH%/"+e.file+"]"):(i.linkText=i.linkTarget="%PUBURLPATH%/"+e.web+"/"+e.topic+"/"+e.file,t="[[%PUBURLPATH%/"+e.web+"/"+e.topic+"/"+e.file+"]"),void 0!==e.text&&""!==e.text?(i.linkText=e.text,t+="["+e.text+"]"):(i.linkText=e.file,t+="["+e.file+"]"),t+="]"}else{if(void 0===e.topic||""===e.topic)return;e.web===i.editor.shell.opts.web?(i.linkText=i.linkTarget=e.topic,t="[["+e.topic+"]"):(i.linkText=i.linkTarget=e.web+".".opts.topic,t="[["+e.web+"."+e.topic+"]"),void 0!==e.text&&""!==e.text&&(i.linkText=e.text,t+="["+e.text+"]"),t+="]"}i.setText(t)},window.LinkWidget=i}(jQuery),function(e){var t={className:"ui-natedit-dropdown",activeClassName:"ui-state-active"};function i(i){this.opts=e.extend({},t,i),this.init()}i.prototype.init=function(){var t=this;return t.elem=e("<div></div>").addClass(t.opts.className),t.list=e("<ul></ul>"),t.list.appendTo(t.elem),t.elem.appendTo("body"),t},i.prototype.show=function(e){void 0!==e&&this.elem.css(e),this.elem.show()},i.prototype.hide=function(){this.elem.hide()},i.prototype.isVisible=function(){return this.elem.is(":visible")},i.prototype.getSelection=function(){return this.list.find("."+this.opts.activeClassName+":first")},i.prototype.getItem=function(e){return this.list.children().eq(e)},i.prototype.select=function(e){var t=this;if(void 0!==e&&0!==e.length)return t.list.children().removeClass(t.opts.activeClassName),t.list.scrollTo(e),e.addClass(t.opts.activeClassName),e},i.prototype.set=function(e){var t=this;return t.list.html(e),t.selectFirst(),t},i.prototype.unset=function(){return this.list.empty(),this},i.prototype.selectFirst=function(){return this.select(this.getItem(0))},i.prototype.selectLast=function(){var e=this,t=e.list.children().length-1;return e.select(e.getItem(t))},i.prototype.selectPrev=function(){var e=this.getSelection().prev("li");return this.select(e)},i.prototype.selectNext=function(){var e=this.getSelection().next("li");return this.select(e)},i.prototype.callback=function(e){var t;if(void 0!==(e=e||this.getSelection())&&e.length&&"function"==typeof(t=e.data("callback")))return t();console.warn("no callback at this position. item=",e)},window.DropDownMenu=i}(jQuery),function(e){var t=!1;e.NatEditor=function(t,i){var n=this;n.txtarea=e(t),n.opts=e.extend({},i,n.txtarea.data()),n.id=foswiki.getUniqueID(),n.form=e(t.form),n.isBlockedUnload=!1,n.referrer=document.referrer,n.log("creating new natedit",n.opts),n.container=n.txtarea.wrap('<div class="ui-natedit"></div>').parent(),n.container.attr("id",n.id),n.container.data("natedit",n),n.allowOnReload=!1,n.opts.hidden||n.txtarea.is(".foswikiHidden")?(n.container.addClass("foswikiHidden"),n.initGui()):(n.txtarea.addClass("ui-widget"),n.container.css("opacity",0),e.when(n.preloadTemplate(n.opts.toolbar),n.createEngine()).done((function(){n.initGui(),n.container.css("opacity",1)})))},e.NatEditor.prototype.log=function(){var t,i=this,n=i.id;n=n.substring(n.length-4,n.length),console&&i.opts.debug&&((t=e.makeArray(arguments)).unshift("NATEDIT ("+n+"): "),console&&console.log.apply(console,t))},e.NatEditor.prototype.initAutoExpand=function(){var t,i=this;i.helper=e('<textarea tabindex="-1" class="ui-natedit-auto-expand-helper" />').appendTo(i.container),t={fontFamily:i.txtarea.css("fontFamily")||"",fontSize:i.txtarea.css("fontSize")||"",fontWeight:i.txtarea.css("fontWeight")||"",fontStyle:i.txtarea.css("fontStyle")||"",fontStretch:i.txtarea.css("fontStretch")||"",fontVariant:i.txtarea.css("fontVariant")||"",letterSpacing:i.txtarea.css("letterSpacing")||"",textTransform:i.txtarea.css("textTransform")||"",textIndent:i.txtarea.css("textIndent")||"",wordSpacing:i.txtarea.css("wordSpacing")||"",lineHeight:i.txtarea.css("lineHeight")||"",padding:i.txtarea.css("padding")||"",textWrap:"unrestricted"},i.helper.css(t),i.engine.on("keyup",(function(){i.autoResize()})),e(window).on("resize.natedit",(function(){i.autoResize()}))},e.NatEditor.prototype.createEngine=function(t){var i,n=this,o=e.Deferred();return t=t||n.opts.engine||"raw",void 0===e.NatEditor.engines[t]?(i=n.opts.pubUrl+"/"+n.opts.systemWeb+"/NatEditPlugin/build/"+t+".js",n.getScript(i).done((function(){void 0===e.NatEditor.engines[t]?console&&console.error("failed to create edit engine '"+t+"'"):e.NatEditor.engines[t].createEngine(n).done((function(e){n.engine=e,o.resolve()})).fail((function(e){console&&console.error("failed to create edit engine '"+t+"'",e)}))}))):e.NatEditor.engines[t].createEngine(n).done((function(e){n.engine=e,o.resolve()})).fail((function(e){console&&console.error("failed to initialize edit engine '"+t+"'",e)})),o.promise()},e.NatEditor.prototype.getScript=function(t){var i,n=e.Deferred();return(i=document.createElement("script")).async=!0,i.src=t,i.addEventListener("load",(function(){n.resolve()})),i.addEventListener("error",(function(){n.reject("Error loading script "+t)})),i.addEventListener("abort",(function(){n.reject("Script loading aborted.")})),document.head.appendChild(i),n.promise()},e.NatEditor.prototype.initGui=function(){var t=this;t.log("called initGui"),t.opts.blockUnload&&(t.isBlockedUnload=!0,t.log("adding unload handler"),e(window).on("beforeunload",(function(e){if(t.log("got beforeunload event. isBlockedUnload=",t.isBlockedUnload,"opts=",t.opts.blockUnload),t.isBlockedUnload&&t.hasChanged())return e.preventDefault(),"Are you sure?"}))),t.initToolbar(),foswiki.getPreference("NatEditPlugin").FarbtasticEnabled&&t.container.addClass("ui-natedit-colorpicker-enabled"),t.initForm(),t.engine&&t.engine.initGui(),t.dropdown=new DropDownMenu,t.opts.autoResize&&(t.opts.autoMaxExpand=!1,t.opts.resizable=!1),t.opts.resizable&&t.engine&&t.engine.getWrapperElement().resizable(),t.opts.autoMaxExpand&&(t.txtarea.addClass("ui-natedit-autoexpand"),t.autoMaxExpand(),t.txtarea.parents(".jqTabContents:first").addClass("jqTabDisableMaxExpand").height("auto")),t.opts.autoResize&&(t.initAutoExpand(),t.autoResize()),t.engine&&t.engine.getWrapperElement().addClass("ui-natedit-widget")},e.NatEditor.prototype.initToolbar=function(){var t=this;void 0===t.toolbar&&void 0!==e.templates[t.opts.toolbar]&&(t.toolbar=e(e.templates[t.opts.toolbar].render({web:t.opts.web,topic:t.opts.topic})),t.opts.showFullscreen?t.toolbar.find(".ui-natedit-fullscreen-button").show():t.toolbar.find(".ui-natedit-fullscreen-button").hide(),t.opts.showToolbar||t.toolbar.hide(),t.container.prepend(t.toolbar),t.toolbar.find(".ui-natedit-buttons").buttonset({onlyVisible:!1}).on("click",(function(i){return t.handleToolbarAction(i,e(i.target).closest("a:not(.ui-natedit-menu-button)")),!1})),t.toolbar.find(".ui-natedit-button").button({onlyVisible:!1}).on("click",(function(i){return t.handleToolbarAction(i,e(this)),!1})),t.toolbar.find(".ui-natedit-menu-button").not(".ui-button").button().end().button("option",{icon:"ui-icon-triangle-1-s",iconPosition:"end"}).on("mousedown",(function(){var i=e(this),n=void 0===i.data("menu")?i.next():e(t.container.find(i.data("menu"))),o=n.data("state")||!1;return n.data("menu-button",this),t.hideMenus(),o?i.removeClass("ui-state-highlight"):(i.addClass("ui-state-highlight"),n.show().position({my:"left top",at:"left bottom+10",of:i}),n.data("state",!0)),!1})).on("click",(function(){return!1})),t.toolbar.find(".ui-natedit-menu").each((function(){var i=e(this),n=!1;i.menu().on("menuselect",(function(e,o){e.target=i.data("menu-button"),n&&(t.hideMenus(),t.handleToolbarAction(e,o.item.children("a:first")))})).children().on("mouseup",(function(e){n=!0,i.menu("select",e),n=!1})).on("click",(function(){return!1}))})),e(t.container).on("click",(function(){t.hideMenus()})),t.engine.on("click",(function(){t.hideMenus()})),t.opts.autoHideToolbar&&(t.toolbar.hide(),t.engine.on("focus",(function(){window.setTimeout((function(){t.showToolbar()}))})).on("blur",(function(){window.setTimeout((function(){t.hideToolbar()}))}))),e(window).trigger("resize"))},e.NatEditor.prototype.showToolbar=function(){var t=this;t.toolbar&&t.toolbar.slideDown({duration:200,easing:"easeInQuad",complete:function(){t.opts.autoMaxExpand&&e(window).trigger("resize")}})},e.NatEditor.prototype.hideToolbar=function(){var t=this;t.toolbar&&t.toolbar.slideUp({duration:200,easing:"easeOutQuad",complete:function(){t.opts.autoMaxExpand&&e(window).trigger("resize")}})},e.NatEditor.prototype.showMessage=function(t,i,n){e.pnotify({title:n,text:i,hide:"error"!==t,type:t,sticker:!1,closer_hover:!1,delay:"error"===t?8e3:1e3})},e.NatEditor.prototype.hideMessages=function(){this.form.find(".jqTabGroup a.error, input.error").removeClass("error"),this.form.find("label.error").hide(),e.pnotify_remove_all()},e.NatEditor.prototype.extractErrorMessage=function(t){return t&&t.match(/^<!DOCTYPE/)&&(t=e(t).find(".natErrorMessage").text().replace(/\s+/g," ").replace(/^\s+/,"")||""),"error"===t&&(t="Error: save failed. Please save your content locally and reload this page."),t},e.NatEditor.prototype.beforeSubmit=function(t){var i,n,o=this;return o.log("called beforeSubmit"),void 0===o.form||0===o.form.length?e.Deferred().resolve().promise():(n="foobar",""===(i=o.form.find("input[name=topicparent]")).val()&&i.val("none"),"addform"===t&&o.form.find("input[name='submitChangeForm']").val(t),"save"===t?n="Save":"cancel"===t&&(n="Cancel"),o.form.find("input[name='action_preview']").val(""),o.form.find("input[name='action_save']").val(""),o.form.find("input[name='action_checkpoint']").val(""),o.form.find("input[name='action_addform']").val(""),o.form.find("input[name='action_replaceform']").val(""),o.form.find("input[name='action_cancel']").val(""),o.form.find("input[name='action_"+t+"']").val(n),"undefined"!=typeof StrikeOne&&StrikeOne.submit(o.form[0]),o.form.trigger("beforeSubmit.natedit",{editor:o,action:t}),o.engine&&o.engine.beforeSubmit(t)||e.Deferred().resolve().promise())},e.NatEditor.prototype.initForm=function(){var t,i=this;i.log("called initForm"),void 0===i.form||0===i.form.length||i.form.data("isInitialized")||"topic"!==i.txtarea.attr("id")?i.log("... no form found"):(i.form.data("isInitialized",!0),i.form.find("input[name='TopicTitle']:eq(1)").parents(".foswikiFormStep").remove(),i.form.find("input[name='Summary']:eq(1)").parents(".foswikiFormStep").remove(),i.form.find(".ui-natedit-save").on("click",(function(){return i.exit(),!1})),i.form.find(".ui-natedit-checkpoint").on("click",(function(t){var n=e(t.currentTarget).attr("href").replace(/^#/,"");return i.log("clicked checkpoint"),i.isBlockedUnload=!1,i.save(n),!1})),i.form.find(".ui-natedit-preview").on("click",(function(){return i.log("clicked preview"),i.preview(),!1})),i.form.find(".ui-natedit-cancel").on("click",(function(){return i.log("clicked cancel"),i.cancel(),!1})),i.form.find(".ui-natedit-replaceform").on("click",(function(){return i.log("clicked replaceform"),i.beforeSubmit("replaceform").then((function(){i.isBlockedUnload=!1,i.form.trigger("submit")})),!1})),i.form.find(".ui-natedit-addform").on("click",(function(){return i.log("clicked addform"),i.beforeSubmit("addform").then((function(){i.isBlockedUnload=!1,i.form.trigger("submit")})),!1})),t=e.extend({},i.form.metadata({type:"attr",name:"validate"})),i.form.validate({meta:"validate",ignore:":hidden:not(.jqSelect2), div, .foswikiIgnoreValidation",onsubmit:!1,invalidHandler:function(t,n){n.numberOfInvalids()?(e.unblockUI(),i.showMessage("error",e.i18n("One or more fields have not been filled correctly")),e.each(n.errorList,(function(){var t=e(this.element),i=t.parents(".jqTabPane:first").data("tabPane");t.parents(".jqTab").each((function(){var t=e(this).attr("id");i.getNaviOfTab("#"+t).addClass("error")}))}))):i.hideMessages()},rules:t,ignoreTitle:!0,errorPlacement:function(t,i){i.is("[type=checkbox],[type=radio]")?e("<td>").appendTo(i.parents("tr:first")).append(t):t.insertAfter(i)}}))},e.NatEditor.prototype.exit=function(){var t=this;t.checkCaptcha().then((function(){t.hideMessages(),t.form.validate().form()&&(t.isBlockedUnload=!1,t.beforeSubmit("save").then((function(){document.title=e.i18n("Saving ..."),t.blockHistory(),e.blockUI({message:"<h1> "+e.i18n("Saving ...")+"</h1>"}),t.form.trigger("submit")})))}))},e.NatEditor.prototype.blockHistory=function(){self=this,window.history.replaceState(null,"[blocked history entry]",self.referrer)},e.NatEditor.prototype.preview=function(){var t=this;t.form.validate().form()&&t.beforeSubmit("preview").then((function(){t.form.ajaxSubmit({url:t.opts.saveUrl,beforeSubmit:function(){t.hideMessages(),e.blockUI({message:"<h1>"+e.i18n("Loading preview ...")+"</h1>"})},error:function(i,n){var o=t.extractErrorMessage(i.responseText||n);e.unblockUI(),t.showMessage("error",o)},success:function(t){var i=e(window),n=Math.round(parseInt(.6*i.height(),10)),o=Math.round(parseInt(.6*i.width(),10));e.unblockUI(),o<640&&(o=640),t=t.replace(/%width%/g,o).replace(/%height%/g,n),e("body").append(t)}})}))},e.NatEditor.prototype.cancel=function(){var t=this;t.hideMessages(),t.beforeSubmit("cancel").then((function(){t.isBlockedUnload=!1,document.title=e.i18n("Quitting ..."),t.blockHistory(),e.blockUI({message:"<h1> "+e.i18n("Quitting ...")+"</h1>"}),t.form.trigger("submit")}))},e.NatEditor.prototype.checkCaptcha=function(){var t,i=e.Deferred(),n=e("#editcaptcha");return n.length?((t=n.dialog("option","buttons"))[0].click=function(){n.find(".jqCaptcha").data("captcha").validate()?(n.dialog("close"),i.resolve()):i.reject()},n.dialog("option","buttons",t).dialog("open")):i.resolve(),i.promise()},e.NatEditor.prototype.save=function(t){var i=this;t=t||"checkpoint",i.checkCaptcha().then((function(){var n=i.opts.topic,o=document.title;i.hideMessages(),i.form.validate().form()&&i.beforeSubmit(t).then((function(){n.match(/AUTOINC|XXXXXXXXXX/)?i.form.trigger("submit"):i.form.ajaxSubmit({url:i.opts.saveUrl,beforeSubmit:function(){i.hideMessages(),document.title=e.i18n("Saving ..."),e.blockUI({message:"<h1>"+e.i18n("Saving ...")+"</h1>"})},error:function(e,t){var n=i.extractErrorMessage(e.responseText||t);i.showMessage("error",n)},complete:function(t){var i=t.getResponseHeader("X-Foswiki-Validation");i&&e("input[name='validation_key']").each((function(){e(this).val("?"+i)})),document.title=o,e(".natEditTitleStatus").fadeOut(),e.unblockUI()}})}))}))},e.NatEditor.prototype.handleToolbarAction=function(e,t){var i,n,o=this,r=function(){},a=function(){},s=function(){},l=function(){return{web:o.opts.web,topic:o.opts.topic,selection:o.engine.getSelection()}};if(void 0!==t&&0!==t.length&&void 0!==(i=o.engine.handleToolbarAction(t))&&(void 0!==i.markup&&(i.value=o.opts[i.markup]),void 0!==i.value&&("line"===i.type?o.engine.insertLineTag(i.value):o.engine.insertTag(i.value)),void 0!==i.dialog&&(void 0!==i.okayHandler&&"function"==typeof o[i.okayHandler]&&(r=o[i.okayHandler]),void 0!==i.cancelHandler&&"function"==typeof o[i.cancelHandler]&&(a=o[i.cancelHandler]),void 0!==i.openHandler&&"function"==typeof o[i.openHandler]&&(s=o[i.openHandler]),void 0!==i.optsHandler&&"function"==typeof o[i.optsHandler]&&(l=o[i.optsHandler]),n=l.call(o),o.dialog({name:i.dialog,open:function(e){s.call(o,e)},data:n,modal:i.modal,okayText:i.okayText,cancelText:i.cancelText}).then((function(e){r.call(o,e)}),(function(e){a.call(o,e)}))),void 0!==i.handler)){if("function"==typeof o.engine[i.handler])return void o.engine[i.handler].call(o.engine,e,t);if("function"==typeof o[i.handler])return void o[i.handler].call(o,e,t)}},e.NatEditor.prototype.hideMenus=function(){this.container.find(".ui-natedit-menu").each((function(){var t=e(this);e(t.data("menu-button")).removeClass("ui-state-highlight"),t.hide().data("state",!1)}))},e.NatEditor.prototype.setValue=function(e){this.engine&&this.engine.setValue(e)},e.NatEditor.prototype.getValue=function(){return this.engine.getValue()},e.NatEditor.prototype.handleApplyColor=function(e,t){this.engine.applyColor(t.data("color"))},e.NatEditor.prototype.handleRemoveFormat=function(){this.engine.removeFormat()},e.NatEditor.prototype.handleEscapeTML=function(){var e=this,t=e.engine.getSelection()||"";t=e.escapeTML(t),e.engine.remove(),e.engine.insertTag(["",t,""])},e.NatEditor.prototype.handleUnescapeTML=function(){var e=this,t=e.engine.getSelection()||"";t=e.unescapeTML(t),e.engine.remove(),e.engine.insertTag(["",t,""])},e.NatEditor.prototype.handleFullscreen=function(){var e=this;e.container.toggleClass("ui-natedit-fullscreen"),e.engine.toggleFullscreen(),e.engine.focus()},e.NatEditor.prototype.escapeTML=function(e){var t=e;return t=(t=(t=t.replace(/\$/g,"$dollar")).replace(/%/g,"$percnt")).replace(/"/g,'\\"')},e.NatEditor.prototype.unescapeTML=function(e){var t=e;return t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/\$nop/g,"")).replace(/\\"/g,'"')).replace(/\$perce?nt/g,"%")).replace(/\$quot/g,'"')).replace(/\$comma/g,",")).replace(/\$lt/g,"<")).replace(/\$gt/g,">")).replace(/\$amp/g,"&")).replace(/\$dollar/g,"$")},e.NatEditor.prototype.autoMaxExpand=function(){var t=this;t.log("called autoMaxExpand"),t.fixHeight(),e(window).on("resize.natedit",(function(){t.fixHeight()}))},e.NatEditor.prototype.fixHeight=function(){var t,i=this,n=i.engine.getWrapperElement(),o=i.form.find(".natEditBottomBar");n&&n.length&&(t=(o.length?o.position().top:e(window).height()||window.innerHeight)-n.position().top-(n.outerHeight(!0)-n.height())-(i.container.is(".ui-natedit-fullscreen")?0:i.container.outerHeight(!0)-i.container.height())-2,i.opts.minHeight&&t<i.opts.minHeight&&(t=i.opts.minHeight),t<0||n.is(":visible")&&i.setSize(void 0,t))},e.NatEditor.prototype.setSize=function(e,t){this.engine&&this.engine.setSize(e,t)},e.NatEditor.prototype.getSize=function(){return this.engine.getSize()},e.NatEditor.prototype.autoResize=function(){var e,t,i,n=this;e=new Date,n._time&&e.getTime()-n._time.getTime()<100||(n._time=e,window.setTimeout((function(){var e=n.getSize(),o=Math.round(e.height);t=n.getValue(),n.log("oldHeight=",o),t!==n._lastText&&(n._lastText=t,t=n.htmlEntities(t),n.helper.width(e.width).val(t),n.helper.scrollTop(9e4),i=n.helper.scrollTop()+25,n.opts.minHeight&&i<n.opts.minHeight&&(i=n.opts.minHeight),n.opts.maxHeight&&i>n.opts.maxHeight?(i=n.opts.maxHeight,n.txtarea.css("overflow-y","scroll")):n.txtarea.css("overflow-y","hidden"),o!==(i=Math.round(i))&&(n.log("setting height=",i),n.setSize(void 0,i)))})))},e.NatEditor.prototype.htmlEntities=function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};for(const i of t)e=e.replace(new RegExp(i,"g"),t[i]);return e},e.NatEditor.prototype.preloadTemplate=function(t,i){var n;return i=i||t,n=foswiki.getScriptUrl("rest","JQueryPlugin","tmpl",{topic:this.opts.web+"."+this.opts.topic,load:t,name:i}),e.loadTemplate({url:n,name:i})},e.NatEditor.prototype.dialog=function(t){var i=this,n={url:void 0,title:e.i18n("Confirmation required"),okayText:e.i18n("OK"),okayIcon:"ui-icon-check",cancelText:e.i18n("Cancel"),cancelIcon:"ui-icon-cancel",width:"auto",modal:!0,position:{my:"center",at:"center",of:window},open:function(){},data:{web:i.opts.web,topic:i.opts.topic,selection:i.engine.getSelection()}};return"string"==typeof t&&(t={data:{text:t}}),void 0===t.url&&void 0!==t.name&&(t.url=foswiki.getScriptUrl("rest","JQueryPlugin","tmpl",{topic:i.opts.web+"."+i.opts.topic,load:"editdialog",name:t.name})),void 0!==(t=e.extend({},n,t)).event&&(t.position={my:"center top",at:"left bottom+30",of:t.event.target}),i.hideMessages(),e.Deferred((function(n){e.loadTemplate({url:t.url,name:t.name}).then((function(o){e(o.render(t.data)).dialog({buttons:[{text:t.okayText,icon:t.okayIcon,click:function(){return n.resolve(this),e(this).dialog("close"),!0}},{text:t.cancelText,icon:t.cancelIcon,click:function(){return n.reject(),e(this).dialog("close"),!1}}],open:function(){var o=e(this),r=o.data("title");void 0!==r&&o.dialog("option","title",r),o.find("input").on("keydown",(function(t){var i=e(this);i.is(".ui-autocomplete-input")&&i.data("ui-autocomplete").menu.element.is(":visible")||13===t.keyCode&&(t.preventDefault(),n.resolve(o),o.dialog("close"))})),t.open.call(i,this,t.data)},close:function(){"pending"===n.state()&&n.reject(),e(this).dialog("destroy")},show:"fade",modal:t.modal,draggable:!0,resizable:!1,title:t.title,width:t.width,position:t.position})}),(function(e){i.showMessage("error",e.responseText)}))})).promise()},e.NatEditor.prototype.handleSearchReplace=function(t){var i,n=this,o=e(t),r=o.find("input[name='search']").val(),a=o.find("input[name='replace']").val(),s=!!o.find("input[name='ignorecase']:checked").length;n.log("handleSearchReplace, search='"+r+" 'replace='"+a+"' ignoreCase=",s),r.length&&((i=n.engine.searchReplace(r,a,s))?n.showMessage("info",e.i18n("replaced '%count%' time(s)",{count:i})):n.showMessage("warning",e.i18n("search string '%search%' not found",{search:r})))},e.NatEditor.prototype.handleInsertTable=function(t){var i=e(t),n=i.find("input[name='rows']").val(),o=i.find("input[name='cols']").val(),r=i.find("input[name='heads']").val(),a="true"===i.find("input[name='editable']:checked").val();return this.engine.insertTable({heads:r,rows:n,cols:o,editable:a})},e.NatEditor.prototype.handleInsertLink=function(t){var i={},n=e(t).find(".jqTab.current");if(n.is(".topic"))i={web:n.find("input[name='web']").val(),topic:n.find("input[name='topic']").val(),text:n.find("input[name='linktext_topic']").val()};else if(n.is(".external"))i={url:n.find("input[name='url']").val(),text:n.find("input[name='linktext_external']").val()};else{if(!n.is(".attachment"))return;i={web:n.find("input[name='web']").val(),topic:n.find("input[name='topic']").val(),file:n.find("select[name='file']").val(),text:n.find("input[name='linktext_attachment']").val()}}return this.engine.insertLink(i)},e.NatEditor.prototype.handleInsertImage=function(t){var i=e(t),n={web:i.find("[name=web]").val(),topic:i.find("[name=topic]").val(),caption:i.find("[name=caption]").val(),classList:i.find("[name=classList]").val(),file:i.find("[name=file]").val(),width:i.find("[name=width]").val(),height:i.find("[name=height]").val(),align:i.find("[name=align]:checked").val(),type:i.find("[name=type]:checked").val()};return this.engine.insertImage(n)},e.NatEditor.prototype.handleInsertAttachment=function(t){var i=e(t);return this.engine.insertLink({web:i.find("input[name='web']").val(),topic:i.find("input[name='topic']").val(),file:i.find("select[name='file']").val(),text:i.find("input[name='linktext_attachment']").val()})},e.NatEditor.prototype.initColorDialog=function(t){var i=e(t),n=i.find("input[name='color']")[0];return this.fb=e.farbtastic(i.find(".ui-natedit-colorpicker")).setColor("#fafafa").linkTo(n),!1},e.NatEditor.prototype.parseColorCode=function(){var e=this,t=e.engine.getSelection()||"#ff0000";return{web:e.opts.web,topic:e.opts.topic,selection:t}},e.NatEditor.prototype.openDatePicker=function(){var t,i,n=this,o=n.engine.getSelection();if(""===o)i=new Date;else try{i=new Date(o)}catch(t){n.showMessage("error",e.i18n("invalid date '%date%'",{date:o}))}return void 0===n.datePicker&&(t=e('<div class="ui-natedit-datepicker"/>').css("position","absolute").appendTo(n.container).hide(),n.overlay=e("<div>").addClass("ui-widget-overlay ui-front").hide().appendTo(n.container).on("click",(function(){n.datePicker.hide(),n.overlay.hide()})),n.datePicker=t.datepicker({onSelect:function(){var e=n.datePicker.datepicker("getDate");n.datePicker.hide(),n.overlay.hide(),n.engine.remove(),n.engine.insertTag(["",n.formatDate(e),""])}}).draggable({handle:".ui-widget-header"}).zIndex(n.overlay.zIndex()+1)),n.overlay.show(),n.datePicker.datepicker("setDate",i),n.datePicker.show().focus().position({my:"center",at:"center",of:window}),!1},e.NatEditor.prototype.formatDate=function(e){return(e=e.toDateString().split(/ /))[2]+" "+e[1]+" "+e[3]},e.NatEditor.prototype.hasChanged=function(){return this.engine.hasChanged()},e.NatEditor.prototype.handleInsertColorCode=function(){var e=this,t=e.fb.color;e.engine.remove(),e.engine.insertTag(["",t,""])},e.NatEditor.prototype.handleUndo=function(){this.engine.undo()},e.NatEditor.prototype.handleRedo=function(){this.engine.redo()},e.NatEditor.prototype.handleSortAscending=function(){this.sortSelection("asc")},e.NatEditor.prototype.handleSortDescending=function(){this.sortSelection("desc")},e.NatEditor.prototype.sortSelection=function(t){var i,n,o,r,a,s,l,c=this,p=!0;for(i=c.engine.getSelectionLines().split(/\r?\n/),n=[],o=[],l=0;l<i.length;l++)(a=i[l]).match(/^((?: {3})+(?:[AaIi]\.|\d\.?|\*) | *\|)(.*)$/)?(s=RegExp.$1,a=RegExp.$2):s="",r=parseFloat(a),isNaN(r)&&(p=!1,r=a),a.match(/^\s*$/)?o.push({pos:l,prefix:s,value:r,line:a}):n.push({pos:l,prefix:s,line:a,value:r});n=n.sort((function(e,t){var i=e.value,n=t.value;return p?i-n:i<n?-1:i>n?1:0})),"desc"===t&&(n=n.reverse()),e.map(o,(function(e){n.splice(e.pos,0,e)})),i=[],e.map(n,(function(e){i.push(e.prefix+e.line)})),i=i.join("\n"),c.engine.remove(),c.engine.insertTag(["",i,""])},e.NatEditor.prototype.initLinkDialog=function(t){var i,n=this,o=e(t),r=0,a=o.find(".jqTab.current"),s=o.find(".natEditAttachmentSelector");function l(t,i){var o=s.data("selection")||"",r=s.data("filter")||".*",l=new RegExp(r,"i");t=t||a.find("input[name='web']").val(),i=i||a.find("input[name='topic']").val(),e.ajax({url:n.opts.attachmentsUrl,data:{topic:t+"."+i},dataType:"json"}).done((function(t){var i=[];i.push("<option></option>"),e(t).each((function(e,t){l.test(t.name)&&i.push("<option"+(o===t.name?" selected":"")+">"+t.name+"</option>")})),s.html(i.join(""))}))}0===a.length&&(a=o),o.find("input[name='web']").each((function(){e(this).autocomplete({source:n.opts.webUrl})})).on("change",(function(){l()})),o.find("input[name='topic']").each((function(){e(this).autocomplete({source:function(t,o){var s=a.find("input[name='web']").val();i&&i.abort(),i=e.ajax({url:n.opts.topicUrl,data:e.extend(t,{baseweb:s}),dataType:"json",autocompleteRequest:++r,success:function(t){this.autocompleteRequest===r&&(e.each(t,(function(e,t){t.value=t.value.replace(s+".","")})),o(t))},error:function(){this.autocompleteRequest===r&&o([])}})}})})).on("change",(function(){l()})),l()},e.NatEditor.prototype.imageDialog=function(e){var t=this,i=t.parseImageSelection();t.dialog({name:"insertimage",open:function(e){t.initImageDialog(e)},data:i,event:e}).then((function(e){t.handleInsertImage(e)}))},e.NatEditor.prototype.initImageDialog=function(e){this.log("initImageDialog on dialog=",e),this.initLinkDialog(e)},e.NatEditor.prototype.cancelAttachmentsDialog=function(e){var t=this;t.log("cancelAttachmentsDialog on dialogElem=",e),void 0!==t.uploader?t.log("stopping uploader"):t.log("no uploader found")},e.NatEditor.prototype.parseUrl=function(e){var t={web:this.opts.web,topic:this.opts.topic};return e.match(/^(?:%ATTACHURL(?:PATH)?%\/)(.*?)$/)?(t.file=RegExp.$1,t.type="attachment"):e.match(/(?:(?:%PUBURL(?:PATH)?%|\/pub)\/)(.*)\/(.*?)\/(.*?)$/)?(t.web=RegExp.$1,t.topic=RegExp.$2,t.file=RegExp.$3,t.type="pub"):t.type="unknown",t},e.NatEditor.prototype.parseImageSelection=function(){return this.engine.getImageData()},e.NatEditor.prototype.parseLink=function(e){var t=this,i=t.opts.web,n=t.opts.topic,o="",r="",a="topic",s="(?:file|ftp|gopher|https?|irc|mailto|news|nntp|telnet|webdav|tel|sip|edit)://[^\\s]+?";return void 0===e&&(e=t.engine.getSelection()),e.match(/\s*\[\[(.*?)\]\]\s*/)?(e=RegExp.$1).match("^("+s+")(?:\\]\\[(.*))?$")?(r=RegExp.$1,e=RegExp.$2||"",a="external"):e.match(/^(?:%ATTACHURL(?:PATH)?%\/)(.*?)(?:\]\[(.*))?$/)?(o=RegExp.$1,e=RegExp.$2,a="attachment"):e.match(/^(?:%PUBURL(?:PATH)?%\/)(.*)\/(.*?)\/(.*?)(?:\]\[(.*))?$/)?(i=RegExp.$1,n=RegExp.$2,o=RegExp.$3,e=RegExp.$4,a="attachment"):e.match(/^(?:(.*)\.)?(.*?)(?:\]\[(.*))?$/)?(i=RegExp.$1||i,n=RegExp.$2,e=RegExp.$3||""):(n=e,e=""):e.match("^ *"+s)?(r=e,e="",a="external"):e.match(/^\s*%IMAGE\{"(.*?)"(?:.*?topic="(?:([^\s.]+)\.)?(.*?)")?.*?\}%\s*$/)?(i=RegExp.$2||i,n=RegExp.$3||n,o=RegExp.$1,e="",a="attachment"):e.match(/^\s*([A-Z][^\s.]*)\.(A-Z.*?)\s*$/)&&(i=RegExp.$1||i,n=RegExp.$2,e="",a="topic"),{selection:e,web:i,topic:n,file:o,url:r,type:a}},e.NatEditor.prototype.handleKeyDown=function(e){var t=this;if(t.preventDefault=!1,t.dropdown.isVisible()&&("ArrowUp"===e.key?(t.dropdown.selectPrev(),t.preventDefault=!0):"ArrowDown"===e.key?(t.dropdown.selectNext(),t.preventDefault=!0):"Enter"===e.key?(t.dropdown.hide(),t.preventDefault=!0,t.dropdown.callback()):"Escape"===e.key&&(t.dropdown.hide(),t.preventDefault=!0),t.preventDefault))return e.preventDefault(),!1},e.NatEditor.prototype.handleKeyUp=function(){var e=this;if(!e.preventDefault){var t=e.engine.getBeforeCursor(),i=e.engine.getAfterCursor(1),n=!1;for(const o of e.opts.completions)if(i.match(/^(\s|$)/)&&o.match.test(t)){n=!0,e.execCompletion(o,RegExp.$1);break}n||e.dropdown.hide()}},e.NatEditor.prototype.execCompletion=function(t,i){var n=this;t.search.call(n,i).then((function(o){var r=n.engine.getCursorCoords(-i.length),a=[];e.each(o,(function(o,r){a.push(e("<li>"+t.template.call(n,r)+"</li>").data("callback",(function(){var e=t.result.call(n,r),o=n.engine.getCursor(),a=o.line,s=o.ch-i.length;n.engine.replace(e,{line:a,ch:s},{line:o.line,ch:o.ch})})).on("click",(function(){n.dropdown.hide(),n.dropdown.callback(e(this)),n.engine.focus()})))})),a.length?n.dropdown.set(a).show({top:r.bottom,left:r.left}):n.dropdown.hide()}))},e.NatEditor.prototype.getJSON=function(t){var i,n=this,o=e.Deferred();return void 0===n.cache&&(n.cache=new Map),(i=n.cache.get(t))?(o.resolve(i),o):(e.getJSON(t).then((function(e){n.cache.set(t,e),o.resolve(e)})),o)},e.NatEditor.defaults={debug:!1,blockUnload:!1,toolbar:"edittoolbar",h1Markup:["---+!! ","%TOPIC%",""],h2Markup:["---++ ","Headline text",""],h3Markup:["---+++ ","Headline text",""],h4Markup:["---++++ ","Headline text",""],h5Markup:["---+++++ ","Headline text",""],h6Markup:["---++++++ ","Headline text",""],verbatimMarkup:["<verbatim>\n","Insert non-formatted text here","\n</verbatim>"],quoteMarkup:["<blockquote>\n","Insert quote here","\n</blockquote>"],boldMarkup:["*","Bold text","*"],italicMarkup:["_","Italic text","_"],monoMarkup:["=","Monospace text","="],underlineMarkup:["<u>","Underlined text","</u>"],strikeMarkup:["<del>","Strike through text","</del>"],superscriptMarkup:["<sup>","superscript text","</sup>"],subscriptMarkup:["<sub>","subscript text","</sub>"],colorMarkup:["%COLOR%","colored text","%ENDCOLOR%"],leftMarkup:['<p align="left">\n',"Align left","\n</p>"],centerMarkup:['<p align="center">\n',"Center text","\n</p>"],rightMarkup:['<p align="right">\n',"Align right","\n</p>"],justifyMarkup:['<p align="justify">\n',"Justify text","\n</p>"],numberedListMarkup:["   1 ","enumerated item",""],bulletListMarkup:["   * ","bullet item",""],indentMarkup:["   ","",""],outdentMarkup:["","",""],mathMarkup:['<latex title="Example">\n',"\\sum_{x=1}^{n}\\frac{1}{x}","\n</latex>"],signatureMarkup:["-- ",NaN],dataFormMarkup:["","| *Name*  | *Type* | *Size* | *Values* | *Description* | *Attributes* | *Default* |","\n"],horizRulerMarkup:["","---","\n"],autoHideToolbar:!1,autoMaxExpand:!1,minHeight:0,maxHeight:0,autoResize:!1,resizable:!1,engine:"raw",showToolbar:!0,showFullscreen:!1,completions:[{id:"emoji",match:/(?<=[\s<>|]):(\*?[a-z0-9_+\-]+)$/,search:function(t){var i,n=e.Deferred(),o=!1;return t.match(/^\*(.*)$/)&&(o=!0,t=RegExp.$1),t="^"+(o?".*":"")+_escapeRegExp(t)+".*",i=Emojis.search(t,{limit:20}),n.resolve(i),n.promise()},template:function(e){return`<img src="${Emojis.getUrl(e.id)}"/>&nbsp;${e.id}`},result:function(e){return`${e.id}:`}},{id:"mention",match:/(?<=[\s<>|])(@\*?\w+)$/,search:function(e){var t=foswiki.getScriptUrl("rest","NatEditPlugin","complete",{id:"mention",term:encodeURIComponent(e)});return this.getJSON(t)},template:function(e){return e.title},result:function(e,t){return`@${e.topic}`}},{id:"topic",match:new RegExp(`\\B(\\[\\[[\\*${foswiki.RE.upper}][${foswiki.RE.alnum}\\.]*)$`),search:function(e){var t=foswiki.getScriptUrl("rest","NatEditPlugin","complete",{id:"topic",limit:5,web:this.opts.web,term:encodeURIComponent(e)});return this.getJSON(t)},template:function(e){return e.title},result:function(e){return e.web===this.opts.web?`[[${e.topic}]]`:`[[${e.web}.${e.topic}]]`}}]},e.NatEditor.engines={},e.fn.natedit=function(i){t||(t=!0,e.NatEditor.defaults.web=foswiki.getPreference("WEB"),e.NatEditor.defaults.topic=foswiki.getPreference("TOPIC"),e.NatEditor.defaults.systemWeb=foswiki.getPreference("SYSTEMWEB"),e.NatEditor.defaults.pubUrl=foswiki.getPreference("PUBURL"),e.NatEditor.defaults.signatureMarkup=["-- ","[["+foswiki.getPreference("WIKIUSERNAME")+"]]"," - "+foswiki.getPreference("SERVERTIME")],e.NatEditor.defaults.engine=foswiki.getPreference("NatEditPlugin").Engine,e.NatEditor.defaults.attachmentsUrl=foswiki.getScriptUrl("rest","NatEditPlugin","attachments"),e.NatEditor.defaults.webUrl=foswiki.getScriptUrl("view",e.NatEditor.defaults.systemWeb,"JQueryAjaxHelper",{section:"web",skin:"text",contenttype:"application/json"}),e.NatEditor.defaults.topicUrl=foswiki.getScriptUrl("view",e.NatEditor.defaults.systemWeb,"JQueryAjaxHelper",{section:"topic",skin:"text",contenttype:"application/json"}),e.NatEditor.defaults.saveUrl=foswiki.getScriptUrl("rest","NatEditPlugin","save"));var n=e.extend({},e.NatEditor.defaults,i);return this.each((function(){e.data(this,"natedit")||e.data(this,"natedit",new e.NatEditor(this,n))}))},e((function(){e(".natedit").livequery((function(){e(this).natedit()}))}))}(jQuery),function(e){var t={debug:!1,userUrl:null};function i(i,n){var o=this;o.elem=e(i),o.opts=e.extend({},t,o.elem.data(),n),o.init()}i.prototype.init=function(){var t=this;t.opts.userUrl||(t.opts.userUrl=foswiki.getScriptUrl("rest","NatEditPlugin","users")),t.log("called init opts=",t.opts),t.elem.find(".ui-natedit-details-container input").on("blur",(function(){var t=e(this);t.trigger("AddValue",t.val())})).textboxlist({onSelect:function(e){t.updateDetails(e)},onDeselect:function(e){t.updateDetails(e)},onClear:function(e){t.updateDetails(e)},onReset:function(e){t.updateDetails(e)},autocomplete:t.opts.userUrl}),t.elem.find("input[type=radio]").on("click",(function(){t.setPermissionSet(e(this).data())})),t.elem.find("input[type=radio]:checked").not(":disabled").each((function(){t.setPermissionSet(e(this).data())}))},i.prototype.log=function(){var t,i=this;console&&i.opts.debug&&((t=e.makeArray(arguments)).unshift("PERM: "),console&&console.log.apply(console,t))},i.prototype.setPermission=function(t,i){var n,o,r=this;for(n in r.elem.find(".permset_"+t).each((function(){e(this).val("undefined")})),i)i.hasOwnProperty(n)&&(o=i[n],r.log("setting ."+n+"_"+t+"="+o),r.elem.find("."+n+"_"+t).val(o))},i.prototype.showPermDetails=function(t){var i,n=this,o=[];n.elem.find(".ui-natedit-"+t+"-perms .ui-natedit-details-container").slideDown(300),n.elem.find("input[name='Local+PERMSET_"+t.toUpperCase()+"_DETAILS']").each((function(){(i=e(this).val())&&""!==i&&o.push(i)})),o=o.join(", "),n.setPermission(t,{allow:o})},i.prototype.hidePermDetails=function(e){this.elem.find(".ui-natedit-"+e+"-perms .ui-natedit-details-container").slideUp(300),this.setPermission(e)},i.prototype.updateDetails=function(t){var i=t.currentValues,n=e(t.input).data("permType");this.log("currentValues="+i.join(", ")),this.setPermission(n,{allow:i.join(", ")})},i.prototype.setPermissionSet=function(e){var t=this;"details"===e.perms?t.showPermDetails(e.permType):(t.hidePermDetails(e.permType),t.setPermission(e.permType,e.perms))},e.fn.permissionsEditor=function(t){return this.each((function(){e.data(this,"PermissionsEditor")||e.data(this,"PermissionsEditor",new i(this,t))}))},e((function(){e(".ui-natedit-permissions-form").livequery((function(){e(this).permissionsEditor()}))}))}(jQuery),function(e){var t=/\_(\S+|(?:\S.*?\S))\_(?=$|[\s,.;:!?\)])/g,i=/\*(\S+|(?:\S.*?\S))\*(?=$|[\s,.;:!?\)])/g,n=/__(\S+|(?:\S.*?\S))__(?=$|[\s,.;:!?\)])/g,o=/\=(\S+|(?:\S.*?\S))\=(?=$|[\s,.;:!?\)])/g,r=/\=\=(\S+|(?:\S.*?\S))\=\=(?=$|[\s,.;:!?\)])/g,a=/\%(AQUA|BLACK|BLUE|BROWN|GRAY|GREEN|LIME|MAROON|NAVY|OLIVE|ORANGE|PINK|PURPLE|RED|SILVER|TEAL|WHITE|YELLOW)\%\s*|\s*\%ENDCOLOR\%/g;(BaseEngine=function(){void 0===this.opts&&(this.opts={})}).prototype.init=function(){return e.Deferred().resolve(this).promise()},BaseEngine.prototype.initGui=function(){},BaseEngine.prototype.getWrapperElement=function(){return e(this.shell.txtarea)},BaseEngine.prototype.focus=function(){e(this.shell.txtarea).focus()},BaseEngine.prototype.on=function(e,t){return this.getWrapperElement().on(e,t)},BaseEngine.prototype.setSize=function(e,t){var i=this.getWrapperElement();e&&i.css("width",e),t&&i.css("height",t)},BaseEngine.prototype.toggleFullscreen=function(){var t=this;t.shell.container.is(".ui-natedit-fullscreen")?(t._previousHeight=t.getWrapperElement().outerHeight(),e(window).off("resize.natedit"),t.shell.form.find(".natEditBottomBar").hide(),e("html").css("overflow-y","initial"),t.setSize(void 0,"100%")):(e("html").css("overflow-y","scroll"),t.shell.form.find(".natEditBottomBar").show(),t.setSize(void 0,t._previousHeight),t.shell.opts.autoMaxExpand&&t.shell.autoMaxExpand())},BaseEngine.prototype.getSize=function(){var e=this.getWrapperElement();return{width:e.width(),height:e.height()}},BaseEngine.prototype.beforeSubmit=function(){return e.Deferred().resolve().promise()},BaseEngine.prototype.setValue=function(e){this.getWrapperElement().val(e)},BaseEngine.prototype.getValue=function(){return this.getWrapperElement().val()},BaseEngine.prototype.replace=function(e,t,i){throw"not implemented: replace()"},BaseEngine.prototype.insert=function(){throw"not implemented: insert()"},BaseEngine.prototype.remove=function(){throw"not implemented: remove()"},BaseEngine.prototype.getWordRange=function(){throw"not implemented: getWord()"},BaseEngine.prototype.getSelection=function(){throw"not implemented: getSelection()"},BaseEngine.prototype.getSelectionLines=function(){throw"not implemented: getSelectionLines()"},BaseEngine.prototype.setSelectionRange=function(){throw"not implemented: setSelectionRange()"},BaseEngine.prototype.setCaretPosition=function(){throw"not implemented: setCaretPosition()"},BaseEngine.prototype.getCaretPosition=function(){throw"not implemented: getCaretPosition()"},BaseEngine.prototype.undo=function(){throw"not implemented: undo()"},BaseEngine.prototype.hasChanged=function(){return!0},BaseEngine.prototype.redo=function(){throw"not implemented: redo()"},BaseEngine.prototype.handleToolbarAction=function(e){return e.data()},BaseEngine.prototype.insertLineTag=function(){throw"not implemented: insertLineTag()"},BaseEngine.prototype.removeFormat=function(){var e,s=this,l=s.getSelection();void 0!==l&&""!==l&&(e=l.replace(n,"$1").replace(r,"$1").replace(t,"$1").replace(i,"$1").replace(o,"$1").replace(a,""),s.remove(),s.insert(e))},BaseEngine.prototype.applyColor=function(e){var t=this.shell.opts.colorMarkup;t[0]="%"+e.toUpperCase()+"%",this.insertTag(t)},BaseEngine.prototype.insertTag=function(){throw"not implemented: insertTag()"},BaseEngine.prototype.insertTable=function(e){var t,i=this;void 0===e.heads&&(e.heads=0),void 0===e.rows&&(e.rows=0),void 0===e.cols&&(e.cols=0),e.init=i.getTableSelection(),t=i.generateTMLTable(e),i.remove(),i.insert(t)},BaseEngine.prototype.insertLink=function(e){var t,i=this;if(void 0!==e.url){if(void 0===e.url||""===e.url)return;t=void 0!==e.text&&""!==e.text?"[["+e.url+"]["+e.text+"]]":"[["+e.url+"]]"}else if(void 0!==e.file){if(void 0===e.web||""===e.web||void 0===e.topic||""===e.topic)return;t=e.web===i.shell.opts.web&&e.topic===i.shell.opts.topic?"[[%ATTACHURLPATH%/"+e.file+"]":"[[%PUBURLPATH%/"+e.web+"/"+e.topic+"/"+e.file+"]",void 0!==e.text&&""!==e.text?t+="["+e.text+"]":t+="["+e.file+"]",t+="]"}else{if(void 0===e.topic||""===e.topic)return;t=e.web===i.shell.opts.web?"[["+e.topic+"]":"[["+e.web+"."+e.topic+"]",void 0!==e.text&&""!==e.text&&(t+="["+e.text+"]"),t+="]"}i.remove(),i.insert(t)},BaseEngine.prototype.insertImage=function(e){var t,i=this;i.shell.log("insertImage opts=",e),t='%IMAGE{"'+e.file+'"',e.web===i.shell.opts.web&&e.topic===i.shell.opts.topic||(t+=' topic="',e.web!==i.shell.opts.web&&(t+=e.web+"."),t+=e.topic+'"'),e.width&&!e.height?t+=' size="'+e.width+'"':!e.width&&e.height?t+=' size="'+e.height+'"':(e.width||e.height)&&(t+=' size="'+e.width+"x"+e.height+'"'),e.align&&(t+=' align="'+e.align+'"'),e.caption&&(t+=' caption="'+e.caption+'"'),e.type&&(t+=' type="'+e.type+'"'),e.id&&(t+=' id="'+e.id+'"'),e.classList&&(t+=' class="'+e.classList+'"'),t+="}%",i.remove(),i.insert(t)},BaseEngine.prototype.getCursorCoords=function(e){throw"not implemented: getCursorCoords()"},BaseEngine.prototype.getBeforeCursor=function(e){throw"not implemented: getBeforeCursor()"},BaseEngine.prototype.getAfterCursor=function(e){throw"not implemented: getAfterCursor()"},BaseEngine.prototype.getTableSelection=function(){var e,t=[],i=this.getSelection().replace(/^\s+|\s+$/g,"").split(/\n/);for(e=0;e<i.length;e++)t.push(i[e].split(/\s+/));return t},BaseEngine.prototype.getImageData=function(t){var i,n,o=this,r=(t=e.extend({web:o.shell.opts.web,topic:o.shell.opts.topic},t),o.getSelection());return r.match(/^\s*(<img.*>)\s*$/)?(i=e(RegExp.$1),n=o.shell.parseUrl(i.attr("src")),t.width=i.attr("width")||t.width,t.height=i.attr("height")||t.height,t.align=i.align("height")||t.align,t.type=i.data("type"),t.caption=i.data("caption"),t.web=n.web||t.web||o.shell.opts.web,t.topic=n.topic||t.topic||o.shell.opts.topic,t.file=n.file,t.classList=n.attr("class")):r.match(/^\s*%IMAGE\{"(.*?)"(?:.*?topic="(?:([^\s\.]+)\.)?(.*?)")?.*?\}%\s*$/)&&(t.web=RegExp.$2||t.web,t.topic=RegExp.$3||t.topic,t.file=RegExp.$1),t},BaseEngine.prototype.generateTMLTable=function(e){var t,i,n,o="";for(t=0;t<e.heads;t++){for(o+="|",i=0;i<e.cols;i++)o+=" *head* |";o+="\n"}for(t=0;t<e.rows;t++){for(o+="|",i=0;i<e.cols;i++)void 0!==e.init&&void 0!==e.init[t]&&(n=e.init[t][i]),o+=" "+(n=n||"data")+" |";o+="\n"}return o},BaseEngine.prototype.generateHTMLTable=function(e){var t,i,n,o="";if(o+="<table>",e.heads){for(o+="<thead>",t=0;t<e.heads;t++){for(o+="<tr>",i=0;i<e.cols;i++)o+="<th>head</th>";o+="</tr>"}o+="</thead>"}for(o+="<tbody>",t=0;t<e.rows;t++){for(o+="<tr>",i=0;i<e.cols;i++)void 0!==e.init&&void 0!==e.init[t]&&(n=e.init[t][i]),o+="<td>"+(n=n||"data")+"</td>";o+="</tr>"}return o+="</table>"},BaseEngine.prototype.searchReplace=function(){throw"not implemented: searchReplace()"}}(jQuery);
