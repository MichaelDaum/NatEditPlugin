"use strict";function _last(e){return e[e.length-1]}function _throttle(e,t){var n;return function(...i){clearTimeout(n),n=setTimeout((function(){clearTimeout(n),e(...i)}),t)}}function _debounce(e,t){var n=null,i=null;return function o(r){i=r,n||(e(i),i=null,n=setTimeout((function(){n=null,i&&o(i)}),t))}}function _posEqual(e,t){return e.line==t.line&&t.ch==e.ch}function _posCmp(e,t){return e.line-t.line||e.ch-t.ch}function _posInsideRange(e,t){return _posCmp(t.from,e)<0&&_posCmp(e,t.to)<0}function _posOutsideRange(e,t){return _posCmp(t.from,e)>0||_posCmp(e,t.to)>0}function _rangesOverlap(e,t){return _posCmp(e.from,t.to)<0&&_posCmp(t.from,e.to)<0}function _escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var BaseEngine;!function(e){function t(e,t,n){var i=this;i.editor=e,i.from=t,i.to=n,i.init()}function n(e,n){for(var i=e.cm.getSearchCursor(n,0,0),o=e.cm.getCursor();i.findNext();)_posInsideRange(o,i.pos)||_posEqual(o,i.pos.to)||e.cm.findMarksAt(i.pos.from).find((function(e){return void 0!==e.widget}))||new t(e,i.pos.from,i.pos.to)}t.createWidgets=function(e){n(e,Emojis.emojiRegExp),n(e,Emojis.aliasRegExp)},t.prototype.init=function(){var t=this;t.text=t.getText(),void 0===t.elem&&(t.elem=e("<img>").prop("src",Emojis.getUrl(t.getText())).addClass("emoji cm-natedit-emoji")),t.mark=t.editor.cm.markText(t.from,t.to,{replacedWith:t.elem[0],addToHistory:!1,atomic:!0,clearOnEnter:!0,clearWhenEmpty:!0,widget:t})},t.prototype.stringify=function(){return this.text},t.prototype.getText=function(){var e=this;return e.editor.cm.getRange(e.from,e.to)},t.prototype.setText=function(e){var t=this,n=e.length;t.editor.cm.replaceRange(e,t.from,t.to),t.to.ch=t.from.ch+n,t.init()},window.EmojiWidget=t}(jQuery),function(e){var t=/\[\[.*?\](\[.*?\])?\]/;function n(e,t,n){var i=this;i.editor=e,i.from=t,i.to=n,i.init()}n.createWidgets=function(e){for(var i=e.cm.getSearchCursor(t,0,0),o=e.cm.getCursor();i.findNext();)_posInsideRange(o,i.pos)||_posEqual(o,i.pos.to)||e.cm.findMarksAt(i.pos.from).find((function(e){return void 0!==e.widget}))||new n(e,i.pos.from,i.pos.to)},n.prototype.init=function(){var t=this;t.parse(),void 0===t.elem&&(t.elem=e("<a>"+t.linkText+"</a>").addClass("cm-natedit-wiki-link").on("click",(function(n){var i=t.editor.shell.parseLink(t.getText());t.editor.shell.dialog({name:"insertlink",open:function(e){t.editor.shell.initLinkDialog(e,i)},data:i,event:n}).then((function(n){var i,o=e(n).find(".jqTab.current");o.is(".topic")?i={web:o.find("input[name='web']").val(),topic:o.find("input[name='topic']").val(),text:o.find("input[name='linktext_topic']").val()}:o.is(".external")?i={url:o.find("input[name='url']").val(),text:o.find("input[name='linktext_external']").val()}:o.is(".attachment")&&(i={web:o.find("input[name='web']").val(),topic:o.find("input[name='topic']").val(),file:o.find("select[name='file']").val(),text:o.find("input[name='linktext_attachment']").val()}),t.set(i)}),(function(e){}))}))),t.mark=t.editor.cm.markText(t.from,t.to,{replacedWith:t.elem[0],addToHistory:!1,atomic:!1,clearOnEnter:!0,clearWhenEmpty:!0,handleMouseEvents:!0,widget:t})},n.prototype.parse=function(e){var t=this;void 0===e&&(e=t.getText()),e.match(/\s*\[\[(.*?)\]\[(.*?)\]\]\s*/)?(t.linkTarget=RegExp.$1,t.linkText=RegExp.$2):e.match(/\s*\[\[(.*?)\]\]\s*/)?t.linkTarget=t.linkText=RegExp.$1:console.warn("text of LinkWidget does not make up a [[...]] wiki link:",e)},n.prototype.stringify=function(){var e=this;return e.parse(),`[[${e.linkTarget}][${e.linkText}]]`},n.prototype.getText=function(){var e=this;return e.editor.cm.getRange(e.from,e.to)},n.prototype.setText=function(e){var t=this,n=e.length;t.editor.cm.replaceRange(e,t.from,t.to),t.to.ch=t.from.ch+n,t.init()},n.prototype.set=function(e){var t,n=this;if(void 0!==e.url){if(void 0===e.url||""===e.url)return;void 0!==e.text&&""!==e.text?(n.linkText=e.text,n.linkTarget=e.url,t="[["+e.url+"]["+e.text+"]]"):(n.linkText=e.url,n.linkTarget=e.url,t="[["+e.url+"]]")}else if(void 0!==e.file){if(void 0===e.web||""===e.web||void 0===e.topic||""===e.topic)return;e.web===n.editor.shell.opts.web&&e.topic===n.editor.shell.opts.topic?(n.linkText=n.linkTarget="%ATTACHURLPATH%/"+e.file,t="[[%ATTACHURLPATH%/"+e.file+"]"):(n.linkText=n.linkTarget="%PUBURLPATH%/"+e.web+"/"+e.topic+"/"+e.file,t="[[%PUBURLPATH%/"+e.web+"/"+e.topic+"/"+e.file+"]"),void 0!==e.text&&""!==e.text?(n.linkText=e.text,t+="["+e.text+"]"):(n.linkText=e.file,t+="["+e.file+"]"),t+="]"}else{if(void 0===e.topic||""===e.topic)return;e.web===n.editor.shell.opts.web?(n.linkText=n.linkTarget=e.topic,t="[["+e.topic+"]"):(n.linkText=n.linkTarget=e.web+".".opts.topic,t="[["+e.web+"."+e.topic+"]"),void 0!==e.text&&""!==e.text&&(n.linkText=e.text,t+="["+e.text+"]"),t+="]"}n.setText(t)},window.LinkWidget=n}(jQuery),function(e){var t={className:"ui-natedit-dropdown",activeClassName:"ui-state-active"};function n(n){this.opts=e.extend({},t,n),this.init()}n.prototype.init=function(){var t=this;return t.elem=e("<div></div>").addClass(t.opts.className),t.list=e("<ul></ul>"),t.list.appendTo(t.elem),t.elem.appendTo("body"),t},n.prototype.show=function(e){void 0!==e&&this.elem.css(e),this.elem.show()},n.prototype.hide=function(){this.elem.hide()},n.prototype.isVisible=function(){return this.elem.is(":visible")},n.prototype.getSelection=function(){return this.list.find("."+this.opts.activeClassName+":first")},n.prototype.getItem=function(e){return this.list.children().eq(e)},n.prototype.select=function(e){var t=this;if(void 0!==e&&0!==e.length)return t.list.children().removeClass(t.opts.activeClassName),t.list.scrollTo(e),e.addClass(t.opts.activeClassName),e},n.prototype.set=function(e){var t=this;return t.list.html(e),t.selectFirst(),t},n.prototype.unset=function(){return this.list.empty(),this},n.prototype.selectFirst=function(){return this.select(this.getItem(0))},n.prototype.selectLast=function(){var e=this,t=e.list.children().length-1;return e.select(e.getItem(t))},n.prototype.selectPrev=function(){var e=this.getSelection().prev("li");return this.select(e)},n.prototype.selectNext=function(){var e=this.getSelection().next("li");return this.select(e)},n.prototype.callback=function(e){var t;if(void 0!==(e=e||this.getSelection())&&e.length&&"function"==typeof(t=e.data("callback")))return t();console.warn("no callback at this position. item=",e)},window.DropDownMenu=n}(jQuery),function(e){var t=!1;e.NatEditor=function(t,n){var i=this;i.txtarea=e(t),i.opts=e.extend({},n,i.txtarea.data()),i.id=foswiki.getUniqueID(),i.form=e(t.form),i.isBlockedUnload=!1,i.referrer=document.referrer,i.container=i.txtarea.wrap('<div class="ui-natedit"></div>').parent(),i.container.attr("id",i.id),i.container.data("natedit",i),i.allowOnReload=!1,i.opts.hidden||i.txtarea.is(".foswikiHidden")?i.initGui():(i.txtarea.addClass("ui-widget"),i.container.css("opacity",0),e.when(i.preloadTemplate(i.opts.toolbar),i.createEngine()).done((function(){i.initGui(),i.container.css("opacity",1)})))},e.NatEditor.prototype.log=function(){var t,n=this,i=n.id;i=i.substring(i.length-4,i.length),console&&n.opts.debug&&((t=e.makeArray(arguments)).unshift("NATEDIT ("+i+"): "),console&&console.log.apply(console,t))},e.NatEditor.prototype.initAutoExpand=function(){var t,n=this;n.helper=e('<textarea tabindex="-1" class="ui-natedit-auto-expand-helper" />').appendTo(n.container),t={fontFamily:n.txtarea.css("fontFamily")||"",fontSize:n.txtarea.css("fontSize")||"",fontWeight:n.txtarea.css("fontWeight")||"",fontStyle:n.txtarea.css("fontStyle")||"",fontStretch:n.txtarea.css("fontStretch")||"",fontVariant:n.txtarea.css("fontVariant")||"",letterSpacing:n.txtarea.css("letterSpacing")||"",textTransform:n.txtarea.css("textTransform")||"",textIndent:n.txtarea.css("textIndent")||"",wordSpacing:n.txtarea.css("wordSpacing")||"",lineHeight:n.txtarea.css("lineHeight")||"",padding:n.txtarea.css("padding")||"",textWrap:"unrestricted"},n.helper.css(t),n.engine.on("keyup",(function(){n.autoResize()})),e(window).on("resize.natedit",(function(){n.autoResize()}))},e.NatEditor.prototype.createEngine=function(t){var n,i=this,o=e.Deferred();return t=t||i.opts.engine||"raw",void 0===e.NatEditor.engines[t]?(n=i.opts.pubUrl+"/"+i.opts.systemWeb+"/NatEditPlugin/build/"+t+".js",i.getScript(n).done((function(){void 0===e.NatEditor.engines[t]?console&&console.error("failed to create edit engine '"+t+"'"):e.NatEditor.engines[t].createEngine(i).done((function(e){i.engine=e,o.resolve()})).fail((function(e){console&&console.error("failed to create edit engine '"+t+"'",e)}))}))):e.NatEditor.engines[t].createEngine(i).done((function(e){i.engine=e,o.resolve()})).fail((function(e){console&&console.error("failed to initialize edit engine '"+t+"'",e)})),o.promise()},e.NatEditor.prototype.getScript=function(t){var n,i=e.Deferred();return(n=document.createElement("script")).async=!0,n.src=t,n.addEventListener("load",(function(){i.resolve()})),n.addEventListener("error",(function(){i.reject("Error loading script "+t)})),n.addEventListener("abort",(function(){i.reject("Script loading aborted.")})),document.head.appendChild(n),i.promise()},e.NatEditor.prototype.initGui=function(){var t=this;t.opts.blockUnload&&(t.isBlockedUnload=!0,t.log("adding unload handler"),e(window).on("beforeunload",(function(e){if(t.log("got beforeunload event. isBlockedUnload=",t.isBlockedUnload,"opts=",t.opts.blockUnload),t.isBlockedUnload&&t.hasChanged())return e.preventDefault(),"Are you sure?"}))),t.initToolbar(),foswiki.getPreference("NatEditPlugin").FarbtasticEnabled&&t.container.addClass("ui-natedit-colorpicker-enabled"),t.initForm(),t.engine&&t.engine.initGui(),t.dropdown=new DropDownMenu,t.opts.autoResize&&(t.opts.autoMaxExpand=!1,t.opts.resizable=!1),t.opts.resizable&&t.engine&&t.engine.getWrapperElement().resizable(),t.opts.autoMaxExpand&&(t.txtarea.addClass("ui-natedit-autoexpand"),t.autoMaxExpand(),t.txtarea.parents(".jqTabContents:first").addClass("jqTabDisableMaxExpand").height("auto")),t.opts.autoResize&&(t.initAutoExpand(),t.autoResize()),t.engine&&t.engine.getWrapperElement().addClass("ui-natedit-widget")},e.NatEditor.prototype.initToolbar=function(){var t=this;void 0===t.toolbar&&void 0!==e.templates[t.opts.toolbar]&&(t.toolbar=e(e.templates[t.opts.toolbar].render({web:t.opts.web,topic:t.opts.topic})),t.opts.showFullscreen?t.toolbar.find(".ui-natedit-fullscreen-button").show():t.toolbar.find(".ui-natedit-fullscreen-button").hide(),t.opts.showToolbar||t.toolbar.hide(),t.container.prepend(t.toolbar),t.toolbar.find(".ui-natedit-buttons").buttonset({onlyVisible:!1}).on("click",(function(n){return t.handleToolbarAction(n,e(n.target).closest("a:not(.ui-natedit-menu-button)")),!1})),t.toolbar.find(".ui-natedit-button").button({onlyVisible:!1}).on("click",(function(n){return t.handleToolbarAction(n,e(this)),!1})),t.toolbar.find(".ui-natedit-menu-button").not(".ui-button").button().end().button("option",{icon:"ui-icon-triangle-1-s",iconPosition:"end"}).on("mousedown",(function(){var n=e(this),i=void 0===n.data("menu")?n.next():e(t.container.find(n.data("menu"))),o=i.data("state")||!1;return i.data("menu-button",this),t.hideMenus(),o?n.removeClass("ui-state-highlight"):(n.addClass("ui-state-highlight"),i.show().position({my:"left top",at:"left bottom+10",of:n}),i.data("state",!0)),!1})).on("click",(function(){return!1})),t.toolbar.find(".ui-natedit-menu").each((function(){var n=e(this),i=!1;n.menu().on("menuselect",(function(e,o){e.target=n.data("menu-button"),i&&(t.hideMenus(),t.handleToolbarAction(e,o.item.children("a:first")))})).children().on("mouseup",(function(e){i=!0,n.menu("select",e),i=!1})).on("click",(function(){return!1}))})),e(t.container).on("click",(function(){t.hideMenus()})),t.engine.on("click",(function(){t.hideMenus()})),t.opts.autoHideToolbar&&(t.toolbar.hide(),t.engine.on("focus",(function(){window.setTimeout((function(){t.showToolbar()}))})).on("blur",(function(){window.setTimeout((function(){t.hideToolbar()}))}))),e(window).trigger("resize"))},e.NatEditor.prototype.showToolbar=function(){var t=this;t.toolbar&&(t.toolbar.show(),t.opts.autoMaxExpand&&e(window).trigger("resize"))},e.NatEditor.prototype.hideToolbar=function(){var t=this;t.toolbar&&(t.toolbar.hide(),t.opts.autoMaxExpand&&e(window).trigger("resize"))},e.NatEditor.prototype.showMessage=function(t,n,i){e.pnotify({title:i,text:n,hide:"error"!==t,type:t,sticker:!1,closer_hover:!1,delay:"error"===t?8e3:1e3})},e.NatEditor.prototype.hideMessages=function(){this.form.find(".jqTabGroup a.error, input.error").removeClass("error"),this.form.find("label.error").hide(),e.pnotify_remove_all()},e.NatEditor.prototype.extractErrorMessage=function(t){return t&&t.match(/^<!DOCTYPE/)&&(t=e(t).find(".natErrorMessage").text().replace(/\s+/g," ").replace(/^\s+/,"")||""),"error"===t&&(t="Error: save failed. Please save your content locally and reload this page."),t},e.NatEditor.prototype.beforeSubmit=function(t){var n,i,o=this;return void 0===o.form||0===o.form.length?e.Deferred().resolve().promise():(i="foobar",""===(n=o.form.find("input[name=topicparent]")).val()&&n.val("none"),"addform"===t&&o.form.find("input[name='submitChangeForm']").val(t),"save"===t?i="Save":"cancel"===t&&(i="Cancel"),o.form.find("input[name='action_preview']").val(""),o.form.find("input[name='action_save']").val(""),o.form.find("input[name='action_checkpoint']").val(""),o.form.find("input[name='action_addform']").val(""),o.form.find("input[name='action_replaceform']").val(""),o.form.find("input[name='action_cancel']").val(""),o.form.find("input[name='action_"+t+"']").val(i),"undefined"!=typeof StrikeOne&&StrikeOne.submit(o.form[0]),o.form.trigger("beforeSubmit.natedit",{editor:o,action:t}),o.engine&&o.engine.beforeSubmit(t)||e.Deferred().resolve().promise())},e.NatEditor.prototype.initForm=function(){var t,n=this;void 0===n.form||0===n.form.length||n.form.data("isInitialized")||"topic"!==n.txtarea.attr("id")||(n.form.data("isInitialized",!0),n.form.find("input[name='TopicTitle']:eq(1)").parents(".foswikiFormStep").remove(),n.form.find("input[name='Summary']:eq(1)").parents(".foswikiFormStep").remove(),n.form.find(".ui-natedit-save").on("click",(function(){return n.exit(),!1})),n.form.find(".ui-natedit-checkpoint").on("click",(function(t){var i=e(t.currentTarget).attr("href").replace(/^#/,"");return n.save(i),!1})),n.form.find(".ui-natedit-preview").on("click",(function(){return n.preview(),!1})),n.form.find(".ui-natedit-cancel").on("click",(function(){return n.cancel(),!1})),n.form.find(".ui-natedit-replaceform").on("click",(function(){return n.beforeSubmit("replaceform").then((function(){n.isBlockedUnload=!1,n.form.trigger("submit")})),!1})),n.form.find(".ui-natedit-addform").on("click",(function(){return n.beforeSubmit("addform").then((function(){n.isBlockedUnload=!1,n.form.trigger("submit")})),!1})),t=e.extend({},n.form.metadata({type:"attr",name:"validate"})),n.form.validate({meta:"validate",ignore:":hidden, .foswikiIgnoreValidation",onsubmit:!1,invalidHandler:function(t,i){i.numberOfInvalids()?(e.unblockUI(),n.showMessage("error",e.i18n("One or more fields have not been filled correctly")),e.each(i.errorList,(function(){var t=e(this.element),n=t.parents(".jqTabPane:first").data("tabPane");t.parents(".jqTab").each((function(){var t=e(this).attr("id");n.getNaviOfTab("#"+t).addClass("error")}))}))):n.hideMessages()},rules:t,ignoreTitle:!0,errorPlacement:function(t,n){n.is("[type=checkbox],[type=radio]")?e("<td>").appendTo(n.parents("tr:first")).append(t):t.insertAfter(n)}}))},e.NatEditor.prototype.exit=function(){var t=this;t.checkCaptcha().then((function(){t.hideMessages(),t.form.validate().form()&&(t.isBlockedUnload=!1,t.beforeSubmit("save").then((function(){document.title=e.i18n("Saving ..."),t.blockHistory(),e.blockUI({message:"<h1> "+e.i18n("Saving ...")+"</h1>"}),t.form.trigger("submit")})))}))},e.NatEditor.prototype.blockHistory=function(){self=this,window.history.replaceState(null,"[blocked history entry]",self.referrer)},e.NatEditor.prototype.preview=function(){var t=this;t.form.validate().form()&&t.beforeSubmit("preview").then((function(){t.form.ajaxSubmit({url:t.opts.saveUrl,beforeSubmit:function(){t.hideMessages(),e.blockUI({message:"<h1>"+e.i18n("Loading preview ...")+"</h1>"})},error:function(n,i){var o=t.extractErrorMessage(n.responseText||i);e.unblockUI(),t.showMessage("error",o)},success:function(t){var n=e(window),i=Math.round(parseInt(.6*n.height(),10)),o=Math.round(parseInt(.6*n.width(),10));e.unblockUI(),o<640&&(o=640),t=t.replace(/%width%/g,o).replace(/%height%/g,i),e("body").append(t)}})}))},e.NatEditor.prototype.cancel=function(){var t=this;t.hideMessages(),t.beforeSubmit("cancel").then((function(){t.isBlockedUnload=!1,document.title=e.i18n("Quitting ..."),t.blockHistory(),e.blockUI({message:"<h1> "+e.i18n("Quitting ...")+"</h1>"}),t.form.trigger("submit")}))},e.NatEditor.prototype.checkCaptcha=function(){var t,n=e.Deferred(),i=e("#editcaptcha");return i.length?((t=i.dialog("option","buttons"))[0].click=function(){i.find(".jqCaptcha").data("captcha").validate()?(i.dialog("close"),n.resolve()):n.reject()},i.dialog("option","buttons",t).dialog("open")):n.resolve(),n.promise()},e.NatEditor.prototype.save=function(t){var n=this;t=t||"checkpoint",n.checkCaptcha().then((function(){var i=n.opts.topic,o=document.title;n.hideMessages(),n.form.validate().form()&&n.beforeSubmit(t).then((function(){i.match(/AUTOINC|XXXXXXXXXX/)?n.form.trigger("submit"):n.form.ajaxSubmit({url:n.opts.saveUrl,beforeSubmit:function(){n.hideMessages(),document.title=e.i18n("Saving ..."),e.blockUI({message:"<h1>"+e.i18n("Saving ...")+"</h1>"})},error:function(e,t){var i=n.extractErrorMessage(e.responseText||t);n.showMessage("error",i)},complete:function(t){var n=t.getResponseHeader("X-Foswiki-Validation");n&&e("input[name='validation_key']").each((function(){e(this).val("?"+n)})),document.title=o,e(".natEditTitleStatus").fadeOut(),e.unblockUI()}})}))}))},e.NatEditor.prototype.handleToolbarAction=function(e,t){var n,i,o=this,r=function(){},a=function(){},s=function(){},l=function(){return{web:o.opts.web,topic:o.opts.topic,selection:o.engine.getSelection()}};if(void 0!==t&&0!==t.length&&void 0!==(n=o.engine.handleToolbarAction(t))&&(void 0!==n.markup&&(n.value=o.opts[n.markup]),void 0!==n.value&&("line"===n.type?o.engine.insertLineTag(n.value):o.engine.insertTag(n.value)),void 0!==n.dialog&&(void 0!==n.okayHandler&&"function"==typeof o[n.okayHandler]&&(r=o[n.okayHandler]),void 0!==n.cancelHandler&&"function"==typeof o[n.cancelHandler]&&(a=o[n.cancelHandler]),void 0!==n.openHandler&&"function"==typeof o[n.openHandler]&&(s=o[n.openHandler]),void 0!==n.optsHandler&&"function"==typeof o[n.optsHandler]&&(l=o[n.optsHandler]),i=l.call(o),o.dialog({name:n.dialog,open:function(e){s.call(o,e,i)},data:i,event:e,modal:n.modal,okayText:n.okayText,cancelText:n.cancelText}).then((function(e){r.call(o,e)}),(function(e){a.call(o,e)}))),void 0!==n.handler)){if("function"==typeof o.engine[n.handler])return void o.engine[n.handler].call(o.engine,e,t);if("function"==typeof o[n.handler])return void o[n.handler].call(o,e,t)}},e.NatEditor.prototype.hideMenus=function(){this.container.find(".ui-natedit-menu").each((function(){var t=e(this);e(t.data("menu-button")).removeClass("ui-state-highlight"),t.hide().data("state",!1)}))},e.NatEditor.prototype.setValue=function(e){this.engine.setValue(e)},e.NatEditor.prototype.getValue=function(){return this.engine.getValue()},e.NatEditor.prototype.handleApplyColor=function(e,t){this.engine.applyColor(t.data("color"))},e.NatEditor.prototype.handleRemoveFormat=function(){this.engine.removeFormat()},e.NatEditor.prototype.handleEscapeTML=function(){var e=this,t=e.engine.getSelection()||"";t=e.escapeTML(t),e.engine.remove(),e.engine.insertTag(["",t,""])},e.NatEditor.prototype.handleUnescapeTML=function(){var e=this,t=e.engine.getSelection()||"";t=e.unescapeTML(t),e.engine.remove(),e.engine.insertTag(["",t,""])},e.NatEditor.prototype.handleFullscreen=function(){var e=this;e.container.toggleClass("ui-natedit-fullscreen"),e.engine.toggleFullscreen(),e.engine.focus()},e.NatEditor.prototype.escapeTML=function(e){var t=e;return t=(t=(t=t.replace(/\$/g,"$dollar")).replace(/%/g,"$percnt")).replace(/"/g,'\\"')},e.NatEditor.prototype.unescapeTML=function(e){var t=e;return t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/\$nop/g,"")).replace(/\\"/g,'"')).replace(/\$perce?nt/g,"%")).replace(/\$quot/g,'"')).replace(/\$comma/g,",")).replace(/\$lt/g,"<")).replace(/\$gt/g,">")).replace(/\$amp/g,"&")).replace(/\$dollar/g,"$")},e.NatEditor.prototype.autoMaxExpand=function(){var t=this;t.fixHeight(),e(window).on("resize.natedit",(function(){t.fixHeight()}))},e.NatEditor.prototype.fixHeight=function(){var t,n=this,i=n.engine.getWrapperElement(),o=n.form.find(".natEditBottomBar");i&&i.length&&(t=(o.length?o.position().top:e(window).height()||window.innerHeight)-i.position().top-(i.outerHeight(!0)-i.height())-(n.container.is(".ui-natedit-fullscreen")?0:n.container.outerHeight(!0)-n.container.height())-2,n.opts.minHeight&&t<n.opts.minHeight&&(t=n.opts.minHeight),t<0||i.is(":visible")&&n.setSize(void 0,t))},e.NatEditor.prototype.setSize=function(e,t){this.engine&&this.engine.setSize(e,t)},e.NatEditor.prototype.getSize=function(){return this.engine.getSize()},e.NatEditor.prototype.autoResize=function(){var e,t,n,i=this;e=new Date,i._time&&e.getTime()-i._time.getTime()<100||(i._time=e,window.setTimeout((function(){var e=i.getSize(),o=Math.round(e.height);t=i.getValue(),i.log("oldHeight=",o),t!==i._lastText&&(i._lastText=t,t=i.htmlEntities(t),i.helper.width(e.width).val(t),i.helper.scrollTop(9e4),n=i.helper.scrollTop()+25,i.opts.minHeight&&n<i.opts.minHeight&&(n=i.opts.minHeight),i.opts.maxHeight&&n>i.opts.maxHeight?(n=i.opts.maxHeight,i.txtarea.css("overflow-y","scroll")):i.txtarea.css("overflow-y","hidden"),o!==(n=Math.round(n))&&(i.log("setting height=",n),i.setSize(void 0,n)))})))},e.NatEditor.prototype.htmlEntities=function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};for(const n of t)e=e.replace(new RegExp(n,"g"),t[n]);return e},e.NatEditor.prototype.preloadTemplate=function(t,n){var i;return n=n||t,i=foswiki.getScriptUrl("rest","JQueryPlugin","tmpl",{topic:this.opts.web+"."+this.opts.topic,load:t,name:n}),e.loadTemplate({url:i,name:n})},e.NatEditor.prototype.dialog=function(t){var n=this,i={url:void 0,title:e.i18n("Confirmation required"),okayText:e.i18n("OK"),okayIcon:"ui-icon-check",cancelText:e.i18n("Cancel"),cancelIcon:"ui-icon-cancel",width:"auto",modal:!0,position:{my:"center",at:"center",of:window},open:function(){},data:{web:n.opts.web,topic:n.opts.topic,selection:n.engine.getSelection()}};return"string"==typeof t&&(t={data:{text:t}}),void 0===t.url&&void 0!==t.name&&(t.url=foswiki.getScriptUrl("rest","JQueryPlugin","tmpl",{topic:n.opts.web+"."+n.opts.topic,load:"editdialog",name:t.name})),void 0!==(t=e.extend({},i,t)).event&&(t.position={my:"center top",at:"left bottom+30",of:t.event.target}),n.hideMessages(),e.Deferred((function(i){e.loadTemplate({url:t.url,name:t.name}).then((function(o){e(o.render(t.data)).dialog({buttons:[{text:t.okayText,icon:t.okayIcon,click:function(){return i.resolve(this),e(this).dialog("close"),!0}},{text:t.cancelText,icon:t.cancelIcon,click:function(){return i.reject(),e(this).dialog("close"),!1}}],open:function(){var o=e(this),r=o.data("title");void 0!==r&&o.dialog("option","title",r),o.find("input").on("keydown",(function(t){var n=e(this);n.is(".ui-autocomplete-input")&&n.data("ui-autocomplete").menu.element.is(":visible")||13===t.keyCode&&(t.preventDefault(),i.resolve(o),o.dialog("close"))})),t.open.call(n,this,t.data)},close:function(){"pending"===i.state()&&i.reject(),e(this).dialog("destroy")},show:"fade",modal:t.modal,draggable:!0,resizable:!1,title:t.title,width:t.width,position:t.position})}),(function(e){n.showMessage("error",e.responseText)}))})).promise()},e.NatEditor.prototype.handleSearchReplace=function(t){var n,i=this,o=e(t),r=o.find("input[name='search']").val(),a=o.find("input[name='replace']").val(),s=!!o.find("input[name='ignorecase']:checked").length;i.log("handleSearchReplace, search='"+r+" 'replace='"+a+"' ignoreCase=",s),r.length&&((n=i.engine.searchReplace(r,a,s))?i.showMessage("info",e.i18n("replaced '%count%' time(s)",{count:n})):i.showMessage("warning",e.i18n("search string '%search%' not found",{search:r})))},e.NatEditor.prototype.handleInsertTable=function(t){var n=e(t),i=n.find("input[name='rows']").val(),o=n.find("input[name='cols']").val(),r=n.find("input[name='heads']").val(),a="true"===n.find("input[name='editable']:checked").val();return this.engine.insertTable({heads:r,rows:i,cols:o,editable:a})},e.NatEditor.prototype.handleInsertLink=function(t){var n={},i=e(t).find(".jqTab.current");if(i.is(".topic"))n={web:i.find("input[name='web']").val(),topic:i.find("input[name='topic']").val(),text:i.find("input[name='linktext_topic']").val()};else if(i.is(".external"))n={url:i.find("input[name='url']").val(),text:i.find("input[name='linktext_external']").val()};else{if(!i.is(".attachment"))return;n={web:i.find("input[name='web']").val(),topic:i.find("input[name='topic']").val(),file:i.find("select[name='file']").val(),text:i.find("input[name='linktext_attachment']").val()}}return this.engine.insertLink(n)},e.NatEditor.prototype.handleInsertImage=function(t){var n=e(t),i={web:n.find("[name=web]").val(),topic:n.find("[name=topic]").val(),caption:n.find("[name=caption]").val(),file:n.find("[name=file]").val(),width:n.find("[name=width]").val(),height:n.find("[name=height]").val(),align:n.find("[name=align]:checked").val(),type:n.find("[name=type]:checked").val()};return this.engine.insertImage(i)},e.NatEditor.prototype.handleInsertAttachment=function(t){var n=e(t);return this.engine.insertLink({web:n.find("input[name='web']").val(),topic:n.find("input[name='topic']").val(),file:n.find("select[name='file']").val(),text:n.find("input[name='linktext_attachment']").val()})},e.NatEditor.prototype.initColorDialog=function(t){var n=e(t),i=n.find("input[name='color']")[0];return this.fb=e.farbtastic(n.find(".ui-natedit-colorpicker")).setColor("#fafafa").linkTo(i),!1},e.NatEditor.prototype.parseColorCode=function(){var e=this,t=e.engine.getSelection()||"#ff0000";return{web:e.opts.web,topic:e.opts.topic,selection:t}},e.NatEditor.prototype.openDatePicker=function(){var t,n,i=this,o=i.engine.getSelection();if(""===o)n=new Date;else try{n=new Date(o)}catch(t){i.showMessage("error",e.i18n("invalid date '%date%'",{date:o}))}return void 0===i.datePicker&&(t=e('<div class="ui-natedit-datepicker"/>').css("position","absolute").appendTo(i.container).hide(),i.overlay=e("<div>").addClass("ui-widget-overlay ui-front").hide().appendTo(i.container).on("click",(function(){i.datePicker.hide(),i.overlay.hide()})),i.datePicker=t.datepicker({onSelect:function(){var e=i.datePicker.datepicker("getDate");i.datePicker.hide(),i.overlay.hide(),i.engine.remove(),i.engine.insertTag(["",i.formatDate(e),""])}}).draggable({handle:".ui-widget-header"}).zIndex(i.overlay.zIndex()+1)),i.overlay.show(),i.datePicker.datepicker("setDate",n),i.datePicker.show().focus().position({my:"center",at:"center",of:window}),!1},e.NatEditor.prototype.formatDate=function(e){return(e=e.toDateString().split(/ /))[2]+" "+e[1]+" "+e[3]},e.NatEditor.prototype.hasChanged=function(){return this.engine.hasChanged()},e.NatEditor.prototype.handleInsertColorCode=function(){var e=this,t=e.fb.color;e.engine.remove(),e.engine.insertTag(["",t,""])},e.NatEditor.prototype.handleUndo=function(){this.engine.undo()},e.NatEditor.prototype.handleRedo=function(){this.engine.redo()},e.NatEditor.prototype.handleSortAscending=function(){this.sortSelection("asc")},e.NatEditor.prototype.handleSortDescending=function(){this.sortSelection("desc")},e.NatEditor.prototype.sortSelection=function(t){var n,i,o,r,a,s,l,c=this,p=!0;for(n=c.engine.getSelectionLines().split(/\r?\n/),i=[],o=[],l=0;l<n.length;l++)(a=n[l]).match(/^((?: {3})+(?:[AaIi]\.|\d\.?|\*) | *\|)(.*)$/)?(s=RegExp.$1,a=RegExp.$2):s="",r=parseFloat(a),isNaN(r)&&(p=!1,r=a),a.match(/^\s*$/)?o.push({pos:l,prefix:s,value:r,line:a}):i.push({pos:l,prefix:s,line:a,value:r});i=i.sort((function(e,t){var n=e.value,i=t.value;return p?n-i:n<i?-1:n>i?1:0})),"desc"===t&&(i=i.reverse()),e.map(o,(function(e){i.splice(e.pos,0,e)})),n=[],e.map(i,(function(e){n.push(e.prefix+e.line)})),n=n.join("\n"),c.engine.remove(),c.engine.insertTag(["",n,""])},e.NatEditor.prototype.initLinkDialog=function(t){var n,i=this,o=e(t),r=0,a=o.find(".jqTab.current"),s=o.find(".natEditAttachmentSelector");function l(t,n){var o=s.data("selection")||"",r=s.data("filter")||".*",l=new RegExp(r,"i");t=t||a.find("input[name='web']").val(),n=n||a.find("input[name='topic']").val(),e.ajax({url:i.opts.attachmentsUrl,data:{topic:t+"."+n},dataType:"json"}).done((function(t){var n=[];n.push("<option></option>"),e(t).each((function(e,t){l.test(t.name)&&n.push("<option"+(o===t.name?" selected":"")+">"+t.name+"</option>")})),s.html(n.join(""))}))}0===a.length&&(a=o),o.find("input[name='web']").each((function(){e(this).autocomplete({source:i.opts.webUrl})})).on("change",(function(){l()})),o.find("input[name='topic']").each((function(){e(this).autocomplete({source:function(t,o){var s=a.find("input[name='web']").val();n&&n.abort(),n=e.ajax({url:i.opts.topicUrl,data:e.extend(t,{baseweb:s}),dataType:"json",autocompleteRequest:++r,success:function(t){this.autocompleteRequest===r&&(e.each(t,(function(e,t){t.value=t.value.replace(s+".","")})),o(t))},error:function(){this.autocompleteRequest===r&&o([])}})}})})).on("change",(function(){l()})),l()},e.NatEditor.prototype.initImageDialog=function(e,t){this.initLinkDialog(e,t)},e.NatEditor.prototype.cancelAttachmentsDialog=function(e){var t=this;t.log("cancelAttachmentsDialog on dialogElem=",e),void 0!==t.uploader?t.log("stopping uploader"):t.log("no uploader found")},e.NatEditor.prototype.parseUrl=function(e){var t={web:this.opts.web,topic:this.opts.topic};return console.log("called parseUrl()",e),e.match(/^(?:%ATTACHURL(?:PATH)?%\/)(.*?)$/)?(console.log("here1"),t.file=RegExp.$1,t.type="attachment"):e.match(/(?:(?:%PUBURL(?:PATH)?%|\/pub)\/)(.*)\/(.*?)\/(.*?)$/)?(console.log("here2"),t.web=RegExp.$1,t.topic=RegExp.$2,t.file=RegExp.$3,t.type="pub"):(console.log("here4"),t.type="unknown"),console.log("parsed url=",t),t},e.NatEditor.prototype.parseImageSelection=function(){return this.engine.getImageData()},e.NatEditor.prototype.parseLink=function(e){var t=this,n=t.opts.web,i=t.opts.topic,o="",r="",a="topic",s="(?:file|ftp|gopher|https?|irc|mailto|news|nntp|telnet|webdav|tel|sip|edit)://[^\\s]+?";return void 0===e&&(e=t.engine.getSelection()),e.match(/\s*\[\[(.*?)\]\]\s*/)?(e=RegExp.$1).match("^("+s+")(?:\\]\\[(.*))?$")?(r=RegExp.$1,e=RegExp.$2||"",a="external"):e.match(/^(?:%ATTACHURL(?:PATH)?%\/)(.*?)(?:\]\[(.*))?$/)?(o=RegExp.$1,e=RegExp.$2,a="attachment"):e.match(/^(?:%PUBURL(?:PATH)?%\/)(.*)\/(.*?)\/(.*?)(?:\]\[(.*))?$/)?(n=RegExp.$1,i=RegExp.$2,o=RegExp.$3,e=RegExp.$4,a="attachment"):e.match(/^(?:(.*)\.)?(.*?)(?:\]\[(.*))?$/)?(n=RegExp.$1||n,i=RegExp.$2,e=RegExp.$3||""):(i=e,e=""):e.match("^ *"+s)?(r=e,e="",a="external"):e.match(/^\s*%IMAGE\{"(.*?)"(?:.*?topic="(?:([^\s.]+)\.)?(.*?)")?.*?\}%\s*$/)?(n=RegExp.$2||n,i=RegExp.$3||i,o=RegExp.$1,e="",a="attachment"):e.match(/^\s*([A-Z][^\s.]*)\.(A-Z.*?)\s*$/)&&(n=RegExp.$1||n,i=RegExp.$2,e="",a="topic"),{selection:e,web:n,topic:i,file:o,url:r,type:a}},e.NatEditor.prototype.handleKeyDown=function(e){var t=this;if(t.preventDefault=!1,t.dropdown.isVisible()&&("ArrowUp"===e.key?(t.dropdown.selectPrev(),t.preventDefault=!0):"ArrowDown"===e.key?(t.dropdown.selectNext(),t.preventDefault=!0):"Enter"===e.key?(t.dropdown.hide(),t.preventDefault=!0,t.dropdown.callback()):"Escape"===e.key&&(t.dropdown.hide(),t.preventDefault=!0),t.preventDefault))return e.preventDefault(),!1},e.NatEditor.prototype.handleKeyUp=function(){var e=this;if(!e.preventDefault){var t=e.engine.getBeforeCursor(),n=e.engine.getAfterCursor(1),i=!1;for(const o of e.opts.completions)if(n.match(/^(\s|$)/)&&o.match.test(t)){i=!0,e.execCompletion(o,RegExp.$1);break}i||e.dropdown.hide()}},e.NatEditor.prototype.execCompletion=function(t,n){var i=this;t.search.call(i,n).then((function(o){var r=i.engine.getCursorCoords(-n.length),a=[];e.each(o,(function(o,r){a.push(e("<li>"+t.template.call(i,r)+"</li>").data("callback",(function(){var e=t.result.call(i,r),o=i.engine.getCursor(),a=o.line,s=o.ch-n.length;i.engine.replace(e,{line:a,ch:s},{line:o.line,ch:o.ch})})).on("click",(function(){i.dropdown.hide(),i.dropdown.callback(e(this)),i.engine.focus()})))})),a.length?i.dropdown.set(a).show({top:r.bottom,left:r.left}):i.dropdown.hide()}))},e.NatEditor.prototype.getJSON=function(t){var n,i=this,o=e.Deferred();return void 0===i.cache&&(i.cache=new Map),(n=i.cache.get(t))?(o.resolve(n),o):(e.getJSON(t).then((function(e){i.cache.set(t,e),o.resolve(e)})),o)},e.NatEditor.defaults={debug:!1,blockUnload:!1,toolbar:"edittoolbar",h1Markup:["---+!! ","%TOPIC%",""],h2Markup:["---++ ","Headline text",""],h3Markup:["---+++ ","Headline text",""],h4Markup:["---++++ ","Headline text",""],h5Markup:["---+++++ ","Headline text",""],h6Markup:["---++++++ ","Headline text",""],verbatimMarkup:["<verbatim>\n","Insert non-formatted text here","\n</verbatim>"],quoteMarkup:["<blockquote>\n","Insert quote here","\n</blockquote>"],boldMarkup:["*","Bold text","*"],italicMarkup:["_","Italic text","_"],monoMarkup:["=","Monospace text","="],underlineMarkup:["<u>","Underlined text","</u>"],strikeMarkup:["<del>","Strike through text","</del>"],superscriptMarkup:["<sup>","superscript text","</sup>"],subscriptMarkup:["<sub>","subscript text","</sub>"],colorMarkup:["%COLOR%","colored text","%ENDCOLOR%"],leftMarkup:['<p align="left">\n',"Align left","\n</p>"],centerMarkup:['<p align="center">\n',"Center text","\n</p>"],rightMarkup:['<p align="right">\n',"Align right","\n</p>"],justifyMarkup:['<p align="justify">\n',"Justify text","\n</p>"],numberedListMarkup:["   1 ","enumerated item",""],bulletListMarkup:["   * ","bullet item",""],indentMarkup:["   ","",""],outdentMarkup:["","",""],mathMarkup:['<latex title="Example">\n',"\\sum_{x=1}^{n}\\frac{1}{x}","\n</latex>"],signatureMarkup:["-- ",NaN],dataFormMarkup:["","| *Name*  | *Type* | *Size* | *Values* | *Description* | *Attributes* | *Default* |","\n"],horizRulerMarkup:["","---","\n"],autoHideToolbar:!1,autoMaxExpand:!1,minHeight:0,maxHeight:0,autoResize:!1,resizable:!1,engine:"raw",showToolbar:!0,showFullscreen:!1,completions:[{id:"emoji",match:/\B:(\*?[a-z0-9_+\-]+)$/,search:function(t){var n,i=e.Deferred(),o=!1;return t.match(/^\*(.*)$/)&&(o=!0,t=RegExp.$1),t="^"+(o?".*":"")+_escapeRegExp(t)+".*",n=Emojis.search(t,{limit:20}),i.resolve(n),i.promise()},template:function(e){return`<img src="${Emojis.getUrl(e.id)}"/>&nbsp;${e.id}`},result:function(e){return`${e.id}:`}},{id:"mention",match:/\B(@\*?\w+)$/,search:function(e){var t=foswiki.getScriptUrl("rest","NatEditPlugin","complete",{id:"mention",term:encodeURIComponent(e)});return this.getJSON(t)},template:function(e){return e.title},result:function(e,t){return`@${e.topic}`}},{id:"topic",match:new RegExp(`\\B(\\[\\[[\\*${foswiki.RE.upper}][${foswiki.RE.alnum}\\.]*)$`),search:function(e){var t=foswiki.getScriptUrl("rest","NatEditPlugin","complete",{id:"topic",limit:5,web:this.opts.web,term:encodeURIComponent(e)});return this.getJSON(t)},template:function(e){return e.title},result:function(e){return e.web===this.opts.web?`[[${e.topic}]]`:`[[${e.web}.${e.topic}]]`}}]},e.NatEditor.engines={},e.fn.natedit=function(n){t||(t=!0,e.NatEditor.defaults.web=foswiki.getPreference("WEB"),e.NatEditor.defaults.topic=foswiki.getPreference("TOPIC"),e.NatEditor.defaults.systemWeb=foswiki.getPreference("SYSTEMWEB"),e.NatEditor.defaults.pubUrl=foswiki.getPreference("PUBURL"),e.NatEditor.defaults.signatureMarkup=["-- ","[["+foswiki.getPreference("WIKIUSERNAME")+"]]"," - "+foswiki.getPreference("SERVERTIME")],e.NatEditor.defaults.engine=foswiki.getPreference("NatEditPlugin").Engine,e.NatEditor.defaults.attachmentsUrl=foswiki.getScriptUrl("rest","NatEditPlugin","attachments"),e.NatEditor.defaults.webUrl=foswiki.getScriptUrl("view",e.NatEditor.defaults.systemWeb,"JQueryAjaxHelper",{section:"web",skin:"text",contenttype:"application/json"}),e.NatEditor.defaults.topicUrl=foswiki.getScriptUrl("view",e.NatEditor.defaults.systemWeb,"JQueryAjaxHelper",{section:"topic",skin:"text",contenttype:"application/json"}),e.NatEditor.defaults.saveUrl=foswiki.getScriptUrl("rest","NatEditPlugin","save"));var i=e.extend({},e.NatEditor.defaults,n);return this.each((function(){e.data(this,"natedit")||e.data(this,"natedit",new e.NatEditor(this,i))}))},e((function(){e(".natedit").livequery((function(){e(this).natedit()}))}))}(jQuery),function(e){var t={debug:!1,userUrl:null};function n(n,i){var o=this;o.elem=e(n),o.opts=e.extend({},t,o.elem.data(),i),o.init()}n.prototype.init=function(){var t=this;t.opts.userUrl||(t.opts.userUrl=foswiki.getScriptUrl("rest","NatEditPlugin","users")),t.log("called init opts=",t.opts),t.elem.find(".ui-natedit-details-container input").on("blur",(function(){var t=e(this);t.trigger("AddValue",t.val())})).textboxlist({onSelect:function(e){t.updateDetails(e)},onDeselect:function(e){t.updateDetails(e)},onClear:function(e){t.updateDetails(e)},onReset:function(e){t.updateDetails(e)},autocomplete:t.opts.userUrl}),t.elem.find("input[type=radio]").on("click",(function(){t.setPermissionSet(e(this).data())})),t.elem.find("input[type=radio]:checked").not(":disabled").each((function(){t.setPermissionSet(e(this).data())}))},n.prototype.log=function(){var t,n=this;console&&n.opts.debug&&((t=e.makeArray(arguments)).unshift("PERM: "),console&&console.log.apply(console,t))},n.prototype.setPermission=function(t,n){var i,o,r=this;for(i in r.elem.find(".permset_"+t).each((function(){e(this).val("undefined")})),n)n.hasOwnProperty(i)&&(o=n[i],r.log("setting ."+i+"_"+t+"="+o),r.elem.find("."+i+"_"+t).val(o))},n.prototype.showPermDetails=function(t){var n,i=this,o=[];i.elem.find(".ui-natedit-"+t+"-perms .ui-natedit-details-container").slideDown(300),i.elem.find("input[name='Local+PERMSET_"+t.toUpperCase()+"_DETAILS']").each((function(){(n=e(this).val())&&""!==n&&o.push(n)})),o=o.join(", "),i.setPermission(t,{allow:o})},n.prototype.hidePermDetails=function(e){this.elem.find(".ui-natedit-"+e+"-perms .ui-natedit-details-container").slideUp(300),this.setPermission(e)},n.prototype.updateDetails=function(t){var n=t.currentValues,i=e(t.input).data("permType");this.log("currentValues="+n.join(", ")),this.setPermission(i,{allow:n.join(", ")})},n.prototype.setPermissionSet=function(e){var t=this;"details"===e.perms?t.showPermDetails(e.permType):(t.hidePermDetails(e.permType),t.setPermission(e.permType,e.perms))},e.fn.permissionsEditor=function(t){return this.each((function(){e.data(this,"PermissionsEditor")||e.data(this,"PermissionsEditor",new n(this,t))}))},e((function(){e(".ui-natedit-permissions-form").livequery((function(){e(this).permissionsEditor()}))}))}(jQuery),function(e){var t=/\_(\S+|(?:\S.*?\S))\_(?=$|[\s,.;:!?\)])/g,n=/\*(\S+|(?:\S.*?\S))\*(?=$|[\s,.;:!?\)])/g,i=/__(\S+|(?:\S.*?\S))__(?=$|[\s,.;:!?\)])/g,o=/\=(\S+|(?:\S.*?\S))\=(?=$|[\s,.;:!?\)])/g,r=/\=\=(\S+|(?:\S.*?\S))\=\=(?=$|[\s,.;:!?\)])/g,a=/\%(AQUA|BLACK|BLUE|BROWN|GRAY|GREEN|LIME|MAROON|NAVY|OLIVE|ORANGE|PINK|PURPLE|RED|SILVER|TEAL|WHITE|YELLOW)\%\s*|\s*\%ENDCOLOR\%/g;(BaseEngine=function(){void 0===this.opts&&(this.opts={})}).prototype.init=function(){return e.Deferred().resolve(this).promise()},BaseEngine.prototype.initGui=function(){},BaseEngine.prototype.getWrapperElement=function(){return e(this.shell.txtarea)},BaseEngine.prototype.focus=function(){e(this.shell.txtarea).focus()},BaseEngine.prototype.on=function(e,t){return this.getWrapperElement().on(e,t)},BaseEngine.prototype.setSize=function(e,t){var n=this.getWrapperElement();e&&n.css("width",e),t&&n.css("height",t)},BaseEngine.prototype.toggleFullscreen=function(){var t=this;t.shell.container.is(".ui-natedit-fullscreen")?(t._previousHeight=t.getWrapperElement().outerHeight(),e(window).off("resize.natedit"),t.shell.form.find(".natEditBottomBar").hide(),e("html").css("overflow-y","initial"),t.setSize(void 0,"100%")):(e("html").css("overflow-y","scroll"),t.shell.form.find(".natEditBottomBar").show(),t.setSize(void 0,t._previousHeight),t.shell.opts.autoMaxExpand&&t.shell.autoMaxExpand())},BaseEngine.prototype.getSize=function(){var e=this.getWrapperElement();return{width:e.width(),height:e.height()}},BaseEngine.prototype.beforeSubmit=function(){return e.Deferred().resolve().promise()},BaseEngine.prototype.setValue=function(e){this.getWrapperElement().val(e)},BaseEngine.prototype.getValue=function(){return this.getWrapperElement().val()},BaseEngine.prototype.replace=function(e,t,n){throw"not implemented: replace()"},BaseEngine.prototype.insert=function(){throw"not implemented: insert()"},BaseEngine.prototype.remove=function(){throw"not implemented: remove()"},BaseEngine.prototype.getWordRange=function(){throw"not implemented: getWord()"},BaseEngine.prototype.getSelection=function(){throw"not implemented: getSelection()"},BaseEngine.prototype.getSelectionLines=function(){throw"not implemented: getSelectionLines()"},BaseEngine.prototype.setSelectionRange=function(){throw"not implemented: setSelectionRange()"},BaseEngine.prototype.setCaretPosition=function(){throw"not implemented: setCaretPosition()"},BaseEngine.prototype.getCaretPosition=function(){throw"not implemented: getCaretPosition()"},BaseEngine.prototype.undo=function(){throw"not implemented: undo()"},BaseEngine.prototype.hasChanged=function(){return!0},BaseEngine.prototype.redo=function(){throw"not implemented: redo()"},BaseEngine.prototype.handleToolbarAction=function(e){return e.data()},BaseEngine.prototype.insertLineTag=function(){throw"not implemented: insertLineTag()"},BaseEngine.prototype.removeFormat=function(){var e,s=this,l=s.getSelection();void 0!==l&&""!==l&&(e=l.replace(i,"$1").replace(r,"$1").replace(t,"$1").replace(n,"$1").replace(o,"$1").replace(a,""),s.remove(),s.insert(e))},BaseEngine.prototype.applyColor=function(e){var t=this.shell.opts.colorMarkup;t[0]="%"+e.toUpperCase()+"%",this.insertTag(t)},BaseEngine.prototype.insertTag=function(){throw"not implemented: insertTag()"},BaseEngine.prototype.insertTable=function(e){var t,n=this;void 0===e.heads&&(e.heads=0),void 0===e.rows&&(e.rows=0),void 0===e.cols&&(e.cols=0),e.init=n.getTableSelection(),t=n.generateTMLTable(e),n.remove(),n.insert(t)},BaseEngine.prototype.insertLink=function(e){var t,n=this;if(void 0!==e.url){if(void 0===e.url||""===e.url)return;t=void 0!==e.text&&""!==e.text?"[["+e.url+"]["+e.text+"]]":"[["+e.url+"]]"}else if(void 0!==e.file){if(void 0===e.web||""===e.web||void 0===e.topic||""===e.topic)return;t=e.web===n.shell.opts.web&&e.topic===n.shell.opts.topic?"[[%ATTACHURLPATH%/"+e.file+"]":"[[%PUBURLPATH%/"+e.web+"/"+e.topic+"/"+e.file+"]",void 0!==e.text&&""!==e.text?t+="["+e.text+"]":t+="["+e.file+"]",t+="]"}else{if(void 0===e.topic||""===e.topic)return;t=e.web===n.shell.opts.web?"[["+e.topic+"]":"[["+e.web+"."+e.topic+"]",void 0!==e.text&&""!==e.text&&(t+="["+e.text+"]"),t+="]"}n.remove(),n.insert(t)},BaseEngine.prototype.insertImage=function(e){var t,n=this;n.shell.log("insertImage opts=",e),t='%IMAGE{"'+e.file+'"',e.web===n.shell.opts.web&&e.topic===n.shell.opts.topic||(t+=' topic="',e.web!==n.shell.opts.web&&(t+=e.web+"."),t+=e.topic+'"'),e.width&&!e.height?t+=' size="'+e.width+'"':!e.width&&e.height?t+=' size="'+e.height+'"':(e.width||e.height)&&(t+=' size="'+e.width+"x"+e.height+'"'),e.align&&(t+=' align="'+e.align+'"'),e.caption&&(t+=' caption="'+e.caption+'"'),e.type&&(t+=' type="'+e.type+'"'),t+="}%",n.remove(),n.insert(t)},BaseEngine.prototype.getCursorCoords=function(e){throw"not implemented: getCursorCoords()"},BaseEngine.prototype.getBeforeCursor=function(e){throw"not implemented: getBeforeCursor()"},BaseEngine.prototype.getAfterCursor=function(e){throw"not implemented: getAfterCursor()"},BaseEngine.prototype.getTableSelection=function(){var e,t=[],n=this.getSelection().replace(/^\s+|\s+$/g,"").split(/\n/);for(e=0;e<n.length;e++)t.push(n[e].split(/\s+/));return t},BaseEngine.prototype.getImageData=function(t){var n,i,o=this,r=(t=e.extend({web:o.shell.opts.web,topic:o.shell.opts.topic},t),o.getSelection());return r.match(/^\s*(<img.*>)\s*$/)?(n=e(RegExp.$1),i=o.shell.parseUrl(n.attr("src")),t.width=n.attr("width")||t.width,t.height=n.attr("height")||t.height,t.web=i.web||t.web||o.shell.opts.web,t.topic=i.topic||t.topic||o.shell.opts.topic,t.file=i.file):r.match(/^\s*%IMAGE\{"(.*?)"(?:.*?topic="(?:([^\s\.]+)\.)?(.*?)")?.*?\}%\s*$/)&&(t.web=RegExp.$2||t.web,t.topic=RegExp.$3||t.topic,t.file=RegExp.$1),t},BaseEngine.prototype.generateTMLTable=function(e){var t,n,i,o="";for(t=0;t<e.heads;t++){for(o+="|",n=0;n<e.cols;n++)o+=" *head* |";o+="\n"}for(t=0;t<e.rows;t++){for(o+="|",n=0;n<e.cols;n++)void 0!==e.init&&void 0!==e.init[t]&&(i=e.init[t][n]),o+=" "+(i=i||"data")+" |";o+="\n"}return o},BaseEngine.prototype.generateHTMLTable=function(e){var t,n,i,o="";if(o+="<table>",e.heads){for(o+="<thead>",t=0;t<e.heads;t++){for(o+="<tr>",n=0;n<e.cols;n++)o+="<th>head</th>";o+="</tr>"}o+="</thead>"}for(o+="<tbody>",t=0;t<e.rows;t++){for(o+="<tr>",n=0;n<e.cols;n++)void 0!==e.init&&void 0!==e.init[t]&&(i=e.init[t][n]),o+="<td>"+(i=i||"data")+"</td>";o+="</tr>"}return o+="</table>"},BaseEngine.prototype.searchReplace=function(){throw"not implemented: searchReplace()"}}(jQuery);
