/*! @license DOMPurify 3.2.4 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.2.4/LICENSE */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).DOMPurify=t()}(this,(function(){"use strict";const{entries:e,setPrototypeOf:t,isFrozen:n,getPrototypeOf:i,getOwnPropertyDescriptor:o}=Object;let{freeze:r,seal:a,create:s}=Object,{apply:l,construct:c}="undefined"!=typeof Reflect&&Reflect;r||(r=function(e){return e}),a||(a=function(e){return e}),l||(l=function(e,t,n){return e.apply(t,n)}),c||(c=function(e,t){return new e(...t)});const p=S(Array.prototype.forEach),u=S(Array.prototype.lastIndexOf),d=S(Array.prototype.pop),f=S(Array.prototype.push),g=S(Array.prototype.splice),h=S(String.prototype.toLowerCase),m=S(String.prototype.toString),v=S(String.prototype.match),y=S(String.prototype.replace),w=S(String.prototype.indexOf),E=S(String.prototype.trim),b=S(Object.prototype.hasOwnProperty),T=S(RegExp.prototype.test),x=(k=TypeError,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return c(k,t)});var k;function S(e){return function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return l(e,t,i)}}function N(e,i){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:h;t&&t(e,null);let r=i.length;for(;r--;){let t=i[r];if("string"==typeof t){const e=o(t);e!==t&&(n(i)||(i[r]=e),t=e)}e[t]=!0}return e}function R(e){for(let t=0;t<e.length;t++){b(e,t)||(e[t]=null)}return e}function C(t){const n=s(null);for(const[i,o]of e(t)){b(t,i)&&(Array.isArray(o)?n[i]=R(o):o&&"object"==typeof o&&o.constructor===Object?n[i]=C(o):n[i]=o)}return n}function A(e,t){for(;null!==e;){const n=o(e,t);if(n){if(n.get)return S(n.get);if("function"==typeof n.value)return S(n.value)}e=i(e)}return function(){return null}}const _=r(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),M=r(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),D=r(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),L=r(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),I=r(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),P=r(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),U=r(["#text"]),O=r(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),H=r(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),z=r(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),$=r(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),B=a(/\{\{[\w\W]*|[\w\W]*\}\}/gm),W=a(/<%[\w\W]*|[\w\W]*%>/gm),j=a(/\$\{[\w\W]*/gm),F=a(/^data-[\-\w.\u00B7-\uFFFF]+$/),G=a(/^aria-[\-\w]+$/),V=a(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),q=a(/^(?:\w+script|data):/i),X=a(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),Y=a(/^html$/i),Q=a(/^[a-z][.\w]*(-[.\w]+)+$/i);var K=Object.freeze({__proto__:null,ARIA_ATTR:G,ATTR_WHITESPACE:X,CUSTOM_ELEMENT:Q,DATA_ATTR:F,DOCTYPE_NAME:Y,ERB_EXPR:W,IS_ALLOWED_URI:V,IS_SCRIPT_OR_DATA:q,MUSTACHE_EXPR:B,TMPLIT_EXPR:j});const J=1,Z=3,ee=7,te=8,ne=9,ie=function(){return"undefined"==typeof window?null:window};var oe=function t(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ie();const i=e=>t(e);if(i.version="3.2.4",i.removed=[],!n||!n.document||n.document.nodeType!==ne||!n.Element)return i.isSupported=!1,i;let{document:o}=n;const a=o,l=a.currentScript,{DocumentFragment:c,HTMLTemplateElement:k,Node:S,Element:R,NodeFilter:B,NamedNodeMap:W=n.NamedNodeMap||n.MozNamedAttrMap,HTMLFormElement:j,DOMParser:F,trustedTypes:G}=n,q=R.prototype,X=A(q,"cloneNode"),Q=A(q,"remove"),oe=A(q,"nextSibling"),re=A(q,"childNodes"),ae=A(q,"parentNode");if("function"==typeof k){const e=o.createElement("template");e.content&&e.content.ownerDocument&&(o=e.content.ownerDocument)}let se,le="";const{implementation:ce,createNodeIterator:pe,createDocumentFragment:ue,getElementsByTagName:de}=o,{importNode:fe}=a;let ge={afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]};i.isSupported="function"==typeof e&&"function"==typeof ae&&ce&&void 0!==ce.createHTMLDocument;const{MUSTACHE_EXPR:he,ERB_EXPR:me,TMPLIT_EXPR:ve,DATA_ATTR:ye,ARIA_ATTR:we,IS_SCRIPT_OR_DATA:Ee,ATTR_WHITESPACE:be,CUSTOM_ELEMENT:Te}=K;let{IS_ALLOWED_URI:xe}=K,ke=null;const Se=N({},[..._,...M,...D,...I,...U]);let Ne=null;const Re=N({},[...O,...H,...z,...$]);let Ce=Object.seal(s(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Ae=null,_e=null,Me=!0,De=!0,Le=!1,Ie=!0,Pe=!1,Ue=!0,Oe=!1,He=!1,ze=!1,$e=!1,Be=!1,We=!1,je=!0,Fe=!1,Ge=!0,Ve=!1,qe={},Xe=null;const Ye=N({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let Qe=null;const Ke=N({},["audio","video","img","source","image","track"]);let Je=null;const Ze=N({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),et="http://www.w3.org/1998/Math/MathML",tt="http://www.w3.org/2000/svg",nt="http://www.w3.org/1999/xhtml";let it=nt,ot=!1,rt=null;const at=N({},[et,tt,nt],m);let st=N({},["mi","mo","mn","ms","mtext"]),lt=N({},["annotation-xml"]);const ct=N({},["title","style","font","a","script"]);let pt=null;const ut=["application/xhtml+xml","text/html"];let dt=null,ft=null;const gt=o.createElement("form"),ht=function(e){return e instanceof RegExp||e instanceof Function},mt=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!ft||ft!==e){if(e&&"object"==typeof e||(e={}),e=C(e),pt=-1===ut.indexOf(e.PARSER_MEDIA_TYPE)?"text/html":e.PARSER_MEDIA_TYPE,dt="application/xhtml+xml"===pt?m:h,ke=b(e,"ALLOWED_TAGS")?N({},e.ALLOWED_TAGS,dt):Se,Ne=b(e,"ALLOWED_ATTR")?N({},e.ALLOWED_ATTR,dt):Re,rt=b(e,"ALLOWED_NAMESPACES")?N({},e.ALLOWED_NAMESPACES,m):at,Je=b(e,"ADD_URI_SAFE_ATTR")?N(C(Ze),e.ADD_URI_SAFE_ATTR,dt):Ze,Qe=b(e,"ADD_DATA_URI_TAGS")?N(C(Ke),e.ADD_DATA_URI_TAGS,dt):Ke,Xe=b(e,"FORBID_CONTENTS")?N({},e.FORBID_CONTENTS,dt):Ye,Ae=b(e,"FORBID_TAGS")?N({},e.FORBID_TAGS,dt):{},_e=b(e,"FORBID_ATTR")?N({},e.FORBID_ATTR,dt):{},qe=!!b(e,"USE_PROFILES")&&e.USE_PROFILES,Me=!1!==e.ALLOW_ARIA_ATTR,De=!1!==e.ALLOW_DATA_ATTR,Le=e.ALLOW_UNKNOWN_PROTOCOLS||!1,Ie=!1!==e.ALLOW_SELF_CLOSE_IN_ATTR,Pe=e.SAFE_FOR_TEMPLATES||!1,Ue=!1!==e.SAFE_FOR_XML,Oe=e.WHOLE_DOCUMENT||!1,$e=e.RETURN_DOM||!1,Be=e.RETURN_DOM_FRAGMENT||!1,We=e.RETURN_TRUSTED_TYPE||!1,ze=e.FORCE_BODY||!1,je=!1!==e.SANITIZE_DOM,Fe=e.SANITIZE_NAMED_PROPS||!1,Ge=!1!==e.KEEP_CONTENT,Ve=e.IN_PLACE||!1,xe=e.ALLOWED_URI_REGEXP||V,it=e.NAMESPACE||nt,st=e.MATHML_TEXT_INTEGRATION_POINTS||st,lt=e.HTML_INTEGRATION_POINTS||lt,Ce=e.CUSTOM_ELEMENT_HANDLING||{},e.CUSTOM_ELEMENT_HANDLING&&ht(e.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(Ce.tagNameCheck=e.CUSTOM_ELEMENT_HANDLING.tagNameCheck),e.CUSTOM_ELEMENT_HANDLING&&ht(e.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(Ce.attributeNameCheck=e.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),e.CUSTOM_ELEMENT_HANDLING&&"boolean"==typeof e.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements&&(Ce.allowCustomizedBuiltInElements=e.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Pe&&(De=!1),Be&&($e=!0),qe&&(ke=N({},U),Ne=[],!0===qe.html&&(N(ke,_),N(Ne,O)),!0===qe.svg&&(N(ke,M),N(Ne,H),N(Ne,$)),!0===qe.svgFilters&&(N(ke,D),N(Ne,H),N(Ne,$)),!0===qe.mathMl&&(N(ke,I),N(Ne,z),N(Ne,$))),e.ADD_TAGS&&(ke===Se&&(ke=C(ke)),N(ke,e.ADD_TAGS,dt)),e.ADD_ATTR&&(Ne===Re&&(Ne=C(Ne)),N(Ne,e.ADD_ATTR,dt)),e.ADD_URI_SAFE_ATTR&&N(Je,e.ADD_URI_SAFE_ATTR,dt),e.FORBID_CONTENTS&&(Xe===Ye&&(Xe=C(Xe)),N(Xe,e.FORBID_CONTENTS,dt)),Ge&&(ke["#text"]=!0),Oe&&N(ke,["html","head","body"]),ke.table&&(N(ke,["tbody"]),delete Ae.tbody),e.TRUSTED_TYPES_POLICY){if("function"!=typeof e.TRUSTED_TYPES_POLICY.createHTML)throw x('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if("function"!=typeof e.TRUSTED_TYPES_POLICY.createScriptURL)throw x('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');se=e.TRUSTED_TYPES_POLICY,le=se.createHTML("")}else void 0===se&&(se=function(e,t){if("object"!=typeof e||"function"!=typeof e.createPolicy)return null;let n=null;const i="data-tt-policy-suffix";t&&t.hasAttribute(i)&&(n=t.getAttribute(i));const o="dompurify"+(n?"#"+n:"");try{return e.createPolicy(o,{createHTML:e=>e,createScriptURL:e=>e})}catch(e){return console.warn("TrustedTypes policy "+o+" could not be created."),null}}(G,l)),null!==se&&"string"==typeof le&&(le=se.createHTML(""));r&&r(e),ft=e}},vt=N({},[...M,...D,...L]),yt=N({},[...I,...P]),wt=function(e){f(i.removed,{element:e});try{ae(e).removeChild(e)}catch(t){Q(e)}},Et=function(e,t){try{f(i.removed,{attribute:t.getAttributeNode(e),from:t})}catch(e){f(i.removed,{attribute:null,from:t})}if(t.removeAttribute(e),"is"===e)if($e||Be)try{wt(t)}catch(e){}else try{t.setAttribute(e,"")}catch(e){}},bt=function(e){let t=null,n=null;if(ze)e="<remove></remove>"+e;else{const t=v(e,/^[\r\n\t ]+/);n=t&&t[0]}"application/xhtml+xml"===pt&&it===nt&&(e='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+e+"</body></html>");const i=se?se.createHTML(e):e;if(it===nt)try{t=(new F).parseFromString(i,pt)}catch(e){}if(!t||!t.documentElement){t=ce.createDocument(it,"template",null);try{t.documentElement.innerHTML=ot?le:i}catch(e){}}const r=t.body||t.documentElement;return e&&n&&r.insertBefore(o.createTextNode(n),r.childNodes[0]||null),it===nt?de.call(t,Oe?"html":"body")[0]:Oe?t.documentElement:r},Tt=function(e){return pe.call(e.ownerDocument||e,e,B.SHOW_ELEMENT|B.SHOW_COMMENT|B.SHOW_TEXT|B.SHOW_PROCESSING_INSTRUCTION|B.SHOW_CDATA_SECTION,null)},xt=function(e){return e instanceof j&&("string"!=typeof e.nodeName||"string"!=typeof e.textContent||"function"!=typeof e.removeChild||!(e.attributes instanceof W)||"function"!=typeof e.removeAttribute||"function"!=typeof e.setAttribute||"string"!=typeof e.namespaceURI||"function"!=typeof e.insertBefore||"function"!=typeof e.hasChildNodes)},kt=function(e){return"function"==typeof S&&e instanceof S};function St(e,t,n){p(e,(e=>{e.call(i,t,n,ft)}))}const Nt=function(e){let t=null;if(St(ge.beforeSanitizeElements,e,null),xt(e))return wt(e),!0;const n=dt(e.nodeName);if(St(ge.uponSanitizeElement,e,{tagName:n,allowedTags:ke}),e.hasChildNodes()&&!kt(e.firstElementChild)&&T(/<[/\w]/g,e.innerHTML)&&T(/<[/\w]/g,e.textContent))return wt(e),!0;if(e.nodeType===ee)return wt(e),!0;if(Ue&&e.nodeType===te&&T(/<[/\w]/g,e.data))return wt(e),!0;if(!ke[n]||Ae[n]){if(!Ae[n]&&Ct(n)){if(Ce.tagNameCheck instanceof RegExp&&T(Ce.tagNameCheck,n))return!1;if(Ce.tagNameCheck instanceof Function&&Ce.tagNameCheck(n))return!1}if(Ge&&!Xe[n]){const t=ae(e)||e.parentNode,n=re(e)||e.childNodes;if(n&&t){for(let i=n.length-1;i>=0;--i){const o=X(n[i],!0);o.__removalCount=(e.__removalCount||0)+1,t.insertBefore(o,oe(e))}}}return wt(e),!0}return e instanceof R&&!function(e){let t=ae(e);t&&t.tagName||(t={namespaceURI:it,tagName:"template"});const n=h(e.tagName),i=h(t.tagName);return!!rt[e.namespaceURI]&&(e.namespaceURI===tt?t.namespaceURI===nt?"svg"===n:t.namespaceURI===et?"svg"===n&&("annotation-xml"===i||st[i]):Boolean(vt[n]):e.namespaceURI===et?t.namespaceURI===nt?"math"===n:t.namespaceURI===tt?"math"===n&&lt[i]:Boolean(yt[n]):e.namespaceURI===nt?!(t.namespaceURI===tt&&!lt[i])&&!(t.namespaceURI===et&&!st[i])&&!yt[n]&&(ct[n]||!vt[n]):!("application/xhtml+xml"!==pt||!rt[e.namespaceURI]))}(e)?(wt(e),!0):"noscript"!==n&&"noembed"!==n&&"noframes"!==n||!T(/<\/no(script|embed|frames)/i,e.innerHTML)?(Pe&&e.nodeType===Z&&(t=e.textContent,p([he,me,ve],(e=>{t=y(t,e," ")})),e.textContent!==t&&(f(i.removed,{element:e.cloneNode()}),e.textContent=t)),St(ge.afterSanitizeElements,e,null),!1):(wt(e),!0)},Rt=function(e,t,n){if(je&&("id"===t||"name"===t)&&(n in o||n in gt))return!1;if(De&&!_e[t]&&T(ye,t));else if(Me&&T(we,t));else if(!Ne[t]||_e[t]){if(!(Ct(e)&&(Ce.tagNameCheck instanceof RegExp&&T(Ce.tagNameCheck,e)||Ce.tagNameCheck instanceof Function&&Ce.tagNameCheck(e))&&(Ce.attributeNameCheck instanceof RegExp&&T(Ce.attributeNameCheck,t)||Ce.attributeNameCheck instanceof Function&&Ce.attributeNameCheck(t))||"is"===t&&Ce.allowCustomizedBuiltInElements&&(Ce.tagNameCheck instanceof RegExp&&T(Ce.tagNameCheck,n)||Ce.tagNameCheck instanceof Function&&Ce.tagNameCheck(n))))return!1}else if(Je[t]);else if(T(xe,y(n,be,"")));else if("src"!==t&&"xlink:href"!==t&&"href"!==t||"script"===e||0!==w(n,"data:")||!Qe[e]){if(Le&&!T(Ee,y(n,be,"")));else if(n)return!1}else;return!0},Ct=function(e){return"annotation-xml"!==e&&v(e,Te)},At=function(e){St(ge.beforeSanitizeAttributes,e,null);const{attributes:t}=e;if(!t||xt(e))return;const n={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:Ne,forceKeepAttr:void 0};let o=t.length;for(;o--;){const r=t[o],{name:a,namespaceURI:s,value:l}=r,c=dt(a);let u="value"===a?l:E(l);if(n.attrName=c,n.attrValue=u,n.keepAttr=!0,n.forceKeepAttr=void 0,St(ge.uponSanitizeAttribute,e,n),u=n.attrValue,!Fe||"id"!==c&&"name"!==c||(Et(a,e),u="user-content-"+u),Ue&&T(/((--!?|])>)|<\/(style|title)/i,u)){Et(a,e);continue}if(n.forceKeepAttr)continue;if(Et(a,e),!n.keepAttr)continue;if(!Ie&&T(/\/>/i,u)){Et(a,e);continue}Pe&&p([he,me,ve],(e=>{u=y(u,e," ")}));const f=dt(e.nodeName);if(Rt(f,c,u)){if(se&&"object"==typeof G&&"function"==typeof G.getAttributeType)if(s);else switch(G.getAttributeType(f,c)){case"TrustedHTML":u=se.createHTML(u);break;case"TrustedScriptURL":u=se.createScriptURL(u)}try{s?e.setAttributeNS(s,a,u):e.setAttribute(a,u),xt(e)?wt(e):d(i.removed)}catch(e){}}}St(ge.afterSanitizeAttributes,e,null)},_t=function e(t){let n=null;const i=Tt(t);for(St(ge.beforeSanitizeShadowDOM,t,null);n=i.nextNode();)St(ge.uponSanitizeShadowNode,n,null),Nt(n),At(n),n.content instanceof c&&e(n.content);St(ge.afterSanitizeShadowDOM,t,null)};return i.sanitize=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=null,o=null,r=null,s=null;if(ot=!e,ot&&(e="\x3c!--\x3e"),"string"!=typeof e&&!kt(e)){if("function"!=typeof e.toString)throw x("toString is not a function");if("string"!=typeof(e=e.toString()))throw x("dirty is not a string, aborting")}if(!i.isSupported)return e;if(He||mt(t),i.removed=[],"string"==typeof e&&(Ve=!1),Ve){if(e.nodeName){const t=dt(e.nodeName);if(!ke[t]||Ae[t])throw x("root node is forbidden and cannot be sanitized in-place")}}else if(e instanceof S)n=bt("\x3c!----\x3e"),o=n.ownerDocument.importNode(e,!0),o.nodeType===J&&"BODY"===o.nodeName||"HTML"===o.nodeName?n=o:n.appendChild(o);else{if(!$e&&!Pe&&!Oe&&-1===e.indexOf("<"))return se&&We?se.createHTML(e):e;if(n=bt(e),!n)return $e?null:We?le:""}n&&ze&&wt(n.firstChild);const l=Tt(Ve?e:n);for(;r=l.nextNode();)Nt(r),At(r),r.content instanceof c&&_t(r.content);if(Ve)return e;if($e){if(Be)for(s=ue.call(n.ownerDocument);n.firstChild;)s.appendChild(n.firstChild);else s=n;return(Ne.shadowroot||Ne.shadowrootmode)&&(s=fe.call(a,s,!0)),s}let u=Oe?n.outerHTML:n.innerHTML;return Oe&&ke["!doctype"]&&n.ownerDocument&&n.ownerDocument.doctype&&n.ownerDocument.doctype.name&&T(Y,n.ownerDocument.doctype.name)&&(u="<!DOCTYPE "+n.ownerDocument.doctype.name+">\n"+u),Pe&&p([he,me,ve],(e=>{u=y(u,e," ")})),se&&We?se.createHTML(u):u},i.setConfig=function(){mt(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}),He=!0},i.clearConfig=function(){ft=null,He=!1},i.isValidAttribute=function(e,t,n){ft||mt({});const i=dt(e),o=dt(t);return Rt(i,o,n)},i.addHook=function(e,t){"function"==typeof t&&f(ge[e],t)},i.removeHook=function(e,t){if(void 0!==t){const n=u(ge[e],t);return-1===n?void 0:g(ge[e],n,1)[0]}return d(ge[e])},i.removeHooks=function(e){ge[e]=[]},i.removeAllHooks=function(){ge={afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}},i}();return oe}));"use strict";function _last(e){return e[e.length-1]}function _debounce(e,t){return function(...n){clearTimeout(_debounce.timeout),_debounce.timeout=setTimeout((function(){e(...n)}),t)}}function _wrapText(e,t){var n,i=[],o="",r=!1;for(t=t||80,e=e.trim();""!==e;){if("\n"===(n=e[0])){if(r){i.push(o.trim()),i.push(""),o="",r=!1,e=e.substr(1);continue}r=!0,n=" "}else r=!1;o.length>=t&&" "===n?(i.push(o.trim()),o=""):o+=n,e=e.substr(1)}return""!==o&&i.push(o.trim()),i.join("\n")}function _posEqual(e,t){return e.line==t.line&&t.ch==e.ch}function _posCmp(e,t){return e.line-t.line||e.ch-t.ch}function _posInsideRange(e,t){return _posCmp(t.from,e)<0&&_posCmp(e,t.to)<0}function _posOutsideRange(e,t){return _posCmp(t.from,e)>0||_posCmp(e,t.to)>0}function _rangesOverlap(e,t){return _posCmp(e.from,t.to)<0&&_posCmp(t.from,e.to)<0}function _escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var BaseEngine;!function(e){function t(e,t,n){var i=this;i.editor=e,i.from=t,i.to=n,i.init()}function n(e,n){for(var i=e.cm.getSearchCursor(n,0,0),o=e.cm.getCursor();i.findNext();)_posInsideRange(o,i.pos)||_posEqual(o,i.pos.to)||e.cm.findMarksAt(i.pos.from).find((function(e){return void 0!==e.widget}))||new t(e,i.pos.from,i.pos.to)}t.createWidgets=function(e){n(e,Emojis.emojiRegExp),n(e,Emojis.aliasRegExp)},t.prototype.init=function(){var t=this;t.text=t.getText(),void 0===t.elem&&(t.elem=e("<img>").prop("src",Emojis.getUrl(t.getText())).addClass("emoji cm-natedit-emoji")),t.mark=t.editor.cm.markText(t.from,t.to,{replacedWith:t.elem[0],addToHistory:!1,atomic:!0,clearOnEnter:!0,clearWhenEmpty:!0,widget:t})},t.prototype.stringify=function(){return this.text},t.prototype.getText=function(){var e=this;return e.editor.cm.getRange(e.from,e.to)},t.prototype.setText=function(e){var t=this,n=e.length;t.editor.cm.replaceRange(e,t.from,t.to),t.to.ch=t.from.ch+n,t.init()},window.EmojiWidget=t}(jQuery),function(e){var t=/\[\[.*?\](\[.*?\])?\]/;function n(e,t,n){var i=this;i.editor=e,i.from=t,i.to=n,i.init()}n.createWidgets=function(e){for(var i=e.cm.getSearchCursor(t,0,0),o=e.cm.getCursor();i.findNext();)_posInsideRange(o,i.pos)||_posEqual(o,i.pos.to)||e.cm.findMarksAt(i.pos.from).find((function(e){return void 0!==e.widget}))||new n(e,i.pos.from,i.pos.to)},n.prototype.init=function(){var t=this;return t.parse().done((function(){void 0===t.elem&&(t.elem=e("<a>"+t.linkText+"</a>").addClass("cm-natedit-wiki-link").on("click",(function(e){t.editor.shell.linkDialog(t.getText())}))),t.mark=t.editor.cm.markText(t.from,t.to,{replacedWith:t.elem[0],addToHistory:!1,clearOnEnter:!0,clearWhenEmpty:!0,handleMouseEvents:!0,widget:t,selectLeft:!0,selectRight:!0})}))},n.prototype.parse=function(t){var n=this,i=e.Deferred();return void 0===t&&(t=n.getText()),t.match(/\s*\[\[(.*?)\]\[(.*?)\]\]\s*/)?(n.linkTarget=RegExp.$1,n.linkText=RegExp.$2,i.resolve(n.linkTarget,n.linkText)):t.match(/\s*\[\[(.*?)\]\]\s*/)?(n.linkTarget=RegExp.$1,n.linkTarget.match(/^\w+:\/\//)?(n.linkText=n.linkTarget,i.resolve(n.linkTarget,n.linkText)):n.editor.shell.getTopicTitle(n.linkTarget).done((function(e){n.linkText=e||n.linkTarget,i.resolve(n.linkTarget,n.linkText)}))):i.reject("text of LinkWidget does not make up a [[...]] wiki link:",t),i.promise()},n.prototype.getText=function(){var e=this;return e.editor.cm.getRange(e.from,e.to)},n.prototype.setText=function(e){var t=this,n=e.length;t.editor.cm.replaceRange(e,t.from,t.to),t.to.ch=t.from.ch+n,t.init()},n.prototype.set=function(e){var t,n=this;if(void 0!==e.url){if(void 0===e.url||""===e.url)return;void 0!==e.text&&""!==e.text?(n.linkText=e.text,n.linkTarget=e.url,t="[["+e.url+"]["+e.text+"]]"):(n.linkText=e.url,n.linkTarget=e.url,t="[["+e.url+"]]")}else if(void 0!==e.file){if(void 0===e.web||""===e.web||void 0===e.topic||""===e.topic)return;e.web===n.editor.shell.opts.web&&e.topic===n.editor.shell.opts.topic?(n.linkText=n.linkTarget="%ATTACHURLPATH%/"+e.file,t="[[%ATTACHURLPATH%/"+e.file+"]"):(n.linkText=n.linkTarget="%PUBURLPATH%/"+e.web+"/"+e.topic+"/"+e.file,t="[[%PUBURLPATH%/"+e.web+"/"+e.topic+"/"+e.file+"]"),void 0!==e.text&&""!==e.text?(n.linkText=e.text,t+="["+e.text+"]"):(n.linkText=e.file,t+="["+e.file+"]"),t+="]"}else{if(void 0===e.topic||""===e.topic)return;e.web===n.editor.shell.opts.web?(n.linkText=n.linkTarget=e.topic,t="[["+e.topic+"]"):(n.linkText=n.linkTarget=e.web+".".opts.topic,t="[["+e.web+"."+e.topic+"]"),void 0!==e.text&&""!==e.text&&(n.linkText=e.text,t+="["+e.text+"]"),t+="]"}n.setText(t)},window.LinkWidget=n}(jQuery),function(e){var t=/%IMAGE{(.*?)}%/;function n(e,t,n){var i=this;i.editor=e,i.from=t,i.to=n,i.init()}n.prototype.makeInteractive=function(){var e=this;console.log("called makeInteractive"),e.elem.resizable({aspectRatio:!0,handles:"se",autoHide:!0,stop:function(t,n){e.attrs.remove("size"),e.attrs.set("width",n.size.width),e.attrs.set("height",n.size.height),e.setText(e.toString()),e.mark.changed()}})},n.createWidgets=function(e){for(var i=e.cm.getSearchCursor(t,0,0),o=e.cm.getCursor();i.findNext();)_posInsideRange(o,i.pos)||_posEqual(o,i.pos.to)||e.cm.findMarksAt(i.pos.from).find((function(e){return void 0!==e.widget}))||new n(e,i.pos.from,i.pos.to)},n.prototype.init=function(){var t,n=this;console.log("called init"),/%IMAGE{(.*?)}%$/.test(n.getText())&&(t=RegExp.$1),console.log("text=",t),n.attrs=new foswiki.Attrs(t);let i=foswiki.normalizeWebTopicName(n.attrs.get("web")||foswiki.getPreference("WEB"),n.attrs.get("topic")||foswiki.getPreference("TOPIC"));if(n.web=i[0],n.topic=i[1],console.log("attrs="+n.attrs),void 0===n.elem){n.elem=e("<img>").appendTo("body"),n.elem.attr("src",foswiki.getPubUrlPath(n.web,n.topic,n.attrs.get("_default"))),n.elem.addClass("cm-natedit-image"),n.elem.data("ImageWidget",n),n.elem.attr("align",n.attrs.get("align")||"none"),n.elem.addClass=n.attrs.get("class")||"";let t=n.attrs.get("size"),i=n.attrs.get("width"),o=n.attrs.get("height");t&&(/^(\d+)x(\d+)$/.test(t)?(i=RegExp.$1,o=RegExp.$2):(i=t,o="auto")),n.elem.attr("width",i||"auto"),n.elem.attr("height",o||"auto"),n.elem.on("click",(function(t){var i={web:n.web,topic:n.topic,classList:n.attrs.get("class"),align:n.attrs.get("align"),type:n.attrs.get("type"),width:n.attrs.get("width"),height:n.attrs.get("height"),file:n.attrs.get("_default")};console.log("opts=",i),n.editor.shell.dialog({name:"insertimage",open:function(e){n.editor.shell.initImageDialog(e)},data:i}).done((function(t){var i=e(t);n.attrs.set("web",i.find("[name=web]").val()),n.attrs.set("topic",i.find("[name=topic]").val()),n.attrs.set("caption",i.find("[name=caption]").val()),n.attrs.set("classList",i.find("[name=classList]").val()),n.attrs.set("_default",i.find("[name=file]").val()),n.attrs.set("width",i.find("[name=width]").val()),n.attrs.set("height",i.find("[name=height]").val()),n.attrs.set("align",i.find("[name=align]:checked").val()),n.attrs.set("type",i.find("[name=type]:checked").val()),console.log("attrs=",n.attrs.values)}))}))}console.log("elem=",n.elem[0]),n.mark=n.editor.cm.markText(n.from,n.to,{replacedWith:n.elem[0],clearOnEnter:!0,clearWhenEmpty:!0,handleMouseEvents:!0,widget:n,selectLeft:!0,selectRight:!0}),n.elem.parent().imagesLoaded().done((function(){n.makeInteractive()})),n.mark.on("beforeCursorEnter",(function(){console.log("beforeCursorEnter")})),n.mark.on("clear",(function(){console.log("clear")})),n.mark.on("redraw",(function(){console.log("redraw")}))},n.prototype.toString=function(){var e="%IMAGE{"+this.attrs+"}%";return console.log("result=",e),e},n.prototype.getText=function(){var e=this;return e.editor.cm.getRange(e.from,e.to)},n.prototype.setText=function(e){var t=this,n=e.length;t.editor.cm.replaceRange(e,t.from,t.to),t.to.ch=t.from.ch+n,t.init()},window.ImageWidget=n}(jQuery),function(e){var t={className:"ui-natedit-dropdown",activeClassName:"ui-state-active"};function n(n){this.opts=e.extend({},t,n),this.init()}n.prototype.init=function(){var t=this;return t.elem=e("<div></div>").addClass(t.opts.className),t.list=e("<ul></ul>"),t.list.appendTo(t.elem),t.elem.appendTo("body"),t},n.prototype.show=function(e){void 0!==e&&this.elem.css(e),this.elem.show()},n.prototype.hide=function(){this.elem.hide()},n.prototype.isVisible=function(){return this.elem.is(":visible")},n.prototype.getSelection=function(){return this.list.find("."+this.opts.activeClassName+":first")},n.prototype.getItem=function(e){return this.list.children().eq(e)},n.prototype.select=function(e){var t=this;if(void 0!==e&&0!==e.length)return t.list.children().removeClass(t.opts.activeClassName),t.list.scrollTo(e),e.addClass(t.opts.activeClassName),e},n.prototype.set=function(e){var t=this;return t.list.html(e),t.selectFirst(),t},n.prototype.unset=function(){return this.list.empty(),this},n.prototype.selectFirst=function(){return this.select(this.getItem(0))},n.prototype.selectLast=function(){var e=this,t=e.list.children().length-1;return e.select(e.getItem(t))},n.prototype.selectPrev=function(){var e=this.getSelection().prev("li");return this.select(e)},n.prototype.selectNext=function(){var e=this.getSelection().next("li");return this.select(e)},n.prototype.callback=function(e){var t;if(void 0!==(e=e||this.getSelection())&&e.length&&"function"==typeof(t=e.data("callback")))return t();console.warn("no callback at this position. item=",e)},window.DropDownMenu=n}(jQuery),function(e){function t(){console}function n(e){var t=this;e=e||"",t.rawContent=e,t.content=e.trimStart(),t.paddingLeft=t.rawContent.length-t.content.length,t.content=t.content.trimEnd(),""===t.content?0==t.paddingLeft?t.paddingRight=0:(t.paddingRight=t.paddingLeft-1,t.paddingLeft=1):t.paddingRight=t.rawContent.length-t.content.length-t.paddingLeft,/^\*(.*)\*$/.test(t.content)?(t.isHeader=!0,t.content=RegExp.$1):t.isHeader=!1}function i(e){var t=this;e=e||"",t.prefix="",t.suffix="",t.cells=[],t.rawContent=e,t.parseCells(e).forEach((function(e){t.cells.push(new n(e))}))}function o(e){var t=this;e=e||"",t.rawContent=e,t.rows=[],t.offset=0,t.position={row:0,col:0},e.split("\n").forEach((function(e){""!==e&&t.rows.push(new i(e))}))}n.prototype.copyFrom=function(e){var t=this;return e&&(t.isHeader=e.isHeader,t.paddingLeft=e.paddingLeft,t.paddingRight=e.paddingRight,t.rawContent=e.rawContent,t.content=e.content),t},n.prototype.getAlignment=function(){var e=this;return e.paddingLeft>1?e.paddingRight>1?"center":"right":e.paddingLeft||e.paddingRight?"left":"none"},n.prototype.normalize=function(){var e=this;if(e.paddingLeft||e.paddingRight){if(e.paddingLeft<1&&(e.paddingLeft=1),e.paddingRight<1&&(e.paddingRight=1),""===e.content)return e.paddingLeft=1,void(e.paddingRight=0);switch(e.getAlignment()){case"none":case"left":e.paddingLeft=e.paddingRight=1;break;case"right":e.paddingLeft=2,e.paddingRight=1;break;case"center":e.paddingLeft=2,e.paddingRight=2}}},n.prototype.getWidth=function(){var e=this;return e.paddingLeft+e.content.length+e.paddingRight+(e.isHeader?2:0)},n.prototype.setWidth=function(e){var t=this,n=t.getAlignment(),i=t.content.length+(t.isHeader?2:0);switch(e=e||1,n){case"none":case"left":t.paddingLeft=1,t.paddingRight=e-i-1;break;case"right":t.paddingRight=1,t.paddingLeft=e-i-1;break;case"center":t.paddingRight=t.paddingLeft=Math.floor((e-i)/2),(e-i)%2&&t.paddingRight++}t.paddingLeft<1&&(t.paddingLeft=1),t.paddingRight<1&&(t.paddingRight=0)},n.prototype.toString=function(){var e=this;e.getAlignment();return" ".repeat(e.paddingLeft)+(e.isHeader?"*":"")+e.content+(e.isHeader?"*":"")+" ".repeat(e.paddingRight)},n.prototype.toHtml=function(){var e=this,t=e.getAlignment(),n=e.isHeader?"th":"td";return`<${n}${t="none"!==t&&"left"!==t?` align="${t}"`:""}>${e.content}</${n}>`},i.prototype.copyFrom=function(e){var t=this;return e&&e.cells.forEach((function(e,n){t.cells[n]&&t.cells[n].copyFrom(e)})),t},i.prototype.init=function(e,t){var i=this;e=e||0,i.cells=[];for(let o=0;o<e;o++){let e=new n;e.isHeader=t,i.cells.push(e)}return i},i.prototype.parseCells=function(e){for(var t=[],n="",i=e,o=!1;""!==i;)if(o)switch(i[0]){case"\\":i.length>=2?(n+=i.substr(0,2),i=i.substr(2)):(n+="\\",i=i.substr(1));break;case"|":t.push(n),n="",i=i.substr(1);break;default:n+=i[0],i=i.substr(1)}else{if("|"===i[0])o=!0;else{if(" "!==i[0])return[];this.prefix+=i[0]}i=i.substr(1)}return/^\s*$/.test(n)?(this.suffix=n,t):[]},i.prototype.getWidth=function(e){var t;return void 0===e?this.cells.length:(t=this.cells[e])?t.getWidth():0},i.prototype.toString=function(){var e=this;return e.cells.length?e.prefix+"|"+e.cells.map((e=>e.toString())).join("|")+"|"+e.suffix:e.rawContent},i.prototype.toHtml=function(){return"<tr>"+this.cells.map((e=>e.toHtml())).join("")+"</tr>"},o.prototype.copyFrom=function(e){var t=this;return e&&e.rows.forEach((function(e,n){t.rows[n]&&t.rows[n].copyFrom(e)})),t},o.prototype.init=function(e,t,n){var o=this;o.rows=[],e=e||0,t=t||0,n=n||0;for(let e=0;e<n;e++){let e=new i;e.init(t,!0),o.rows.push(e)}for(let n=0;n<e;n++){let e=new i;e.init(t,!1),o.rows.push(e)}return o},o.prototype.getWidth=function(e){return this.rows.map((t=>t.getWidth(e))).reduce(((e,t)=>Math.max(e,t)),0)},o.prototype.getColumn=function(e){var t=[];return this.rows.forEach((function(i){t.push(i.cells[e]||new n)})),t},o.prototype.toString=function(){return this.rows.map((e=>e.toString())).join("\n")+"\n"},o.prototype.toHtml=function(){return"<table>\n"+this.rows.map((e=>e.toHtml())).join("\n")+"\n</table>"},o.prototype.normalize=function(e){var i,o,r=this,a=r.getWidth();if(o=r.rows.map((e=>e.prefix.length)).reduce(((e,t)=>Math.min(e,t)),99999),i=" ".repeat(o),r.rows.forEach((function(e){for(e.prefix=i;e.getWidth()<a;)e.cells.push(new n("  "));e.cells.forEach((e=>e.normalize()))})),e)for(let e=0;e<a;e++){var s=r.getWidth(e);t("col=",e,"colWidth=",s),r.getColumn(e).forEach((function(e){"none"!==e.getAlignment()&&e.setWidth(s)}))}},o.prototype.setPosition=function(e,t){var n=this,i=e.line-t,o=e.ch,r=n.rows[i],a=r.getWidth(),s=0;if(void 0===r)return;let l;for(o-=r.prefix.length,l=0;l<a;l++)if((s+=r.cells[l].getWidth()+1)>=o){l++;break}return n.position={row:i,col:l-1},n.offset=t||0,n.position},o.prototype.getCell=function(e,t){return void 0===(e=this.rows[e])?void 0:e.cells[t]},o.prototype.getCurrentCell=function(){return this.getCell(this.position.row,this.position.col)},o.prototype.getCursor=function(){var e=this,t={},n=e.rows[e.position.row];if(void 0!==n){n.cells[e.position.col],t.line=e.offset+e.position.row,t.ch=n.prefix.length;for(let i=e.position.col-1;i>=0;i--)t.ch+=n.cells[i].getWidth()+1;return t.ch+=n.cells[e.position.col].paddingLeft+1,t}},o.prototype.gotoFirstCol=function(){this.position.col=0},o.prototype.gotoLastCol=function(){var e=this;e.position.col=e.rows[e.position.row].cells.length-1},o.prototype.isLastCol=function(){var e=this;return e.position.col===e.rows[e.position.row].cells.length-1},o.prototype.gotoPrevCol=function(){var e=this,t=Object.assign({},e.position);if(t.col--,t.col<0){if(t.row--,t.row<0)return;t.col=e.rows[t.row].cells.length-1}e.position=t},o.prototype.gotoNextCol=function(){var e=this,t=Object.assign({},e.position);t.col++,void 0===e.rows[t.row].cells[t.col]&&(t.row++,t.col=0,t.row>=e.rows.length)||(e.position=t)},o.prototype.gotoPrevRow=function(){pos=this.position,pos.row--,pos.row<0||(this.position=pos)},o.prototype.gotoNextRow=function(){var e=this;pos=e.position,pos.row++,void 0!==e.rows[pos.row]&&(e.position=pos)},o.prototype.moveRowUp=function(e){var t=this;return void 0===e&&(e=t.position.row),!(e<=0)&&(t.rows[e-1]=t.rows.splice(e,1,t.rows[e-1])[0],!0)},o.prototype.moveRowDown=function(e){var t=this;return void 0===e&&(e=t.position.row),!(e>=t.rows.length-1)&&(t.rows[e+1]=t.rows.splice(e,1,t.rows[e+1])[0],!0)},o.prototype.moveColumnLeft=function(e){return void 0===e&&(e=this.position.col),!(e<=0)&&(this.rows.forEach((function(t){t.cells[e-1]=t.cells.splice(e,1,t.cells[e-1])[0]})),!0)},o.prototype.moveColumnRight=function(e){var t=this;return void 0===e&&(e=t.position.col),!(e>=t.getWidth()-1)&&(t.rows.forEach((function(t){t.cells[e+1]=t.cells.splice(e,1,t.cells[e+1])[0]})),!0)},o.prototype.insertColumn=function(e){var t=this;void 0===e&&(e=t.position.col),e<0||e>t.getWidth()||t.rows.forEach((function(t){t.cells.splice(e,0,new n("  "))}))},o.prototype.deleteColumn=function(e){var t=this;return void 0===e&&(e=t.position.col),!(e<0||e>t.getWidth())&&(t.rows.forEach((function(t){t.cells.splice(e,1)})),t.position.col>=t.getWidth()&&t.position.col--,!0)},o.prototype.insertRowAfter=function(e){var t=this,o=new i;void 0===e&&(e=t.position.row),o.prefix=t.rows[e].prefix,o.suffix=t.rows[e].suffix;for(let e=t.getWidth();e>0;e--){let e=new n("   ");o.cells.push(e)}return t.rows.splice(t.position.row+1,0,o),o},o.prototype.deleteRow=function(e){var t=this;void 0===e&&(e=t.position.row),t.rows.splice(e,1),t.position.row>=t.rows.length&&t.position.row--},o.isInTable=function(e){if(e){return new i(e).cells.length>0}return!1},o.create=function(e){var t=(new o).init(e.rows,e.cols,e.heads).copyFrom(e.init);return t.rows.forEach((function(e,t){e.cells.forEach((function(e,t){""===e.content&&(e.content=e.isHeader?"header":"data",e.paddingLeft=e.paddingRight=1)}))})),t},e.TableCell=n,e.TableRow=i,e.Table=o}(foswiki,jQuery),function(e,t){const n=/^\s*\"(.*?)\"\s*(.*?)$/,i=/^\s*([#a-z0-9_]+)\s*=\s*\"(.*?)\"\s*(.*?)$/;function o(){console}function r(e){o("called new from",e),this.parse(e)}r.prototype.parse=function(e){var t,r=!0,a=0;for(o("called parse() for ",e),this.values={},this.values._raw=e||"",this.values._default="";""!==e&&(o("...string='"+e+"'"),!(++a>1e5));)if(r&&(t=e.match(n)))this.values._default=t[1],o("... adding _default=",t[1]),e=t[2],r=!1;else if(t=e.match(i))o("... adding "+t[1]+"="+t[2]),this.values[t[1]]=t[2],e=t[3];else if(/\S/.test(e)){o("...breaking at string",e);break}o("... done")},r.prototype.isEmpty=function(){return t.isEmptyObject(this.values)},r.prototype.set=function(e,t){this.values[e]=t},r.prototype.get=function(e){return e=e||"_default",this.values[e]},r.prototype.keys=function(){return Object.keys(this.values).filter((e=>"_raw"!==e))},r.prototype.remove=function(e){var t=this.values[e];return delete this.values[e],t},r.prototype.toString=function(){var e=[],t=this;return Object.keys(t.values).sort().forEach((function(n){"_default"===n?e.push(`"${t.values[n]}"`):"_raw"!==n&&e.push(`${n}="${t.values[n]}"`)})),e.join(" ")},e.Attrs=r}(foswiki,jQuery),function(e){var t={debug:!1,blockUnload:!0,purifyInput:!1,purify:{ADD_ATTR:["contenteditable"],ADD_TAGS:["verbatim","literal","sticky","nop","noautolink","dirtyarea","label"],FORBID_ATTR:[],FORBID_TAGS:["font"]}},n=function(n,i){var o=this;o.elem=e(n),o.editCaptcha=e("#editcaptcha"),o.origDocumentTitle=document.title,o.referrer=document.referrer,o.topicTitleCache={},o.opts=e.extend({},t,{web:foswiki.getPreference("WEB"),topic:foswiki.getPreference("TOPIC"),saveUrl:foswiki.getScriptUrl("rest","NatEditPlugin","save"),purifyInput:foswiki.getPreference("NatEditPlugin").purifyInput,purify:foswiki.getPreference("NatEditPlugin").purify,debug:foswiki.getPreference("NatEditPlugin").debug},i,o.elem.data());for(const e in o.opts.purify)"string"==typeof o.opts.purify[e]&&(o.opts.purify[e]=o.opts.purify[e].split(/\s*,\s*/));foswiki.eventClient&&e("<input />").attr({type:"hidden",name:"clientId",value:foswiki.eventClient.id}).prependTo(o.elem),o.isBlockedUnload=!1,o.opts.blockUnload&&(o.isBlockedUnload=!0,o.log("adding unload handler"),e(window).on("beforeunload",(function(e){if(o.log("got beforeunload event. isBlockedUnload=",o.isBlockedUnload,"opts=",o.opts.blockUnload),o.isBlockedUnload&&o.hasChanged())return e.preventDefault(),"Are you sure?"}))),o.elem.on("reset",(function(){o.editors().each((function(){this.setValue("")}))})),o.elem.on("submit",(function(){window.setTimeout((function(){o.documentTitle()}),1e3)})),o.elem.find("input[name='TopicTitle']:eq(1)").parents(".foswikiFormStep").remove(),o.elem.find("input[name='Summary']:eq(1)").parents(".foswikiFormStep").remove(),o.elem.find(".ui-natedit-save").on("click",(function(){return o.submit(),!1})),o.elem.find(".ui-natedit-checkpoint").on("click",(function(t){var n=e(t.currentTarget).attr("href").replace(/^#/,"");return o.log("clicked checkpoint"),o.isBlockedUnload=!1,o.save(n),!1})),o.elem.find(".ui-natedit-preview").on("click",(function(){return o.log("clicked preview"),o.preview(),!1})),o.elem.find(".ui-natedit-cancel").on("click",(function(){return o.log("clicked cancel"),o.cancel(),!1})),o.elem.find(".ui-natedit-replaceform").on("click",(function(){return o.log("clicked replaceform"),o.beforeSubmit("replaceform").then((function(){o.isBlockedUnload=!1,o.elem.trigger("submit")})),!1})),o.elem.find(".ui-natedit-addform").on("click",(function(){return o.log("clicked addform"),o.beforeSubmit("addform").then((function(){o.isBlockedUnload=!1,o.elem.trigger("submit")})),!1})),o.elem.validate({meta:"validate",ignore:"div, .foswikiIgnoreValidation",onsubmit:!1,invalidHandler:function(t,n){n.numberOfInvalids()?(o.documentTitle(),e.unblockUI(),o.showMessage("error",e.i18n("One or more fields have not been filled correctly")),e.each(n.errorList,(function(){var t=e(this.element),n=t.parents(".jqTabPane:first").data("tabPane");t.parents(".jqTab").each((function(){var t=e(this).attr("id");n.getNaviOfTab("#"+t).addClass("error")}))}))):o.hideMessages()},ignoreTitle:!0,errorPlacement:function(t,n){n.is("[type=checkbox],[type=radio]")?e("<td>").appendTo(n.parents("tr:first")).append(t):t.insertAfter(n)}}),o.opts.purifyInput&&(e.validator.addMethod("pure",(function(e,t,n){return o.log("checking if element is pure",t),DOMPurify.sanitize(e),0===DOMPurify.removed.length}),"Security warning: input contains dangerous content."),e.validator.addClassRules("pure",{pure:!0}),o.elem.find("input[type=text], input[type=password], input[type=search], input[type=email], input[type=url], textarea:not(.natedit)").addClass("pure"))};n.prototype.editors=function(){return this.elem.find(".natedit").map((function(){return e(this).data("natedit")}))},n.prototype.log=function(){var t;console&&this.opts.debug&&((t=e.makeArray(arguments)).unshift("NATEDIT-FM: "),console&&console.log.apply(console,t))},n.prototype.blockHistory=function(){window.history.replaceState(null,"[blocked history entry]",this.referrer)},n.prototype.getTopicTitle=function(t){var n,i=this,o=e.Deferred();return t=foswiki.normalizeWebTopicName(i.opts.web,t).join("."),(n=i.topicTitleCache[t])?o.resolve(n):e.get(foswiki.getScriptUrl("rest","NatEditPlugin","topicTitle"),{topic:i.opts.web+"."+i.opts.topic,location:t}).done((function(e){i.topicTitleCache[t]=e,o.resolve(e)})).fail((function(){o.reject("failed to get topic title for ",t)})),o.promise()},n.prototype.hasChanged=function(){var e=!1;return this.editors().each((function(){if(e)return!1;e=this.hasChanged()})),this.log("called hasChanged=",e),e},n.prototype.documentTitle=function(e){document.title=e||this.origDocumentTitle},n.prototype.submit=function(){var e=this;return e.exit().then((function(){e.elem.trigger("submit")}))},n.prototype.exit=function(){var t=this,n=e.Deferred();return t.log("called exit"),t.checkCaptcha().then((function(){t.hideMessages(),t.elem.validate().form()?(t.isBlockedUnload=!1,t.beforeSubmit("save").then((function(){t.documentTitle(e.i18n("Saving ...")),t.blockHistory(),e.blockUI({message:"<h1> "+e.i18n("Saving ...")+"</h1>"}),n.resolve()})).fail((function(i,o){o=o||"",t.showMessage("error",e.i18n(i),e.i18n(o)),n.reject()}))):n.reject()})).fail((function(){n.reject()})),n.promise()},n.prototype.save=function(t){var n=this;t=t||"checkpoint",n.log("called save action=",t),n.checkCaptcha().then((function(){var i=n.opts.topic;n.hideMessages(),n.elem.validate().form()&&n.beforeSubmit(t).then((function(){i.match(/AUTOINC|XXXXXXXXXX/)?(e.blockUI({message:"<h1>"+e.i18n("Saving ...")+"</h1>"}),n.elem.trigger("submit")):n.elem.ajaxSubmit({url:n.opts.saveUrl,beforeSubmit:function(){n.hideMessages(),n.documentTitle(e.i18n("Saving ...")),e.blockUI({message:"<h1>"+e.i18n("Saving ...")+"</h1>"})},error:function(e,t){var i=n.extractErrorMessage(e.responseText||t);n.showMessage("error",i)},complete:function(t){var i=t.getResponseHeader("X-Foswiki-Validation");i&&e("input[name='validation_key']").each((function(){e(this).val("?"+i)})),e(".natEditTitleStatus").fadeOut(),n.documentTitle(),e.unblockUI()}})})).fail((function(t,i){i=i||"",n.showMessage("error",e.i18n(t),e.i18n(i))}))}))},n.prototype.extractErrorMessage=function(t){return t&&t.match(/^<!DOCTYPE/)&&(t=e(t).find(".natErrorMessage").text().replace(/\s+/g," ").replace(/^\s+/,"")||""),"error"===t&&(t="Error: save failed. Please save your content locally and reload this page."),t},n.prototype.cancel=function(){var t=this;t.hideMessages(),t.beforeSubmit("cancel").then((function(){t.isBlockedUnload=!1,t.documentTitle(e.i18n("Quitting ...")),t.blockHistory(),e.blockUI({message:"<h1> "+e.i18n("Quitting ...")+"</h1>"}),t.elem.trigger("submit")}))},n.prototype.preview=function(){var t=this;t.elem.validate().form()&&t.beforeSubmit("preview").then((function(){t.elem.ajaxSubmit({url:t.opts.saveUrl,beforeSerialize:function(){t.elem.find("input[name=redirectto]").prop("disabled",!0)},beforeSubmit:function(){t.hideMessages(),e.blockUI({message:"<h1>"+e.i18n("Loading preview ...")+"</h1>"})},error:function(n,i){var o=t.extractErrorMessage(n.responseText||i);t.documentTitle(),e.unblockUI(),t.showMessage("error",o)},success:function(n){var i=e(window),o=Math.round(parseInt(.6*i.height(),10)),r=Math.round(parseInt(.6*i.width(),10));t.documentTitle(),e.unblockUI(),r<640&&(r=640),n=n.replace(/%width%/g,r).replace(/%height%/g,o),e("body").append(n)},complete:function(){t.elem.find("input[name=redirectto]").prop("disabled",!1)}})})).fail((function(n,i){i=i||"",t.showMessage("error",e.i18n(n),e.i18n(i))}))},n.prototype.checkCaptcha=function(){var t,n=this,i=e.Deferred();return n.log("called checkCaptcha"),n.editCaptcha.length?((t=n.editCaptcha.dialog("option","buttons"))[0].click=function(){n.editCaptcha.find(".jqCaptcha").data("captcha").validate()?(n.editCaptcha.dialog("close"),i.resolve()):i.reject()},n.editCaptcha.dialog("option","buttons",t).dialog("open")):i.resolve(),i.promise()},n.prototype.beforeSubmit=function(t){var n=this,i="foobar",o=e.Deferred(),r=[];function a(){return n.elem.find("input[name=topicparent]").each((function(){var t=e(this);""===t.val()&&t.val("none")})),"save"===t?i="Save":"cancel"===t&&(i="Cancel"),"addform"===t&&n.elem.find("input[name='submitChangeForm']").val(t),n.elem.find("input[name='action_preview']").val(""),n.elem.find("input[name='action_save']").val(""),n.elem.find("input[name='action_checkpoint']").val(""),n.elem.find("input[name='action_addform']").val(""),n.elem.find("input[name='action_replaceform']").val(""),n.elem.find("input[name='action_cancel']").val(""),n.elem.find("input[name='action_"+t+"']").val(i),"undefined"!=typeof StrikeOne&&StrikeOne.submit(n.elem[0]),n.elem.trigger("beforeSubmit.natedit",{editor:n,action:t}),n.editors().each((function(){r.push(this.beforeSubmit(t))})),e.when.apply(e,r)}return!n.opts.purifyInput||void 0!==t&&"save"!==t&&"checkpoint"!==t&&"preview"!==t?a():n.isPure().then((function(){return a()}),(function(e){return n.log("not pure"),o.reject("Input contains dangerous content:<ul class='foswikiNoIndent'><li>"+e.join("</li><li>")+"</li></ul>","Security warning")}))},n.prototype.sanitize=function(e){var t,n=[];return""===e?"":(t=e.replace(/<verbatim[^>]*>.*?<\/verbatim>/gms,(function(e,t){return n.push({text:e,offset:t}),""})),t=DOMPurify.sanitize(t,this.opts.purify),n.forEach((function(e){t=[t.slice(0,e.offset),e.text,t.slice(e.offset)].join("")})),t)},n.prototype.isPure=function(){var t=this,n=[];return t.log("called isPure"),t.editors().each((function(){n.push(this.getContent().then((function(n){var i=e.Deferred();return t.sanitize("x"+n),isPure=0===DOMPurify.removed.length,isPure?i.resolve():(t.logInsecureTags(),i.reject(t.getSecurityReport())),i})))})),e.when.apply(e,n)},n.prototype.purify=function(){var t=this,n=[];return t.log("called purify"),t.editors().each((function(){var e=this;n.push(e.getContent().then((function(n){var i=t.sanitize(n);return t.logInsecureTags(),e.setContent(i)})))})),e.when.apply(e,n)},n.prototype.logInsecureTags=function(){var e=this.getSecurityReport();e.length&&console.error("NATEDIT:"+e.join("\n"))},n.prototype.getSecurityReport=function(){var e=DOMPurify.removed,t=[];return e&&e.length&&e.forEach((function(e,n){void 0!==e.element?t.push("Invalid element "+e.element.nodeName.toLowerCase()):t.push("Invalid attribute "+e.attribute.name+" in "+e.from.nodeName.toLowerCase())})),t},n.prototype.showMessage=function(t,n,i){e.pnotify({title:i,text:n,hide:"error"!==t,type:t,sticker:!1,closer_hover:!1,delay:"error"===t?8e3:1e3})},n.prototype.hideMessages=function(){this.elem.find(".jqTabGroup a.error, input.error").removeClass("error"),this.elem.find("label.error").hide(),e.pnotify_remove_all()},e.fn.formManager=function(t){return this.each((function(){e.data(this,"formManager")||e.data(this,"formManager",new n(this,t))}))},e((function(){e(".EditForm").livequery((function(){e(this).formManager()}))}))}(jQuery),function(e){var t=!1;e.NatEditor=function(t,n){var i=this;i.txtarea=e(t),i.form=e(t.form),i.formManager=i.form.formManager().data("formManager"),i.opts=e.extend({name:i.txtarea.attr("name")},n,i.txtarea.data()),i.id=foswiki.getUniqueID(),i.isBlockedUnload=!1,i.referrer=document.referrer,i.topicTitleCache={},i.engines={},i.log("creating new natedit",i.opts),i.container=i.txtarea.wrap('<div class="ui-natedit"></div>').parent(),i.container.attr("id",i.id),i.container.data("natedit",i),i.textFormat=e(`<input type='hidden' name='_text_format_${i.opts.name}' />`).prependTo(i.form),i.opts.hidden||i.txtarea.is(".foswikiHidden")?(i.log("not creating engine for hidden editor"),i.container.addClass("foswikiHidden"),i.createEngine().then((function(e){return i.attachEngine(e)})).then((function(){i.txtarea.trigger("inited"),i.isInited=!0,i.initGui(),i.container.css("opacity",1)}))):(i.txtarea.addClass("ui-widget"),i.container.css("opacity",0),e.when(i.preloadTemplate(i.opts.toolbarTemplate,i.opts.toolbar),i.createEngine()).then((function(e,t){return i.attachEngine(t)})).then((function(){i.txtarea.trigger("inited"),i.isInited=!0,i.initGui(),i.container.css("opacity",1)}))),i.txtarea.on("reset",(function(){i.setValue("")}))},e.NatEditor.version="",e.NatEditor.prototype.log=function(){var t,n=this.id;n=n.substring(n.length-4,n.length),console&&this.opts.debug&&((t=e.makeArray(arguments)).unshift("NATEDIT ("+n+"): "),console&&console.log.apply(console,t))},e.NatEditor.prototype.initAutoExpand=function(){var t,n=this;n.helper=e('<textarea tabindex="-1" class="ui-natedit-auto-expand-helper" />').appendTo(n.container),t={fontFamily:n.txtarea.css("fontFamily")||"",fontSize:n.txtarea.css("fontSize")||"",fontWeight:n.txtarea.css("fontWeight")||"",fontStyle:n.txtarea.css("fontStyle")||"",fontStretch:n.txtarea.css("fontStretch")||"",fontVariant:n.txtarea.css("fontVariant")||"",letterSpacing:n.txtarea.css("letterSpacing")||"",textTransform:n.txtarea.css("textTransform")||"",textIndent:n.txtarea.css("textIndent")||"",wordSpacing:n.txtarea.css("wordSpacing")||"",lineHeight:n.txtarea.css("lineHeight")||"",padding:n.txtarea.css("padding")||"",textWrap:"unrestricted"},n.helper.css(t),n.engine.on("keyup",(function(){n.autoResize()})),e(window).on("resize.natedit",(function(){n.autoResize()}))},e.NatEditor.prototype.createEngine=function(t){var n,i=this,o=e.Deferred();return t=t||i.opts.engine||"CodemirrorEngine",i.log("creating engine ",t),i.engines[t]?o.resolve(i.engines[t]):e.NatEditor.factory[t]?(i.engines[t]=e.NatEditor.factory[t].createEngine(i),o.resolve(i.engines[t])):(n=i.opts.pubUrl+"/"+i.opts.systemWeb+"/NatEditPlugin/build/"+t+".js",i.getScript(n).then((function(){e.NatEditor.factory[t]?(i.engines[t]=e.NatEditor.factory[t].createEngine(i),o.resolve(i.engines[t])):(console&&console.error("failed to create edit engine '"+t+"'"),o.reject("failed to create engine",t))}))),o.promise()},e.NatEditor.prototype.attachEngine=function(e){return this.log("called attachEngine",e.id),this.engine=e,e.init().then((function(){e.initGui()}))},e.NatEditor.prototype.getTopicTitle=function(t){var n,i=this,o=e.Deferred();return t=foswiki.normalizeWebTopicName(i.opts.web,t).join("."),(n=i.topicTitleCache[t])?o.resolve(n):e.get(foswiki.getScriptUrl("rest","NatEditPlugin","topicTitle"),{topic:i.opts.web+"."+i.opts.topic,location:t}).then((function(e){i.topicTitleCache[t]=e,o.resolve(e)})).fail((function(){o.reject("failed to get topic title for ",t)})),o.promise()},e.NatEditor.prototype.getScript=function(t){var n,i=e.Deferred();return(n=document.createElement("script")).async=!0,n.src=t+`?version=${e.NatEditor.version}`,n.addEventListener("load",(function(){i.resolve()})),n.addEventListener("error",(function(){i.reject("Error loading script "+t)})),n.addEventListener("abort",(function(){i.reject("Script loading aborted.")})),document.head.appendChild(n),i.promise()},e.NatEditor.prototype.initGui=function(){var e=this;e.log("called initGui"),e.origValue=e.getValue(),e.initToolbar(),foswiki.getPreference("NatEditPlugin").FarbtasticEnabled&&e.container.addClass("ui-natedit-colorpicker-enabled"),e.dropdown=new DropDownMenu,e.opts.autoResize&&(e.opts.autoMaxExpand=!1,e.opts.resizable=!1),e.opts.autoMaxExpand&&(e.txtarea.addClass("ui-natedit-autoexpand"),e.autoMaxExpand(),e.txtarea.parents(".jqTabContents:first").addClass("jqTabDisableMaxExpand").height("auto")),e.opts.autoResize&&(e.initAutoExpand(),e.autoResize())},e.NatEditor.prototype.initToolbar=function(){var t=this;void 0===t.toolbar&&void 0!==e.templates[t.opts.toolbar]&&(t.toolbar=e(e.templates[t.opts.toolbar].render({web:t.opts.web,topic:t.opts.topic})),t.opts.showFullscreen?t.toolbar.find(".ui-natedit-fullscreen-button").show():t.toolbar.find(".ui-natedit-fullscreen-button").hide(),t.opts.showToolbar||t.toolbar.hide(),t.container.prepend(t.toolbar),t.toolbar.find(".ui-natedit-buttons").buttonset({onlyVisible:!1}).on("click",(function(n){return t.handleToolbarAction(n,e(n.target).closest("a:not(.ui-natedit-menu-button)")),!1})),t.toolbar.find(".ui-natedit-button").button({onlyVisible:!1}).on("click",(function(n){return t.handleToolbarAction(n,e(this)),!1})),t.toolbar.find(".ui-natedit-menu-button").not(".ui-button").button().end().button("option",{icon:"ui-icon-triangle-1-s",iconPosition:"end"}).on("mousedown",(function(){var n=e(this),i=void 0===n.data("menu")?n.next():e(t.container.find(n.data("menu"))),o=i.data("state")||!1;return i.data("menu-button",this),t.hideMenus(),o?n.removeClass("ui-state-highlight"):(n.addClass("ui-state-highlight"),i.show().position({my:"left top",at:"left bottom+10",of:n}),i.data("state",!0)),!1})).on("click",(function(){return!1})),t.toolbar.find(".ui-natedit-menu").each((function(){var n=e(this),i=!1;n.menu().on("menuselect",(function(e,o){e.target=n.data("menu-button"),i&&(t.hideMenus(),t.handleToolbarAction(e,o.item.children("a:first")))})).children().on("mouseup",(function(e){i=!0,n.menu("select",e),i=!1})).on("click",(function(){return!1}))})),e(t.container).on("click",(function(){t.hideMenus()})),t.engine.on("click",(function(){t.hideMenus()})),t.opts.autoHideToolbar&&(t.toolbar.hide(),t.engine.on("focus",(function(){window.setTimeout((function(){t.showToolbar()}))})).on("blur",(function(){window.setTimeout((function(){t.hideToolbar()}))}))),e(window).trigger("resize"))},e.NatEditor.prototype.showToolbar=function(){var t=this;t.toolbar&&t.toolbar.slideDown({duration:200,easing:"easeInQuad",complete:function(){t.opts.autoMaxExpand&&e(window).trigger("resize")}})},e.NatEditor.prototype.hideToolbar=function(){var t=this;t.toolbar&&t.toolbar.slideUp({duration:200,easing:"easeOutQuad",complete:function(){t.opts.autoMaxExpand&&e(window).trigger("resize")}})},e.NatEditor.prototype.submit=function(){this.formManager.submit()},e.NatEditor.prototype.beforeSubmit=function(t){var n=this,i=e.Deferred();return n.log("called beforeSubmit("+t+")"),n.origValue=n.getValue(),n.engine.beforeSubmit(t)||i.resolve().promise()},e.NatEditor.prototype.handleToolbarAction=function(e,t){var n,i,o=this,r=function(){},a=function(){},s=function(){},l=function(){return{web:o.opts.web,topic:o.opts.topic,selection:o.engine.getSelection()}};if(void 0!==t&&0!==t.length&&void 0!==(n=o.engine.handleToolbarAction(t))&&(void 0!==n.markup&&(n.value=o.opts[n.markup]),void 0!==n.value&&("line"===n.type?o.engine.insertLineTag(n.value):o.engine.insertTag(n.value)),void 0!==n.dialog&&(void 0!==n.okayHandler&&"function"==typeof o[n.okayHandler]&&(r=o[n.okayHandler]),void 0!==n.cancelHandler&&"function"==typeof o[n.cancelHandler]&&(a=o[n.cancelHandler]),void 0!==n.openHandler&&"function"==typeof o[n.openHandler]&&(s=o[n.openHandler]),void 0!==n.optsHandler&&"function"==typeof o[n.optsHandler]&&(l=o[n.optsHandler]),i=l.call(o),o.dialog({name:n.dialog,open:function(e){s.call(o,e)},data:i,modal:n.modal,okayText:n.okayText,cancelText:n.cancelText}).then((function(e){r.call(o,e,i)}),(function(e){a.call(o,e)}))),void 0!==n.handler)){if("function"==typeof o.engine[n.handler])return void o.engine[n.handler].call(o.engine,e,t);if("function"==typeof o[n.handler])return void o[n.handler].call(o,e,t)}},e.NatEditor.prototype.hideMenus=function(){this.container.find(".ui-natedit-menu").each((function(){var t=e(this);e(t.data("menu-button")).removeClass("ui-state-highlight"),t.hide().data("state",!1)}))},e.NatEditor.prototype.setValue=function(e){var t=this;t.engine&&(t.origValue=e,t.isInited?t.engine.setValue(e):t.txtarea.one("inited",(function(){t.engine.setValue(e)})))},e.NatEditor.prototype.getValue=function(){var e=this;return e.log("called getValue()"),e.engine?e.engine.getValue():(e.log("no engine, using txtarea"),e.txtarea.val())},e.NatEditor.prototype.getContent=function(){var t=this,n=e.Deferred();return t.log("called getContent()"),t.engine?t.engine.getContent():(t.log("no engine, using txtarea"),n.resolve(t.txtarea.val()).promise())},e.NatEditor.prototype.setContent=function(e){var t=this;return t.log("called setContent()"),t.engine?t.engine.setContent(e):(t.log("no engine, using txtarea"),dfd.resolve(t.txtarea.val(e)).promise())},e.NatEditor.prototype.updateContent=function(){return this.engine.updateContent()},e.NatEditor.prototype.setTextFormat=function(e){return this.textFormat.val(e)},e.NatEditor.prototype.getTextFormat=function(){return this.textFormat.val()},e.NatEditor.prototype.handleApplyColor=function(e,t){this.engine.applyColor(t.data("color"))},e.NatEditor.prototype.handleRemoveFormat=function(){this.engine.removeFormat()},e.NatEditor.prototype.handleEscapeTML=function(){var e=this,t=e.engine.getSelection()||"";t=e.escapeTML(t),e.engine.remove(),e.engine.insert(t)},e.NatEditor.prototype.handleUnescapeTML=function(){var e=this,t=e.engine.getSelection()||"";t=e.unescapeTML(t),e.engine.remove(),e.engine.insert(t)},e.NatEditor.prototype.handleFullscreen=function(){var e=this;e.container.toggleClass("ui-natedit-fullscreen"),e.engine.toggleFullscreen(),e.engine.focus()},e.NatEditor.prototype.escapeTML=function(e){var t=e;return t=(t=(t=t.replace(/\$/g,"$dollar")).replace(/%/g,"$percnt")).replace(/"/g,'\\"')},e.NatEditor.prototype.unescapeTML=function(e){var t=e;return t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/\$nop/g,"")).replace(/\\"/g,'"')).replace(/\$perce?nt/g,"%")).replace(/\$quot/g,'"')).replace(/\$comma/g,",")).replace(/\$lt/g,"<")).replace(/\$gt/g,">")).replace(/\$amp/g,"&")).replace(/\$dollar/g,"$")},e.NatEditor.prototype.autoMaxExpand=function(){var t=this;t.log("called autoMaxExpand"),t.fixHeight(),e(window).on("resize.natedit",(function(){t.fixHeight()}))},e.NatEditor.prototype.fixHeight=function(){var t,n=this,i=n.engine.getWrapperElement(),o=n.form.find(".natEditBottomBar");i&&i.length&&(t=(o.length?o.position().top:e(window).height()||window.innerHeight)-i.position().top-(i.outerHeight(!0)-i.height())-(n.container.is(".ui-natedit-fullscreen")?0:n.container.outerHeight(!0)-n.container.height())-2,n.opts.minHeight&&t<n.opts.minHeight&&(t=n.opts.minHeight),t<0||i.is(":visible")&&n.setSize(void 0,t))},e.NatEditor.prototype.setSize=function(e,t){this.engine&&this.engine.setSize(e,t)},e.NatEditor.prototype.getSize=function(){return this.engine.getSize()},e.NatEditor.prototype.autoResize=function(){var e,t,n,i=this;e=new Date,i._time&&e.getTime()-i._time.getTime()<100||(i._time=e,window.setTimeout((function(){var e=i.getSize(),o=Math.round(e.height);t=i.getValue(),i.log("oldHeight=",o),t!==i._lastText&&(i._lastText=t,t=i.htmlEntities(t),i.helper.width(e.width).val(t),i.helper.scrollTop(9e4),n=i.helper.scrollTop()+25,i.opts.minHeight&&n<i.opts.minHeight&&(n=i.opts.minHeight),i.opts.maxHeight&&n>i.opts.maxHeight?(n=i.opts.maxHeight,i.txtarea.css("overflow-y","scroll")):i.txtarea.css("overflow-y","hidden"),o!==(n=Math.round(n))&&(i.log("setting height=",n),i.setSize(void 0,n)))})))},e.NatEditor.prototype.htmlEntities=function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};for(const n in t)e=e.replace(new RegExp(n,"g"),t[n]);return e},e.NatEditor.prototype.preloadTemplate=function(t,n){var i;return n=n||t,i=foswiki.getScriptUrl("rest","JQueryPlugin","tmpl",{topic:this.opts.web+"."+this.opts.topic,load:t,name:n}),e.loadTemplate({url:i,name:n})},e.NatEditor.prototype.dialog=function(t){var n=this,i={url:void 0,title:e.i18n("Confirmation required"),okayText:e.i18n("OK"),okayIcon:"ui-icon-check",cancelText:e.i18n("Cancel"),cancelIcon:"ui-icon-cancel",width:"auto",modal:!0,position:{my:"center",at:"center",of:window},open:function(){},data:{web:n.opts.web,topic:n.opts.topic,selection:n.engine.getSelection()}};return"string"==typeof t&&(t={data:{text:t}}),void 0===t.url&&void 0!==t.name&&(t.url=foswiki.getScriptUrl("rest","JQueryPlugin","tmpl",{topic:n.opts.web+"."+n.opts.topic,load:"editdialog",name:t.name})),void 0!==(t=e.extend({},i,t)).event&&(t.position={my:"center top",at:"left bottom+30",of:t.event.target}),n.formManager.hideMessages(),e.blockUI({message:""}),e.Deferred((function(i){e.loadTemplate({url:t.url,name:t.name}).then((function(o){e.unblockUI(),e(o.render(t.data)).dialog({buttons:[{text:t.okayText,icon:t.okayIcon,click:function(){return i.resolve(this),e(this).dialog("close"),!0}},{text:t.cancelText,icon:t.cancelIcon,click:function(){return i.reject(),e(this).dialog("close"),!1}}],open:function(){var o=e(this),r=o.data("title");void 0!==r&&o.dialog("option","title",r),o.find("input").on("keydown",(function(t){var n=e(this);n.is(".ui-autocomplete-input")&&n.data("ui-autocomplete").menu.element.is(":visible")||"Enter"===t.key&&(t.preventDefault(),i.resolve(o),o.dialog("close"))})),t.open.call(n,this,t.data)},close:function(){"pending"===i.state()&&i.reject(),e(this).dialog("destroy")},show:"fade",modal:t.modal,draggable:!0,resizable:!1,title:t.title,width:t.width,position:t.position})}),(function(t){e.unblockUI(),n.formManager.showMessage("error",t.responseText)}))})).promise()},e.NatEditor.prototype.handleSearchReplace=function(t){var n,i=this,o=e(t),r=o.find("input[name='search']").val(),a=o.find("input[name='replace']").val(),s=!!o.find("input[name='ignorecase']:checked").length;i.log("handleSearchReplace, search='"+r+" 'replace='"+a+"' ignoreCase=",s),r.length&&((n=i.engine.searchReplace(r,a,s))?i.formManager.showMessage("info",e.i18n("replaced '%count%' time(s)",{count:n})):i.formManager.showMessage("warning",e.i18n("search string '%search%' not found",{search:r})))},e.NatEditor.prototype.handleInsertTable=function(t){var n=e(t),i=n.find("input[name='rows']").val(),o=n.find("input[name='cols']").val(),r=n.find("input[name='heads']").val();return this.engine.insertTable({heads:r,rows:i,cols:o})},e.NatEditor.prototype.handleInsertLink=function(t){var n={},i=e(t).find(".jqTab.current");if(i.is(".topic"))n={web:i.find("input[name='web']").val(),topic:i.find("input[name='topic']").val(),text:i.find("input[name='linktext_topic']").val()};else if(i.is(".external"))n={url:i.find("input[name='url']").val(),text:i.find("input[name='linktext_external']").val()};else{if(!i.is(".attachment"))return;n={web:i.find("input[name='web']").val(),topic:i.find("input[name='topic']").val(),file:i.find("select[name='file']").val(),text:i.find("input[name='linktext_attachment']").val()}}return this.engine.insertLink(n)},e.NatEditor.prototype.handleInsertImage=function(t,n){var i=e(t);return(n=n||{}).web=i.find("[name=web]").val(),n.topic=i.find("[name=topic]").val(),n.caption=i.find("[name=caption]").val(),n.classList=i.find("[name=classList]").val(),n.file=i.find("[name=file]").val(),n.width=i.find("[name=width]").val(),n.height=i.find("[name=height]").val(),n.align=i.find("[name=align]:checked").val(),n.type=i.find("[name=type]:checked").val(),this.engine.insertImage(n)},e.NatEditor.prototype.handleInsertAttachment=function(t){var n=e(t);return this.engine.insertLink({web:n.find("input[name='web']").val(),topic:n.find("input[name='topic']").val(),file:n.find("select[name='file']").val(),text:n.find("input[name='linktext_attachment']").val()})},e.NatEditor.prototype.initColorDialog=function(t){var n=e(t),i=n.find("input[name='color']")[0];return this.fb=e.farbtastic(n.find(".ui-natedit-colorpicker")).setColor("#fafafa").linkTo(i),!1},e.NatEditor.prototype.parseColorCode=function(){var e=this,t=e.engine.getSelection()||"#ff0000";return{web:e.opts.web,topic:e.opts.topic,selection:t}},e.NatEditor.prototype.openDatePicker=function(){var t,n,i=this,o=i.engine.getSelection();if(""===o)n=new Date;else try{n=new Date(o)}catch(t){i.formManager.showMessage("error",e.i18n("invalid date '%date%'",{date:o}))}return void 0===i.datePicker&&(t=e('<div class="ui-natedit-datepicker"/>').css("position","absolute").appendTo(i.container).hide(),i.overlay=e("<div>").addClass("ui-widget-overlay ui-front").hide().appendTo(i.container).on("click",(function(){i.datePicker.hide(),i.overlay.hide()})),i.datePicker=t.datepicker({onSelect:function(){var e=i.datePicker.datepicker("getDate");i.datePicker.hide(),i.overlay.hide(),i.engine.remove(),i.engine.insert(i.formatDate(e))}}).draggable({handle:".ui-widget-header"}).zIndex(i.overlay.zIndex()+1)),i.overlay.show(),i.datePicker.datepicker("setDate",n),i.datePicker.show().focus().position({my:"center",at:"center",of:window}),!1},e.NatEditor.prototype.formatDate=function(e){return(e=e.toDateString().split(/ /))[2]+" "+e[1]+" "+e[3]},e.NatEditor.prototype.hasChanged=function(){var e=this;return e.log("called hasChanged"),e.origValue!==e.getValue()},e.NatEditor.prototype.handleWrapText=function(){var e=this,t=_wrapText(e.engine.getSelection()||"");e.engine.remove(),e.engine.insert(t)},e.NatEditor.prototype.handleInsertRow=function(){this.engine.insertTableRow()},e.NatEditor.prototype.handleDeleteRow=function(){this.engine.deleteTableRow()},e.NatEditor.prototype.handleInsertColumn=function(){this.engine.insertTableColumn()},e.NatEditor.prototype.handleDeleteColumn=function(){this.engine.deleteTableColumn()},e.NatEditor.prototype.handleMoveRowUp=function(){this.engine.moveTableRowUp()},e.NatEditor.prototype.handleMoveRowDown=function(){this.engine.moveTableRowDown()},e.NatEditor.prototype.handleMoveColumnLeft=function(){this.engine.moveTableColumnLeft()},e.NatEditor.prototype.handleMoveColumnRight=function(){this.engine.moveTableColumnRight()},e.NatEditor.prototype.handleInsertColorCode=function(){var e=this,t=e.fb.color;e.engine.remove(),e.engine.insert(t)},e.NatEditor.prototype.handleUndo=function(){this.engine.undo()},e.NatEditor.prototype.handleRedo=function(){this.engine.redo()},e.NatEditor.prototype.handleSwitchEditor=function(){var t=this,n="CodemirrorEngine"===t.engine.id?"TinyMCEEngine":"CodemirrorEngine",i=e.Deferred();if(t.log("called handleSwitchEditor"),t.log("current engine=",t.engine.id,"otherEngine=",n),i.promise().then((function(e){t.createEngine(n).then((function(n){t.engine.getWrapperElement().hide(),t.attachEngine(n).then((function(){t.engine.getWrapperElement().show(),t.opts.autoMaxExpand&&t.fixHeight(),t.engine.setValue(e),t.engine.focus()}))}))})),"wysiwyg"===t.engine.type){const e=t.engine.getValue();t.html2tml(e).then((function(e){i.resolve(e)}))}else{const e=t.engine.getValue();t.tml2html(e).then((function(e){i.resolve(e)}))}},e.NatEditor.prototype.tml2html=function(t){var n=foswiki.getScriptUrl("rest","NatEditPlugin","tml2html");return e.post(n,{topic:foswiki.getPreference("WEB")+"."+foswiki.getPreference("TOPIC"),t:(new Date).getTime(),text:t})},e.NatEditor.prototype.html2tml=function(t){var n=foswiki.getScriptUrl("rest","NatEditPlugin","html2tml");return e.post(n,{topic:foswiki.getPreference("WEB")+"."+foswiki.getPreference("TOPIC"),t:(new Date).getTime(),text:t})},e.NatEditor.prototype.handleSortAscending=function(){this.sortSelection("asc")},e.NatEditor.prototype.handleSortDescending=function(){this.sortSelection("desc")},e.NatEditor.prototype.sortSelection=function(t){var n,i,o,r,a,s,l,c=this,p=!0;for(n=c.engine.getSelectionLines().split(/\r?\n/),i=[],o=[],l=0;l<n.length;l++)(a=n[l]).match(/^((?: {3})+(?:[AaIi]\.|\d\.?|\*) | *\|)(.*)$/)?(s=RegExp.$1,a=RegExp.$2):s="",r=parseFloat(a),isNaN(r)&&(p=!1,r=a),a.match(/^\s*$/)?o.push({pos:l,prefix:s,value:r,line:a}):i.push({pos:l,prefix:s,line:a,value:r});i=i.sort((function(e,t){var n=e.value,i=t.value;return p?n-i:n<i?-1:n>i?1:0})),"desc"===t&&(i=i.reverse()),e.map(o,(function(e){i.splice(e.pos,0,e)})),n=[],e.map(i,(function(e){n.push(e.prefix+e.line)})),n=n.join("\n"),c.engine.remove(),c.engine.insert(n)},e.NatEditor.prototype.initLinkDialog=function(t){var n,i=this,o=e(t),r=0,a=o.find(".jqTab.current"),s=o.find(".natEditAttachmentSelector");function l(t,n){var o=s.data("selection")||"",r=s.data("filter")||".*",l=new RegExp(r,"i");t=t||a.find("input[name='web']").val(),n=n||a.find("input[name='topic']").val(),e.ajax({url:i.opts.attachmentsUrl,data:{topic:t+"."+n,_t:Date.now()},dataType:"json"}).done((function(t){var n=[];n.push("<option></option>"),e(t).each((function(e,t){l.test(t.name)&&n.push("<option"+(o===t.name?" selected":"")+">"+t.name+"</option>")})),s.html(n.join(""))}))}0===a.length&&(a=o),o.find("input[name='web']").each((function(){e(this).autocomplete({source:i.opts.webUrl})})).on("change",(function(){l()})),o.find("input[name='topic']").each((function(){e(this).autocomplete({source:function(t,o){var s=a.find("input[name='web']").val();n&&n.abort(),n=e.ajax({url:i.opts.topicUrl,data:e.extend(t,{baseweb:s}),dataType:"json",autocompleteRequest:++r,success:function(t){this.autocompleteRequest===r&&(e.each(t,(function(e,t){t.value=t.value.replace(s+".","")})),o(t))},error:function(){this.autocompleteRequest===r&&o([])}})}})})).on("change",(function(){l()})),l()},e.NatEditor.prototype.linkDialog=function(t){var n=this;"string"==typeof t&&(t=n.parseLink(t)),n.dialog({name:"insertlink",open:function(e){n.initLinkDialog(e)},data:t}).done((function(t){var i,o=e(t).find(".jqTab.current");o.is(".topic")?i={web:o.find("input[name='web']").val(),topic:o.find("input[name='topic']").val(),text:o.find("input[name='linktext_topic']").val()}:o.is(".external")?i={url:o.find("input[name='url']").val(),text:o.find("input[name='linktext_external']").val()}:o.is(".attachment")&&(i={web:o.find("input[name='web']").val(),topic:o.find("input[name='topic']").val(),file:o.find("select[name='file']").val(),text:o.find("input[name='linktext_attachment']").val()}),n.engine.insertLink(i)}),(function(e){}))},e.NatEditor.prototype.imageDialog=function(e){var t=this,n=t.parseImageSelection();t.dialog({name:"insertimage",open:function(e){t.initImageDialog(e)},data:n,event:e}).done((function(e){t.handleInsertImage(e,n)}))},e.NatEditor.prototype.initImageDialog=function(e){this.log("initImageDialog on dialog=",e),this.initLinkDialog(e)},e.NatEditor.prototype.cancelAttachmentsDialog=function(e){var t=this;t.log("cancelAttachmentsDialog on dialogElem=",e),void 0!==t.uploader?t.log("stopping uploader"):t.log("no uploader found")},e.NatEditor.prototype.parseUrl=function(e){var t={web:this.opts.web,topic:this.opts.topic};return e.match(/^(?:%ATTACHURL(?:PATH)?%\/)(.*?)$/)?(t.file=RegExp.$1,t.type="attachment"):e.match(/(?:(?:%PUBURL(?:PATH)?%|\/pub)\/)(.*)\/(.*?)\/(.*?)$/)?(t.web=RegExp.$1,t.topic=RegExp.$2,t.file=RegExp.$3,t.type="pub"):t.type="unknown",t},e.NatEditor.prototype.parseImageSelection=function(){return this.engine.getImageData()},e.NatEditor.prototype.parseLink=function(e){var t,n=this,i="(?:file|ftp|gopher|https?|irc|mailto|news|nntp|telnet|webdav|tel|sip|edit)://[^\\s]+?";if(t={selection:e,web:n.opts.web,topic:n.opts.topic,file:"",url:"",type:"topic"},void 0===e&&(e=n.engine.getSelection()),e.match(/\s*\[\[(.*?)\]\]\s*/))(e=RegExp.$1).match("^("+i+")(?:\\]\\[(.*))?$")?(t.url=RegExp.$1,t.selection=RegExp.$2||"",t.type="external"):e.match(/^(?:%ATTACHURL(?:PATH)?%\/)(.*?)(?:\]\[(.*))?$/)?(t.file=RegExp.$1,t.selection=RegExp.$2,t.type="attachment"):e.match(/^(?:%PUBURL(?:PATH)?%\/)(.*)\/(.*?)\/(.*?)(?:\]\[(.*))?$/)?(t.web=RegExp.$1,t.topic=RegExp.$2,t.file=RegExp.$3,t.selection=RegExp.$4,t.type="attachment"):e.match(/^(?:(.*)\.)?(.*?)(?:\]\[(.*))?$/)?(t.web=RegExp.$1||t.web,t.topic=RegExp.$2,t.selection=RegExp.$3||""):(t.topic=e,t.selection="");else if(e.match("^ *"+i))t.url=e,t.selection="",t.type="external";else if(e.match(/^\s*%IMAGE\{(.*?)\}%\s*$/)){let e=new foswiki.Attrs(RegExp.$1);e.keys().filter((e=>"_"!==e[0])).forEach((function(n){t[n]=e.get(n)})),t[file]=e.get("_default"),t.selection="",t.type="attachment"}else e.match(/^\s*([A-Z][^\s.]*)\.(A-Z.*?)\s*$/)&&(t.web=RegExp.$1||t.web,t.topic=RegExp.$2,t.selection="",t.type="topic");return t},e.NatEditor.prototype.handleKeyDown=function(e){var t=this;if(t.preventDefault=!1,t.dropdown.isVisible()&&("ArrowUp"===e.key?(t.dropdown.selectPrev(),t.preventDefault=!0):"ArrowDown"===e.key?(t.dropdown.selectNext(),t.preventDefault=!0):"Enter"===e.key?(t.dropdown.hide(),t.preventDefault=!0,t.dropdown.callback()):"Escape"===e.key&&(t.dropdown.hide(),t.preventDefault=!0),t.preventDefault))return e.preventDefault(),!1},e.NatEditor.prototype.handleKeyUp=function(e){var t=this;if(!t.preventDefault){var n,i=t.engine.getBeforeCursor(),o=t.engine.getAfterCursor(1),r=!1;for(const e of t.opts.completions)if(o.match(/^(\s|$)/)&&e.match.test(i)){r=!0,n=RegExp.$1,_debounce((function(){t.execCompletion(e,n)}),250)();break}r||t.dropdown.hide()}},e.NatEditor.prototype.execCompletion=function(t,n){var i=this,o=i.engine.getCursorCoords(-n.length),r=i.engine.getCaretPosition();t.search.call(i,n).then((function(a){var s=[];e.each(a,(function(o,a){s.push(e("<li>"+t.template.call(i,a)+"</li>").data("callback",(function(){var e=t.result.call(i,a),o=r.line,s=r.ch-n.length;i.engine.replace(e,{line:o,ch:s},{line:r.line,ch:r.ch})})).on("click",(function(){i.dropdown.hide(),i.dropdown.callback(e(this)),i.engine.focus()})))})),s.length?i.dropdown.set(s).show({top:o.bottom,left:o.left}):i.dropdown.hide()}))},e.NatEditor.prototype.getJSON=function(t){var n,i=this,o=e.Deferred();return void 0===i.cache&&(i.cache=new Map),(n=i.cache.get(t))?(o.resolve(n),o):(i._prevXHR&&i._prevXHR.abort(),i._prevXHR=e.getJSON(t),i._prevXHR.then((function(e){i.cache.set(t,e),i._prevXHR=null,o.resolve(e)})),o)},e.NatEditor.defaults={debug:!1,toolbarTemplate:"edittoolbar",toolbar:"edittoolbar",h1Markup:["---+!! ","%TOPIC%",""],h2Markup:["---++ ","Headline text",""],h3Markup:["---+++ ","Headline text",""],h4Markup:["---++++ ","Headline text",""],h5Markup:["---+++++ ","Headline text",""],h6Markup:["---++++++ ","Headline text",""],verbatimMarkup:["<verbatim>\n","Insert non-formatted text here","\n</verbatim>"],quoteMarkup:["<blockquote>\n","Insert quote here","\n</blockquote>"],boldMarkup:["*","Bold text","*"],italicMarkup:["_","Italic text","_"],monoMarkup:["=","Monospace text","="],underlineMarkup:["<u>","Underlined text","</u>"],strikeMarkup:["<del>","Strike through text","</del>"],superscriptMarkup:["<sup>","superscript text","</sup>"],subscriptMarkup:["<sub>","subscript text","</sub>"],colorMarkup:["%COLOR%","colored text","%ENDCOLOR%"],leftMarkup:['<p align="left">\n',"Align left","\n</p>"],centerMarkup:['<p align="center">\n',"Center text","\n</p>"],rightMarkup:['<p align="right">\n',"Align right","\n</p>"],justifyMarkup:['<p align="justify">\n',"Justify text","\n</p>"],numberedListMarkup:["   1 ","enumerated item",""],bulletListMarkup:["   * ","bullet item",""],indentMarkup:["   ","",""],outdentMarkup:["","",""],mathMarkup:['<latex title="Example">\n',"\\sum_{x=1}^{n}\\frac{1}{x}","\n</latex>"],signatureMarkup:["-- ",NaN],horizRulerMarkup:["","---","\n"],clearMarkup:["","%CLEAR%","\n"],autoHideToolbar:!1,autoMaxExpand:!1,minHeight:0,maxHeight:0,autoResize:!1,resizable:!1,engine:"raw",showToolbar:!0,showFullscreen:!0,completions:[{id:"emoji",match:/(?:(?<=[\s<>|])|^):(\*?[a-z0-9_+-]+)$/,search:function(t){var n,i=e.Deferred(),o=!1;return t.match(/^\*(.*)$/)&&(o=!0,t=RegExp.$1),t="^"+(o?".*":"")+_escapeRegExp(t)+".*",n=Emojis.search(t,{limit:20}),i.resolve(n),i.promise()},template:function(e){return`<img src="${Emojis.getUrl(e.id)}"/>&nbsp;${e.id}`},result:function(e){return`${e.id}:`}},{id:"mention",match:/(?:(?<=[\s<>|])|^)(@\*?\w+)$/,search:function(e){var t=foswiki.getScriptUrl("rest","NatEditPlugin","complete",{mode:"mention",term:encodeURIComponent(e)});return this.getJSON(t)},template:function(e){return e.title},result:function(e){return`@${e.topic}`}},{id:"topic",match:new RegExp(`\\B(\\[\\[[\\*${foswiki.RE.upper}][${foswiki.RE.alnum}\\.]*)$`),search:function(e){var t=foswiki.getScriptUrl("rest","NatEditPlugin","complete",{mode:"topic",limit:5,web:this.opts.web,term:encodeURIComponent(e)});return this.getJSON(t)},template:function(e){return e.title},result:function(e){return e.web===this.opts.web?`[[${e.topic}]]`:`[[${e.web}.${e.topic}]]`}}]},e.fn.natedit=function(n){if(!t){const n=foswiki.getPreference("NatEditPlugin");t=!0,e.NatEditor.version=n.version,e.NatEditor.defaults.debug=n.debug,e.NatEditor.defaults.web=foswiki.getPreference("WEB"),e.NatEditor.defaults.topic=foswiki.getPreference("TOPIC"),e.NatEditor.defaults.systemWeb=foswiki.getPreference("SYSTEMWEB"),e.NatEditor.defaults.pubUrl=foswiki.getPreference("PUBURL"),e.NatEditor.defaults.signatureMarkup=["-- ","[["+foswiki.getPreference("WIKIUSERNAME")+"]]"," - "+foswiki.getPreference("SERVERTIME")],e.NatEditor.defaults.engine=n.Engine,e.NatEditor.defaults.attachmentsUrl=foswiki.getScriptUrl("rest","NatEditPlugin","attachments"),e.NatEditor.defaults.webUrl=foswiki.getScriptUrl("view",e.NatEditor.defaults.systemWeb,"JQueryAjaxHelper",{section:"web",skin:"text",contenttype:"application/json"}),e.NatEditor.defaults.topicUrl=foswiki.getScriptUrl("view",e.NatEditor.defaults.systemWeb,"JQueryAjaxHelper",{section:"topic",skin:"text",contenttype:"application/json"})}var i=e.extend({},e.NatEditor.defaults,n);return this.each((function(){e.data(this,"natedit")||e.data(this,"natedit",new e.NatEditor(this,i))}))},e.NatEditor.factory={},e((function(){e(".natedit").livequery((function(){e(this).natedit()}))}))}(jQuery),function(e){var t={debug:!1,userUrl:null};function n(n,i){var o=this;o.elem=e(n),o.opts=e.extend({},t,o.elem.data(),i),o.init()}n.prototype.init=function(){var t=this;t.opts.userUrl||(t.opts.userUrl=foswiki.getScriptUrl("rest","NatEditPlugin","users")),t.log("called init opts=",t.opts),t.elem.find(".ui-natedit-details-container input").on("blur",(function(){var t=e(this);t.trigger("AddValue",t.val())})).textboxlist({onSelect:function(e){t.updateDetails(e)},onDeselect:function(e){t.updateDetails(e)},onClear:function(e){t.updateDetails(e)},onReset:function(e){t.updateDetails(e)},autocomplete:t.opts.userUrl}),t.elem.find("input[type=radio]").on("click",(function(){t.setPermissionSet(e(this).data())})),t.elem.find("input[type=radio]:checked").not(":disabled").each((function(){t.setPermissionSet(e(this).data())}))},n.prototype.log=function(){var t;console&&this.opts.debug&&((t=e.makeArray(arguments)).unshift("PERM: "),console&&console.log.apply(console,t))},n.prototype.setPermission=function(t,n){var i,o,r=this;for(i in r.elem.find(".permset_"+t).each((function(){e(this).val("undefined")})),n)n.hasOwnProperty(i)&&(o=n[i],r.log("setting ."+i+"_"+t+"="+o),r.elem.find("."+i+"_"+t).val(o))},n.prototype.showPermDetails=function(t){var n,i=this,o=[];i.elem.find(".ui-natedit-"+t+"-perms .ui-natedit-details-container").slideDown(300),i.elem.find("input[name='Local+PERMSET_"+t.toUpperCase()+"_DETAILS']").each((function(){(n=e(this).val())&&""!==n&&o.push(n)})),o=o.join(", "),i.setPermission(t,{allow:o})},n.prototype.hidePermDetails=function(e){this.elem.find(".ui-natedit-"+e+"-perms .ui-natedit-details-container").slideUp(300),this.setPermission(e)},n.prototype.updateDetails=function(t){var n=t.currentValues,i=e(t.input).data("permType");this.log("currentValues="+n.join(", ")),this.setPermission(i,{allow:n.join(", ")})},n.prototype.setPermissionSet=function(e){var t=this;"details"===e.perms?t.showPermDetails(e.permType):(t.hidePermDetails(e.permType),t.setPermission(e.permType,e.perms))},e.fn.permissionsEditor=function(t){return this.each((function(){e.data(this,"PermissionsEditor")||e.data(this,"PermissionsEditor",new n(this,t))}))},e((function(){e(".ui-natedit-permissions-form").livequery((function(){e(this).permissionsEditor()}))}))}(jQuery),function(e){var t=/_(\S+|(?:\S.*?\S))_(?=$|[\s,.;:!?)])/g,n=/\*(\S+|(?:\S.*?\S))\*(?=$|[\s,.;:!?)])/g,i=/__(\S+|(?:\S.*?\S))__(?=$|[\s,.;:!?)])/g,o=/=(\S+|(?:\S.*?\S))=(?=$|[\s,.;:!?)])/g,r=/==(\S+|(?:\S.*?\S))==(?=$|[\s,.;:!?)])/g,a=/%(AQUA|BLACK|BLUE|BROWN|GRAY|GREEN|LIME|MAROON|NAVY|OLIVE|ORANGE|PINK|PURPLE|RED|SILVER|TEAL|WHITE|YELLOW)%\s*|\s*%ENDCOLOR%/g;(BaseEngine=function(){void 0===this.opts&&(this.opts={})}).prototype.init=function(){return e.Deferred().resolve(this).promise()},BaseEngine.prototype.initGui=function(){var t=this;t.shell.opts.resizable&&t.getWrapperElement().resizable(),t.getWrapperElement().addClass("ui-natedit-widget"),e("body").on("fileuploaddrop",(function(e,t){}))},BaseEngine.prototype.getWrapperElement=function(){return e(this.shell.txtarea)},BaseEngine.prototype.focus=function(){e(this.shell.txtarea).focus()},BaseEngine.prototype.on=function(e,t){return this.getWrapperElement().on(e,t)},BaseEngine.prototype.setSize=function(e,t){var n=this.getWrapperElement();e&&n.css("width",e),t&&n.css("height",t)},BaseEngine.prototype.toggleFullscreen=function(){var t=this;t.shell.container.is(".ui-natedit-fullscreen")?(t._previousHeight=t.getWrapperElement().outerHeight(),e(window).off("resize.natedit"),t.shell.form.find(".natEditBottomBar").hide(),e("html").css("overflow-y","initial"),t.setSize(void 0,"100%")):(e("html").css("overflow-y","scroll"),t.shell.form.find(".natEditBottomBar").show(),t.setSize(void 0,t._previousHeight),t.shell.opts.autoMaxExpand&&t.shell.autoMaxExpand())},BaseEngine.prototype.getSize=function(){var e=this.getWrapperElement();return{width:e.width(),height:e.height()}},BaseEngine.prototype.beforeSubmit=function(){return e.Deferred().resolve().promise()},BaseEngine.prototype.setValue=function(e){this.getWrapperElement().val(e)},BaseEngine.prototype.getValue=function(){return this.getWrapperElement().val()},BaseEngine.prototype.replace=function(){throw"not implemented: replace()"},BaseEngine.prototype.insert=function(){throw"not implemented: insert()"},BaseEngine.prototype.remove=function(){throw"not implemented: remove()"},BaseEngine.prototype.getWordRange=function(){throw"not implemented: getWord()"},BaseEngine.prototype.getSelection=function(){throw"not implemented: getSelection()"},BaseEngine.prototype.getSelectionLines=function(){throw"not implemented: getSelectionLines()"},BaseEngine.prototype.setSelectionRange=function(){throw"not implemented: setSelectionRange()"},BaseEngine.prototype.setCaretPosition=function(){throw"not implemented: setCaretPosition()"},BaseEngine.prototype.getCaretPosition=function(){throw"not implemented: getCaretPosition()"},BaseEngine.prototype.undo=function(){throw"not implemented: undo()"},BaseEngine.prototype.hasChanged=function(){return!0},BaseEngine.prototype.redo=function(){throw"not implemented: redo()"},BaseEngine.prototype.handleToolbarAction=function(e){return e.data()},BaseEngine.prototype.insertLineTag=function(){throw"not implemented: insertLineTag()"},BaseEngine.prototype.removeFormat=function(){var e,s=this,l=s.getSelection();void 0!==l&&""!==l&&(e=l.replace(i,"$1").replace(r,"$1").replace(t,"$1").replace(n,"$1").replace(o,"$1").replace(a,""),s.remove(),s.insert(e))},BaseEngine.prototype.applyColor=function(e){var t=this.shell.opts.colorMarkup;t[0]="%"+e.toUpperCase()+"%",this.insertTag(t)},BaseEngine.prototype.insertTag=function(){throw"not implemented: insertTag()"},BaseEngine.prototype.insertTable=function(e){var t=this;cursor=t.getCaretPosition(),e.init=new foswiki.Table(t.getSelection()),t.remove(),t.insert(foswiki.Table.create(e).toString()),t.setCaretPosition(cursor)},BaseEngine.prototype.insertLink=function(t){var n,i=this;if(void 0!==t.url){if(void 0===t.url||""===t.url)return;n=void 0!==t.text&&""!==t.text?"[["+t.url+"]["+t.text+"]]":"[["+t.url+"]]"}else if(void 0!==t.file){if(void 0===t.web||""===t.web||void 0===t.topic||""===t.topic)return;n=t.web===i.shell.opts.web&&t.topic===i.shell.opts.topic?"[[%ATTACHURLPATH%/"+t.file+"]":"[[%PUBURLPATH%/"+t.web+"/"+t.topic+"/"+t.file+"]",void 0!==t.text&&""!==t.text?n+="["+t.text+"]":n+="["+t.file+"]",n+="]"}else{if(void 0===t.topic||""===t.topic)return;e.get(foswiki.getScriptUrl("rest","NatEditPlugin","topicTitle"),{topic:t.web+"."+t.topic}).done((function(e){console.log("topicTitle=",e)})),n=t.web===i.shell.opts.web?"[["+t.topic+"]":"[["+t.web+"."+t.topic+"]",void 0!==t.text&&""!==t.text&&(n+="["+t.text+"]"),n+="]"}i.remove(),i.insert(n)},BaseEngine.prototype.insertImage=function(e){var t,n=this;e.prefix=void 0===e.prefix?"":e.prefix,e.suffix=void 0===e.suffix?"":e.suffix,t=e.prefix+'%IMAGE{"'+e.file+'"',e.web===n.shell.opts.web&&e.topic===n.shell.opts.topic||(t+=' topic="',e.web!==n.shell.opts.web&&(t+=e.web+"."),t+=e.topic+'"'),e.width&&!e.height?t+=' size="'+e.width+'"':!e.width&&e.height?t+=' size="'+e.height+'"':(e.width||e.height)&&(t+=' size="'+e.width+"x"+e.height+'"'),e.align&&(t+=' align="'+e.align+'"'),e.caption&&(t+=' caption="'+e.caption+'"'),e.type&&(t+=' type="'+e.type+'"'),e.id&&(t+=' id="'+e.id+'"'),e.classList&&(t+=' class="'+e.classList+'"'),t+="}%"+e.suffix,n.remove(),n.insert(t)},BaseEngine.prototype.getCursorCoords=function(){throw"not implemented: getCursorCoords()"},BaseEngine.prototype.getBeforeCursor=function(){throw"not implemented: getBeforeCursor()"},BaseEngine.prototype.getAfterCursor=function(){throw"not implemented: getAfterCursor()"},BaseEngine.prototype.getImageData=function(t){var n,i,o,r,a=this,s=a.getSelection(),l=new RegExp("image(Simple|Float|Thumb|Frame|Plain)(_left|_right|_none)?");return t=e.extend({web:a.shell.opts.web,topic:a.shell.opts.topic},t),s.match(/^(\s*)(<img.*>)(\s*)$/)?(t.prefix=RegExp.$1,t.suffix=RegExp.$3,n=e(RegExp.$2),i=a.shell.parseUrl(n.attr("src")),t.width=n.attr("width")||t.width,t.height=n.attr("height")||t.height,t.align=n.align("align")||t.align,t.type=n.data("type"),t.caption=n.data("caption"),t.web=i.web||t.web||a.shell.opts.web,t.topic=i.topic||t.topic||a.shell.opts.topic,t.file=i.file,t.classList=i.attr("class").split(/\s*,\s*/).filter((function(e){return!l.test(e)}))):s.match(/^(\s*)%IMAGE\{(.*?)\}%(\s*)$/)&&(t.prefix=RegExp.$1,t.suffix=RegExp.$3,(r=new foswiki.Attrs(RegExp.$2)).keys().filter((e=>"_"!==e[0])).forEach((function(e){t[e]=r.get(e)})),t.file=r.get("_default"),t.classList=r.remove("class")),o=foswiki.normalizeWebTopicName(t.web,t.topic),t.web=o[0],t.topic=o[1],void 0===t.width&&void 0===t.height&&t.size&&(/^(\d+)x(\d+)/.test(t.size)?(t.width=RegExp.$1,t.height=RegExp.$2):t.width=t.size),t},BaseEngine.prototype.searchReplace=function(){throw"not implemented: searchReplace()"}}(jQuery);
