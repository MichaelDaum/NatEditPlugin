"use strict";!function(t){function e(i,o){var n=this,r=foswiki.getPreference("WIKINAME"),a=foswiki.getPreference("SERVERTIME"),s=foswiki.getScriptUrlPath("view",foswiki.getPreference("USERSWEB"),foswiki.getPreference("WIKINAME")),l=foswiki.getPreference("PUBURLPATH");n.shell=i,n.id="TinyMCEEngine",n.type="wysiwyg",n.opts=t.extend({},e.defaults,n.shell.opts.tinymce,o),n.opts.tinymce.selector="#"+n.shell.id+" textarea",n.opts.natedit.signatureMarkup=["-- ",`<a href="${s}">${r}</a>`,` - ${a}`],n.opts.natedit.clearMarkup=["",`<img src="${l}/System/NatEditPlugin/images/clear-float.svg" class="WYSIWYG_CLEAR" data-mce-resize="false" data-mce-placeholder="1" />`,""],n.opts.tinymce.content_css=foswiki.getPreference("NatEditPlugin").ContentCSS,n.opts.tinymce.document_base_url=foswiki.getPreference("URLHOST"),n.opts.tinymce.urlconverter_callback=function(t,e,i){return n.convertURI(t,e,i)},t.extend(n.shell.opts,n.opts.natedit)}e.prototype=Object.create(BaseEngine.prototype),e.prototype.constructor=e,e.prototype.parent=BaseEngine.prototype,e.prototype.init=function(){var e=this,i=foswiki.getPreference("PUBURLPATH")+"/System/NatEditPlugin/lib/tinymce",o=t.Deferred();return e.isInited?(e.shell.log("... engine already inited"),o.resolve()):(e.isInited=!0,t.when(e.parent.init(),e.shell.getScript(i+"/tinymce.min.js")).done((function(){tinymce.PluginManager.add("natedit-image",(function(t){t.ui.registry.addMenuItem("image",{icon:"image",text:"Image ...",onAction:function(t){e.shell.imageDialog()}}),t.addCommand("mceImage",(function(){e.shell.imageDialog()})),t.ui.registry.addContextMenu("image",{update:function(t){return"IMG"===t.nodeName?"image":""}})})),tinymce.PluginManager.add("natedit-link",(function(t){t.ui.registry.addMenuItem("link",{icon:"link",text:"Link ...",onAction:function(t){var i=e.editor.selection.getNode();e.shell.linkDialog({selection:i.textContent,url:i.getAttribute("href"),type:"external"})}}),t.addCommand("mceLink",(function(){e.shell.linkDialog(e.getSelection())})),t.ui.registry.addContextMenu("image",{update:function(t){return"A"===t.nodeName?"link":""}})})),e.opts.tinymce.init_instance_callback=function(i){var n=parseInt(e.shell.txtarea.attr("cols"),10)||1e4,r=parseInt(e.shell.txtarea.attr("rows"),10),a=parseInt(e.shell.txtarea.css("line-height"),10);e.shell.log("initing instance"),e.editor=i,void 0!==n&&n>0&&e.setSize(`min(${n}ch,100%)`),void 0!==r&&r>0&&(r*=a,e.setSize(null,r)),e.opts.debug&&(window.editor=i),e.updateContent().then((function(){o.resolve()}),(function(){o.reject()})),window.darkMode&&window.darkMode.isActive&&t(e.editor.contentAreaContainer).children("iframe").contents().find("html:first").attr("data-theme","dark")},tinymce.init(e.opts.tinymce)})).fail((function(){o.reject(),alert("failed to load tinymce.js")})),o.promise())},e.prototype.convertURI=function(t,e,i){return t.replace(/%[A-Za-z0-9_]+%/g,(function(t){var e=foswiki.getPreference(t);return e&&""!==e?e:t}))},e.prototype.beforeSubmit=function(e){var i=this,o=t.Deferred();return"cancel"!==e&&i.shell.txtarea.val(i.getValue()),i.shell.setTextFormat("html"),o.resolve().promise()},e.prototype.updateContent=function(){var t=this.shell.txtarea.val();return this.setContent(t)},e.prototype.setContent=function(e){var i=this,o=t.Deferred();return""===e?(i.editor.setContent(""),i.editor.undoManager.clear(),t(window).trigger("resize"),o.resolve(i)):i.shell.tml2html(e).then((function(e){i.editor.setContent(e),i.editor.undoManager.clear(),t(window).trigger("resize"),o.resolve(i)}),(function(){o.reject(),i.shell.formManager.showMessage("error","Error calling tml2html")})),o.promise()},e.prototype.getContent=function(){return this.shell.html2tml(this.getValue())},e.prototype.initGui=function(){var e=this;e.parent.initGui.call(e),e.shell.container.addClass("ui-natedit-wysiwyg-enabled"),t.each(e.opts.tinymce.formats,(function(i){e.editor.formatter.formatChanged(i,(function(o,n){t.each(e.editor.formatter.get(i),(function(t,i){o?e.shell.toolbar.find(i.toolbar).addClass("ui-natedit-active"):e.shell.toolbar.find(i.toolbar).removeClass("ui-natedit-active")})),e.shell.toolbar.find(".ui-natedit-numbered").removeClass("ui-natedit-active"),e.shell.toolbar.find(".ui-natedit-bullet").removeClass("ui-natedit-active"),t.each(n.parents,(function(i,o){var r=t(o),a=t(n.parents[i+1]);r.is("li")&&(a.is("ol")?e.shell.toolbar.find(".ui-natedit-numbered").addClass("ui-natedit-active"):e.shell.toolbar.find(".ui-natedit-bullet").addClass("ui-natedit-active"))}))}))})),e.editor.on("change",(function(){e.updateUndoButtons()})),e.updateUndoButtons()},e.prototype.updateUndoButtons=function(){var t=this,e=t.shell.container.find(".ui-natedit-undo"),i=t.shell.container.find(".ui-natedit-redo"),o=t.editor.undoManager;o.hasUndo()?e.button("enable"):e.button("disable"),o.hasRedo()?i.button("enable"):i.button("disable")},e.prototype.on=function(t,e){return this.editor.on(t,e),this.editor},e.prototype.handleToolbarAction=function(e){var i=this,o=t.extend({},e.data()),n=o.markup;if(void 0!==n){if("numberedListMarkup"===n)return i.shell.toolbar.find(".ui-natedit-numbered").addClass("ui-natedit-active"),i.shell.toolbar.find(".ui-natedit-bullet").removeClass("ui-natedit-active"),void i.editor.execCommand("InsertOrderedList");if("bulletListMarkup"===n)return i.shell.toolbar.find(".ui-natedit-numbered").removeClass("ui-natedit-active"),i.shell.toolbar.find(".ui-natedit-bullet").addClass("ui-natedit-active"),void i.editor.execCommand("InsertUnorderedList");i.editor.formatter.get(n)&&(delete o.markup,i.editor.formatter.toggle(n))}return o},e.prototype.insert=function(t){this.editor.insertContent(t)},e.prototype.getImageData=function(e){var i,o=this.editor.selection.getNode(),n=new RegExp("image(Simple|Float|Thumb|Frame|Plain)(_left|_right|_none|_center)?");return e=t.extend({},{web:foswiki.getPreference("WEB"),topic:foswiki.getPreference("TOPIC")},e)||{},o&&"IMG"===o.nodeName&&(i=this.shell.parseUrl(o.src),e.width=o.width||e.width,e.height=o.height||e.height,e.align=o.align||e.align,e.type=o.dataset.type,e.caption=o.dataset.caption,e.web=i.web||e.web,e.topic=i.topic||e.topic,e.file=i.file||e.file,e.classList=Array.from(o.classList).filter((function(t){return!n.test(t)})),e.id=o.id,e.align=o.align,e.type=o.dataset.type,e.caption=o.dataset.caption||""),e},e.prototype.insertImage=function(e){var i,o,n=this;o=foswiki.getPubUrlPath(e.web,e.topic,e.file),i=t("<img />").attr({src:o,"data-mce-src":o}),e.width&&i.attr("width",e.width),e.height&&i.attr("height",e.height),e.align&&(i.attr("align",e.align),e.classList=(e.classList||"")+" imageSimple_"+e.align),e.classList&&i.attr("class",e.classList),e.id&&i.attr("id",e.id),e.caption&&i.attr("data-caption",e.caption),e.type&&i.attr("data-type",e.type),e.prefix=void 0===e.prefix?"":e.prefix,e.suffix=void 0===e.suffix?"":e.suffix,i=e.prefix+i.get(0).outerHTML+e.suffix,n.editor.selection.isCollapsed()||n.editor.selection.getNode().remove(),n.insert(i)},e.prototype.remove=function(){return this.editor.selection.setContent("")},e.prototype.getSelection=function(){return this.editor.selection.getContent()},e.prototype.getSelectionLines=function(){for(var e=this,i=e.editor.selection.getRng(),o=i.startOffset,n=i.endOffset,r=e.editor.selection.getNode(),a=t(r).text();o>0&&13!==a.charCodeAt(o-1)&&10!==a.charCodeAt(o-1);)o--;for(;n<a.length&&13!==a.charCodeAt(n)&&10!==a.charCodeAt(n);)n++;return n>=a.length&&(n=a.length-1),i.setStart(r,o),e.editor.selection.setRng(i),a},e.prototype.setCaretPosition=function(t){return this.editor.selection.setCursorLocation(void 0,t)},e.prototype.getCaretPosition=function(){return this.editor.selection.getEnd()},e.prototype.hasChanged=function(){return this.editor.isDirty()},e.prototype.undo=function(){this.editor.undoManager.undo(),this.updateUndoButtons()},e.prototype.redo=function(){this.editor.undoManager.redo(),this.updateUndoButtons()},e.prototype.insertLineTag=function(t){var e=this,i=t[0],o=e.getSelectionLines()||t[1],n=t[2];e.shell.log("selection=",o),e.editor.selection.setContent(i+o+n)},e.prototype.insertTag=function(t){var e=t[0],i=this.getSelection()||t[1],o=t[2];this.editor.selection.setContent(e+i+o)},e.prototype.removeFormat=function(){this.editor.execCommand("RemoveFormat")},e.prototype.applyColor=function(t){this.editor.execCommand("mceApplyTextcolor","forecolor",t)},e.prototype.insertTable=function(t){t.init=new foswiki.Table(this.getSelection()),this.insert(foswiki.Table.create(t).toHtml())},e.prototype.insertLink=function(t){var e,i,o=this,n=foswiki.getPreference("WEB");if(o.shell.log("called insertLink",t),void 0!==t.url){if(""===t.url)return;e=void 0!==t.text&&""!==t.text?"<a href='"+t.url+"'>"+t.text+"</a>":"<a href='"+t.url+"'>"+t.url+"</a>"}else if(void 0!==t.file){if(void 0===t.web||""===t.web||void 0===t.topic||""===t.topic)return;e="<a href='"+(i="%PUBURLPATH%/"+t.web+"/"+t.topic+"/"+t.file)+"'>",void 0!==t.text&&""!==t.text?e+=t.text:e+=t.file,e+="</a>"}else{if(void 0===t.topic||""===t.topic)return;i=void 0!==t.web&&t.web!==n?t.web+".":"",e="<a href='"+(i+=t.topic)+"'>",void 0!==t.text&&""!==t.text?e+=t.text:e+=t.topic,e+="</a>"}o.editor.selection.getContent();if(o.editor.selection.isCollapsed()){var r=o.editor.selection.getRng();r.expand("word"),o.editor.selection.setRng(r)}o.remove(),o.insert(e)},e.prototype.setValue=function(t){this.editor.setContent(t)},e.prototype.getValue=function(){return this.editor.getContent()},e.prototype.searchReplace=function(t,e,i){throw")"},e.prototype.getWrapperElement=function(){return this.editor?t(this.editor.getContainer()):null},e.prototype.focus=function(){this.editor.focus()},e.prototype.setSize=function(e,i){var o=t(this.editor.getContainer());o&&(e&&o.css("width",e),i&&o.css("height",i))},e.prototype.toggleFullscreen=function(){this.editor.execCommand("mceFullScreen")},e.defaults={debug:!0,natedit:{purifyInput:!1},tinymce:{deprecation_warnings:!1,selector:"textarea#topic",min_height:300,menubar:!1,toolbar:!1,statusbar:!1,relative_urls:!1,remove_script_host:!1,convert_urls:!0,submit_patch:!1,plugins:"autolink fullscreen hr legacyoutput lists -natedit-image -natedit-link paste searchreplace table textpattern",table_toolbar:"",table_appearance_options:!1,table_advtab:!1,table_cell_advtab:!1,table_row_advtab:!1,object_resizing:"img",paste_data_images:!0,keep_styles:!1,image_title:!0,image_class_list:[{title:"Left",value:""},{title:"Right",value:"foswikiRight"},{title:"Center",value:"foswikiCenter"}],content_css:[],style_formats_autohide:!0,removeformat:[{selector:"div,p,pre",remove:"all"}],formats:{h1Markup:{block:"h1",toolbar:".ui-natedit-h1"},h2Markup:{block:"h2",toolbar:".ui-natedit-h2"},h3Markup:{block:"h3",toolbar:".ui-natedit-h3"},h4Markup:{block:"h4",toolbar:".ui-natedit-h4"},h5Markup:{block:"h5",toolbar:".ui-natedit-h5"},h6Markup:{block:"h6",toolbar:".ui-natedit-h6"},normalMarkup:{block:"p",toolbar:".ui-natedit-normal"},quoteMarkup:{block:"blockquote",toolbar:".ui-natedit-quoted"},boldMarkup:{inline:"b",toolbar:".ui-natedit-bold"},italicMarkup:{inline:"i",toolbar:".ui-natedit-italic"},monoMarkup:{inline:"code",toolbar:".ui-natedit-mono"},underlineMarkup:{inline:"span",styles:{"text-decoration":"underline"},toolbar:".ui-natedit-underline"},strikeMarkup:{inline:"span",styles:{"text-decoration":"line-through"},toolbar:".ui-natedit-strike"},superscriptMarkup:{inline:"sup",toolbar:".ui-natedit-super"},subscriptMarkup:{inline:"sub",toolbar:".ui-natedit-sub"},leftMarkup:{block:"p",attributes:{align:"left"},toolbar:".ui-natedit-left"},rightMarkup:{block:"p",attributes:{align:"right"},toolbar:".ui-natedit-right"},centerMarkup:{block:"p",attributes:{align:"center"},toolbar:".ui-natedit-center"},justifyMarkup:{block:"p",attributes:{align:"justify"},toolbar:".ui-natedit-justify"},verbatimMarkup:{block:"pre",classes:"TMLverbatim",toolbar:".ui-natedit-verbatim"}},textpattern_patterns:[{start:"==",end:"==",format:["boldMarkup","monoMarkup"]},{start:"_",end:"_",format:"italicMarkup"},{start:"__",end:"__",format:["italicMarkup","boldMarkup"]},{start:"=",end:"=",format:"monoMarkup"},{start:"*",end:"*",format:"boldMarkup"},{start:"---",replacement:"<hr />"},{start:"---+ ",format:"h1Markup"},{start:"---++ ",format:"h2Markup"},{start:"---+++ ",format:"h3Markup"},{start:"---++++ ",format:"h4Markup"},{start:"---+++++ ",format:"h5Markup"},{start:"---++++++ ",format:"h6Markup"},{start:"1 ",cmd:"InsertOrderedList"},{start:"* ",cmd:"InsertUnorderedList"}]}},t.NatEditor.factory.TinyMCEEngine={createEngine:function(t){return new e(t)}}}(jQuery);
